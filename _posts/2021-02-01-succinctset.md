---
title:      "100è¡Œä»£ç çš„å‹ç¼©å‰ç¼€æ ‘: 50% smaller"
authors:
    - xp
categories:
    - algo
tags:
    - memory
    - succinct
    - trie
    - bitmap

refs:
    - "report": https://github.com/openacid/succinct/blob/v0.1.0/report/main.go "report"
    - "å‰ç¼€æ ‘": https://en.wikipedia.org/wiki/Trie "trie"
    - "trie": https://en.wikipedia.org/wiki/Trie "trie"
    - "succinct": https://en.wikipedia.org/wiki/Succinct_data_structure

    - "cpp-popcount":  https://en.cppreference.com/w/cpp/numeric/popcount "popcount"

    - "post-zipf": https://blog.openacid.com/tech/zipf/ "zipf"

    - "repo-slim": https://github.com/openacid/slim "slim"
    - "succinct.Set": https://github.com/openacid/succinct/tree/loc100 "succinct.Set"

    - "google-btree": https://github.com/google/btree "btree"

platform_refs:
    wechat:
    zhihu:
        - "post-zipf": https://zhuanlan.zhihu.com/p/94525243 zipf

article:
    image: /post-res/succinctset/succinctset-wechat-banner-small.jpg

pdf: false

mathjax: false
toc: true
toc_label: æœ¬æ–‡ç›®å½•
toc_sticky: true
excerpt: "å‹ç¼©å‰ç¼€æ ‘, å‡å°‘50%å­˜å‚¨ç©ºé—´, æ”¯æŒåˆ›å»ºå’ŒæŸ¥è¯¢, åªéœ€100è¡Œä»£ç "
---

è¿™æ–‡ä»‹ç»ä¸€ä¸ªå‹ç¼©å‰ç¼€æ ‘å®ç°çš„sorted set(github: [succinct.Set][]), åŒºåŒº95è¡Œä»£ç , åŒ…å«äº†ä¸€ç»„å®Œæ•´çš„åŠŸèƒ½:

- ç”¨ [å‰ç¼€æ ‘][] å­˜å‚¨ä¸€ä¸ªæ’åºæ•°ç»„, å»æ‰æŒ‡é’ˆ, å‹ç¼©æ‰50%çš„ç©ºé—´;
  ä¾‹å¦‚åœ¨æœ¬æ–‡çš„ä¾‹å­ä¸­, å­˜å‚¨2.4MBçš„200ä¸‡ä¸ªå•è¯, åªéœ€è¦1.2MB.

- åˆ›å»º: ä»keyåˆ—è¡¨åˆ›å»ºä¸€ä¸ªå‹ç¼©çš„å‰ç¼€æ ‘;

- æŸ¥è¯¢: æ”¯æŒHas() æ“ä½œæ¥æŸ¥è¯¢1ä¸ªkeyæ˜¯å¦å­˜åœ¨;

- ä¼˜åŒ–: é€šè¿‡ç´¢å¼•æ¥åŠ é€Ÿ bitmap çš„æ“ä½œ, å°†è¾ƒå¤§çš„ bitmap æ“ä½œä¼˜åŒ–åˆ°O(1)çš„æ—¶é—´å¼€é”€.

`loc100` åˆ†æ”¯æ˜¯æœ¬æ–‡ä¸­ä½¿ç”¨çš„æœ€ç®€å®ç°, æ²¡æœ‰ä»»ä½•å¤–éƒ¨ä¾èµ–,
mainåˆ†æ”¯ä¸­çš„å®ç°é¢å‘ç”Ÿäº§ç¯å¢ƒ, è¦å¿«4å€å·¦å³.

**å¦‚æœè¦ç”Ÿäº§ç¯å¢ƒä½¿ç”¨, ç§»æ­¥ [slim][repo-slim]**.


ç”¨20ä¸‡ä¸ªç½‘ä¸Šè¯æ±‡æ¥æµ‹è¯•æœ¬æ–‡å®ç°çš„succinctSet:

- succinctSet ç©ºé—´å¼€é”€æ˜¯æºæ•°æ®çš„ **57%**.
- `Has()` å¼€é”€ä¸º `350 ns`.

åŸå§‹æ•°æ®å¤§å°: 2204 KB

è·Ÿ string æ•°ç»„çš„ bsearch, ä»¥åŠ [google-btree][] çš„å¯¹æ¯”:

| Data         | Engine       | Size(KB) | Size/original | ns/op |
| :--          | :--          | --:      | --:           | --:   |
| 200kweb2     | bsearch      |  5890    |  267%         | 229   |
| 200kweb2     | succinct.Set |  1258    |   57%         | 356   |
| 200kweb2     | btree        | 12191    |  553%         | 483   |

# åœºæ™¯å’Œé—®é¢˜

è®¡ç®—æœºä¸­çš„ä¿¡æ¯, ä¸ºäº†æŸ¥è¯¢æ–¹ä¾¿, å‡ ä¹éƒ½æ˜¯æ’åºå­˜å‚¨çš„(å³ä½¿æ˜¯hashç»“æ„, hash map ä¸­çš„ hash å€¼ä¹Ÿæ˜¯é¡ºåºå­˜å‚¨çš„).

æ•°æ®å­˜å‚¨é¢†åŸŸ, å¤§éƒ¨åˆ†æ•°æ®ä¹Ÿéƒ½æ˜¯é™æ€çš„, ä¾‹å¦‚æ•°æ®åº“åº•å±‚çš„ä¸€ä¸ªpage,
rocksdbçš„ä¸€ä¸ªsstable.
æ•°æ®è¶Šæ¥è¶Šå¤§åå¯¹å­˜å‚¨ç©ºé—´çš„å¼€é”€ä¹Ÿè¶Šæ¥è¶Šæ•æ„Ÿ, æ¯•ç«Ÿå½±å“æ€§èƒ½çš„ä¸»è¦ç“¶é¢ˆéƒ½åœ¨IOä¸Š,
ä¸è®ºæ˜¯CPUå¯¹ä¸»å­˜çš„è®¿é—®å»¶è¿Ÿ, è¿˜æ˜¯å†…å­˜åˆ°ç£ç›˜çš„å»¶è¿Ÿ, æ¯2å±‚ä¹‹é—´çš„IOå»¶è¿Ÿ,
åŸºæœ¬éƒ½åœ¨1~2ä¸ªé‡çº§å·¦å³.
äºæ˜¯æ›´å°çš„å­˜å‚¨å¼€é”€, ä¸ä»…èŠ‚çœå­˜å‚¨æˆæœ¬, å¦ä¸€ä¸ªbonusæ˜¯å‡ ä¹æ¯«æ— ç–‘é—®çš„ä¼šæå‡æ€§èƒ½,

æœ¬æ–‡é’ˆå¯¹è¿™ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„åœºæ™¯: é™æ€æ’åºæ•°æ®,
æä¾›ä¸€ä¸ªé€šç”¨çš„å®ç°æ–¹æ³•æ¥å‹ç¼©ç©ºé—´å¼€é”€.

> ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„ç®—æ³•, å’Œæœ¬æ–‡ä»‹ç»çš„æ–¹æ³•åŒæº, ä½†åŒ…æ‹¬æ›´å¤šçš„ä¼˜åŒ–,
> ä¾‹å¦‚é€šè¿‡SIMDæŒ‡ä»¤ä¸€æ¬¡å¤„ç†å¤šä¸ªå­—èŠ‚çš„æ¯”è¾ƒ, ç”¨bitmapæ¥ä¼˜åŒ–labelsçš„å­˜å‚¨,
> å¯¹åªæœ‰ä¸€ä¸ªå‡ºå‘labelçš„èŠ‚ç‚¹çš„åˆå¹¶ä¼˜åŒ–ç­‰.


# æ€è·¯: å‰ç¼€æ ‘

[å‰ç¼€æ ‘][], æˆ–å­—å…¸æ ‘, prefix tree,  trie, æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„ä¸€ä¸ªå…¸å‹æ€è·¯.
ä¾‹å¦‚è¦å­˜å‚¨5ä¸ªkey: [ab, abc, abcd, axy, buv]
å¯ä»¥å»ºç«‹ä¸‹é¢è¿™æ ·ä¸€ä¸ªå‰ç¼€æ ‘, çœå»å¤§é‡é‡å¤çš„å‰ç¼€,
å…¶ä¸­`^` æ˜¯rootèŠ‚ç‚¹(ä¹Ÿè®°åš0), 1, 2, 3...æ˜¯trieèŠ‚ç‚¹, `$`æ ‡è®°ä¸€ä¸ªå¶å­èŠ‚ç‚¹,
 å­—æ¯`a,
b...` è¡¨ç¤ºä¸€ä¸ªèŠ‚ç‚¹åˆ°ä¸‹çº§èŠ‚ç‚¹çš„è¾¹(labeled branch):

```
^ -a-> 1 -b-> 3 $
  |      |      `c-> 6 $
  |      |             `d-> 9 $
  |      `x-> 4 -y-> 7 $
  `b-> 2 -u-> 5 -v-> 8 $
```

ä½†æ˜¯! åœ¨ trie çš„å®ç°ä¸­, å°±åƒä¸€èˆ¬çš„æ ‘å½¢ç»“æ„å®ç°ä¸€æ ·, éœ€è¦å¤§é‡çš„æŒ‡é’ˆ,
æ¯ä¸ª label åˆ°å…¶æŒ‡å‘çš„èŠ‚ç‚¹éœ€è¦å ç”¨ä¸€ä¸ªæŒ‡é’ˆ.
åœ¨64ä½ç³»ç»Ÿä¸­ä¸€ä¸ªæŒ‡é’ˆå°±è¦å 8å­—èŠ‚,
æ•´ä¸ª trie ä¸­æŒ‡é’ˆæ•°é‡è‡³å°‘ä¹Ÿæ˜¯å¶å­èŠ‚ç‚¹çš„æ•°é‡.

å¦‚æœè¦å­˜å‚¨çš„å­—ç¬¦ä¸²é•¿åº¦æ¯”è¾ƒçŸ­, å¾ˆå¯èƒ½ç¼–ç æˆ trie ä¹‹å, å› ä¸ºæŒ‡é’ˆå¼€é”€,
è¦å ç”¨æ›´å¤§ç©ºé—´.
å³ä½¿æ˜¯å­˜å‚¨è¾ƒé•¿çš„å­—ç¬¦ä¸², å¤§éƒ¨åˆ†åœºåˆæŒ‡é’ˆçš„å¼€é”€ä¹Ÿæ— æ³•å¿½ç•¥ä¸è®¡.

äºæ˜¯å¯¹äºè¿™ç±»keyé›†åˆç¡®å®šçš„åœºæ™¯(ä¾‹å¦‚rocksdbä¸­çš„sstable, å°±æ˜¯å…¸å‹çš„é™æ€æ’åºkeyçš„å­˜å‚¨),
ä½¿ç”¨å‹ç¼©çš„å‰ç¼€æ ‘æ˜¯ä¸€ç§æ›´ç®€æ´æœ‰æ•ˆçš„æ–¹å¼æ¥å»æ‰æŒ‡é’ˆå¼€é”€.


# å‰ç¼€æ ‘çš„å‹ç¼©ç®—æ³•

åœ¨è¿™ä¸ªå‰ç¼€æ ‘ä¸­, æ¯ä¸ªèŠ‚ç‚¹è‡³å¤šæœ‰256ä¸ªå‡ºå‘label, æŒ‡å‘ä¸‹ä¸€çº§èŠ‚ç‚¹.
ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ˜¯innerèŠ‚ç‚¹, ä¾‹å¦‚rootèŠ‚ç‚¹`^`, æˆ–`1, 2, 3`.
ä¹Ÿå¯ä»¥æ˜¯å¶å­èŠ‚ç‚¹, ä¾‹å¦‚`3, 6, 9`. è¿™é‡Œ3æ—¢æ˜¯ä¸€ä¸ªinnerèŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªleafèŠ‚ç‚¹.

```
^ -a-> 1 -b-> 3 $
  |      |      `c-> 6 $
  |      |             `d-> 9 $
  |      `x-> 4 -y-> 7 $
  `b-> 2 -u-> 5 -v-> 8 $
```

è¦å‹ç¼©è¿™ä¸ª trie, å¯¹æ¯ä¸ª trie èŠ‚ç‚¹, æˆ‘ä»¬éœ€è¦çš„æœ€æ ¸å¿ƒçš„ä¿¡æ¯æ˜¯:
- ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ†æ”¯(label)éƒ½æœ‰å“ªäº›,
- ä»¥åŠlabelæŒ‡å‘çš„èŠ‚ç‚¹çš„ä½ç½®.

æˆ‘ä»¬æœ‰ä»¥ä¸‹è¿™ç§ç´§å‡‘çš„ç»“æ„æ¥æè¿°è¿™ä¸ª trie:

ä¸€ä¸ª trie èŠ‚ç‚¹çš„å‡ºå‘ label éƒ½å­˜å‚¨åœ¨ä¸€ä¸ª[]byteä¸­,
å†ç”¨ä¸€ä¸ª bitmap æ¥æè¿°æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†æ”¯, åé¢é€šè¿‡è¿™ä¸ª bitmap æ¥å®šä½ label å¯¹åº”çš„èŠ‚ç‚¹.

å…ˆæŠŠæ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„ label åˆ—å‡ºæ¥, å¹¶ä¸ºæ¯ä¸ª label åˆ†é…ä¸€ä¸ªbit `0` æ¥æ ‡è®°:

```
^: {a, b} 00
1: {b, x} 00
2: {u}    0
3: {c}    0
4: {y}    0
5: {v}    0
6: {d}    0
7: Ã¸
8: Ã¸
9: Ã¸
```

ç„¶åå°†æ‰€æœ‰çš„labelä¿å­˜åœ¨ä¸€ä¸ª[]byteä¸­,
å†å°†å¯¹åº”çš„æ ‡è®°labelçš„å¤šä¸ª`0...`ç”¨`1`åšåˆ†éš”ç¬¦è¿æ¥åˆ°ä¸€èµ·:
è¿™2å—ä¿¡æ¯æ˜¯ succinctSet æ ¸å¿ƒçš„2ä¸ªå­—æ®µ, æœ‰äº†è¿™2éƒ¨åˆ†æ•°æ®å°±å¯ä»¥å®ç°(ä¸ç®—é«˜æ•ˆçš„)keyæŸ¥æ‰¾:

```
labels(ignore space):  ab bx u c y v d Ã¸Ã¸Ã¸
label bitmap:          0010010101010101111
node-id:               0  1  2 3 4 5 6 789  // node-id ä¸éœ€è¦å­˜å‚¨
```

## å‹ç¼©åçš„æŸ¥è¯¢

åœ¨æ ‡å‡†çš„ trie ä¸­æŸ¥æ‰¾ä¸€ä¸ª key å¾ˆç®€å•, åœ¨ç¬¬Lå±‚çš„ä¸€ä¸ªèŠ‚ç‚¹ä¸Š,
æŸ¥æ‰¾key[L]çš„byteæ˜¯å¦æ˜¯ trie èŠ‚ç‚¹çš„ä¸€ä¸ªå‡ºå‘ label,
å¦‚æœæ˜¯, èµ°åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, å¦åˆ™ç»ˆæ­¢.

ä¾‹å¦‚å¯¹`axy`çš„æŸ¥æ‰¾, è¦ç»å†3æ¬¡æŸ¥æ‰¾,
`^ -a-> â‘  -x-> â‘£ -y-> â‘¦ $`:

```
^ -a-> â‘  -b-> 3 $
  |      |      `c-> 6 $
  |      |             `d-> 9 $
  |      `x-> â‘£ -y-> â‘¦ $
  `b-> 2 -u-> 5 -v-> 8 $
```

åœ¨ succinctSet ä¸­çš„æŸ¥æ‰¾ä¹Ÿæ˜¯ä¸€æ ·,
å”¯ä¸€ä¸åŒçš„æ˜¯å¦‚ä½•åœ¨è¿™ä¸ªæ²¡æœ‰æŒ‡é’ˆçš„ç»“æ„ä¸­æ‰¾åˆ°æŸä¸ªå‡ºå‘ label å¯¹åº”çš„å­èŠ‚ç‚¹.

æˆ‘ä»¬æŠŠ trie åŸæ¥çš„ label åˆ°å­èŠ‚ç‚¹çš„å…³ç³», åœ¨å‹ç¼©åçš„ç»“æ„ä¸­ç”»å‡ºæ¥, ç«¯è¯¦ç«¯è¯¦:

```
|                                .-----.
|                        .--.    | .---|-.
|                        |.-|--. | | .-|-|.
|                        || â†“  â†“ | | | â†“ â†“â†“
| labels(ignore space):  ab bx u c y v d Ã¸Ã¸Ã¸
| label bitmap:          0010010101010101111
| node-id:               0  1  2 3 4 5 6 789
|                           || | â†‘ â†‘ â†‘ |   â†‘
|                           || `-|-|-' `---'
|                           |`---|-'
|                           `----'
```

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º,

-   é™¤äº†æ ¹èŠ‚ç‚¹`^`, æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª`0`ä¸ä¹‹å¯¹åº”(èŠ‚ç‚¹å…¥å‘ label å¯¹åº”ä½ç½®çš„0).
    å›¾ä¸­ä¸Šä¸‹ç®­å¤´, æ˜¯ label åˆ°èŠ‚ç‚¹çš„å…³ç³», ä¹Ÿå°±æ˜¯æ¯ä¸ª`0`è·Ÿå®ƒæŒ‡å‘çš„å­èŠ‚ç‚¹çš„å¯¹åº”å…³ç³».

-   æ¯ä¸ªèŠ‚ç‚¹ä¹Ÿéƒ½æœ‰ä¸€ä¸ª`1`ä¸ä¹‹ä¸€ä¸€å¯¹åº”, ä¹Ÿå°±æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªç»“æŸæ ‡è®°`1`.

ä¾‹å¦‚:

-   bitmap ä¸­
    ç¬¬0ä¸ª`0`å¯¹åº”èŠ‚ç‚¹`1:bx`,
    ç¬¬1ä¸ª`0`å¯¹åº”èŠ‚ç‚¹`2:u`...

-   åŒç†èŠ‚ç‚¹ä¸`1`çš„å…³ç³»ä¹Ÿç±»ä¼¼,
    ç¬¬0ä¸ª`1`å¯¹åº”rootèŠ‚ç‚¹`^`, `0:ab`,
    ç¬¬1ä¸ª`1`å¯¹åº”èŠ‚ç‚¹`1:bx`,
    ç¬¬2ä¸ª`1`å¯¹åº”èŠ‚ç‚¹`2:u`...


ä½ å“, ä½ ç»†å“...

å“å®Œåå‘ç°, **è¦æ‰¾åˆ°æŸä¸ª label æŒ‡å‘çš„èŠ‚ç‚¹, åªéœ€è¦å…ˆæ•°æ•°è¿™ä¸ª label å¯¹åº”ç¬¬å‡ ä¸ª`0`, ä¾‹å¦‚æ˜¯ç¬¬iä¸ª`0`,
å†æ‰¾åˆ°bitmapä¸­çš„ç¬¬iä¸ª`1`, ç¬¬iä¸ª`1`åé¢å°±æ˜¯ label å¯¹åº”çš„èŠ‚ç‚¹ä½ç½®äº†**.

è¿™å°±æ˜¯åœ¨å‹ç¼©å‰ç¼€æ ‘ä¸­é€å±‚å®šä½èŠ‚ç‚¹çš„ç®—æ³•.

ä¸¾ä¸ªæ —å­ ğŸŒ°

å‡è®¾ä»æ ¹èŠ‚ç‚¹å¼€å§‹, è¦æŸ¥æ‰¾çš„keyæ˜¯axy,

- é¦–å…ˆåœ¨æ ¹èŠ‚ç‚¹ `0:ab` ä¸­æ‰¾åˆ°label `a`,
- label `a` å¯¹åº”ç¬¬0ä¸ª`0`, ç„¶åæ‰¾åˆ°ç¬¬0ä¸ª`1`çš„ä½ç½®, ä¹Ÿå°±æ˜¯`1:bx`èŠ‚ç‚¹.
- å†åœ¨`1:bx` èŠ‚ç‚¹çš„ label ä¸­æ‰¾åˆ° label `x`, å¯¹åº”ç¬¬3ä¸ª`0`, å†æ‰¾åˆ°ç¬¬3ä¸ª`1`çš„ä½ç½®, ä¹Ÿå°±æ˜¯`4:y` çš„èŠ‚ç‚¹.
- åœ¨`4:y`ä¸­æ‰¾åˆ° label `y`, å¯¹åº”ç¬¬7ä¸ª`0`, å†æ‰¾åˆ°ç¬¬7ä¸ª`1`, ä¹Ÿå°±æ˜¯`7:Ã¸`çš„èŠ‚ç‚¹.
- èŠ‚ç‚¹7æ²¡æœ‰ä»»ä½• label, ç»“æŸ.

åœ¨ succinctSet æ•°æ®ç»“æ„ä¸­ç”»å‡º axy çš„æŸ¥è¯¢è¿‡ç¨‹å¦‚ä¸‹:

```
|                         a         y
|                        .--.      .-----.
|                        |  â†“      |     â†“
| labels(ignore space):  ab bx u c y v d Ã¸Ã¸Ã¸
| label bitmap:          0010010101010101111
| node-id:               0  1  2 3 4 5 6 789
|                            |     â†‘
|                            `-----'
|                             x
```

## ç»´æŠ¤ leaf èŠ‚ç‚¹

ä¸Šé¢ä»‹ç»çš„æŸ¥è¯¢ç®—æ³•è¿˜æœ‰ä¸€ä¸ªé—®é¢˜, å°±æ˜¯å½“æŸäº›keyæ˜¯å…¶ä»–keyçš„å‰ç¼€æ—¶,
å®ƒå¯¹åº”çš„èŠ‚ç‚¹æ—¢æ˜¯innerèŠ‚ç‚¹, ä¹Ÿæ˜¯leafèŠ‚ç‚¹, è¿™æ—¶æ— æ³•é€šè¿‡ label çš„ä¸åŒ¹é…ç»“æŸæŸ¥è¯¢.
ä¾‹å¦‚ abc å¯¹åº”çš„èŠ‚ç‚¹ `6:d`, å®ƒæœ¬èº«æœ‰ä¸€ä¸ªå‡ºå‘åˆ†æ”¯`d`, æ˜¯ä¸€ä¸ªinnerèŠ‚ç‚¹, åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªleafèŠ‚ç‚¹.

```
^ -a-> 1 -b-> 3 $
  |      |      `c-> â‘¥ $
  |      |             `d-> 9 $
  |      `x-> 4 -y-> â‘¦ $
  `b-> 2 -u-> 5 -v-> 8 $
```

æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦é¢å¤–çš„ä¿¡æ¯æ¥æ ‡è¯†æ‰€æœ‰çš„ leaf èŠ‚ç‚¹:
å†å»ºç«‹ä¸€ä¸ª **leaves** çš„ bitmap, å®ƒçš„ç¬¬`i`ä¸ªbitä¸º`1`, è¡¨ç¤ºnode-idä¸º`i`çš„èŠ‚ç‚¹æ˜¯leafèŠ‚ç‚¹:

```
labels(ignore space):  ab bx u c y v d Ã¸Ã¸Ã¸
label bitmap:          0010010101010101111
leaves(ignore space):  0  0  0 1 0 0 1 111
node-id:               0  1  2 3 4 5 6 789
```

leaves çš„æ£€æŸ¥åœ¨æŸ¥è¯¢çš„æœ€åä¸€æ­¥, å¦‚æœä¸€ä¸ªè¦æŸ¥è¯¢çš„ key åŒ¹é…åˆ°ä¸€ä¸ªtrieä¸­çš„èŠ‚ç‚¹,
æœ€åå†æ£€æŸ¥å®ƒæ˜¯å¦æ˜¯ä¸€ä¸ª leaf èŠ‚ç‚¹.

## ä¼˜åŒ– bitmap æ“ä½œ

è¿™ä¸ªç®—æ³•ä¸­æœ€åè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³:
æˆ‘ä»¬æåˆ°ä» label å®šä½ node çš„è¿‡ç¨‹æ˜¯: æ‰¾åˆ°ä¸€ä¸ª label ä¹‹å‰çš„`0`çš„ä¸ªæ•°i, å†æ‰¾åˆ°ç¬¬iä¸ªçš„`1`çš„ä½ç½®.
è¿™2ä¸ªæ“ä½œéƒ½æ˜¯O(n)çš„, è¦éå† bitmap, æœ€ç»ˆä¼šå¯¼è‡´ä¸€æ¬¡æŸ¥è¯¢çš„æ—¶é—´æ•ˆç‡å˜æˆO(nÂ²).

ä¸ºäº†èƒ½è®©æŸ¥è¯¢æå‡æ•ˆç‡, æˆ‘ä»¬éœ€è¦å»ºç«‹2ä»½é¢å¤–çš„ä¿¡æ¯æ¥ä¼˜åŒ–è¿™2ä¸ªæ“ä½œ.

ç¬¬ä¸€ä¸ªæ˜¯æ‰¾å‡ºä¸€ä¸ª bitmap ä¸­ç¬¬`i`ä¸ªbitä¹‹å‰æœ‰å¤šå°‘ä¸ª`1`(æˆ–å¤šå°‘ä¸ª`0`).
å¯¹å®šé•¿æ•´æ•°, ä¾‹å¦‚ä¸€ä¸ªuint64, å®ƒçš„æœ‰O(1)çš„å®ç°, ä¾‹å¦‚
- åœ¨cppé‡Œå«åš [popcount][cpp-popcount], i.e., count of population of ones;
- åœ¨goé‡Œé¢å®ƒè¢«å°è£…åœ¨`bits.OnesCount64()`è¿™ä¸ªå‡½æ•°, æ•°æ•°ä¸€ä¸ªuint64é‡Œæœ‰å¤šå°‘ä¸ª1;
- ä¸€èˆ¬çš„, å«åšrank1(i), å¦‚æœè¦è®¡ç®—ä¸€ä¸ªbitmapé‡Œæœ‰å¤šå°‘ä¸ª0, åˆ™æ˜¯rank0(i).

ç¬¬äºŒä¸ª, è¦å¾—åˆ°ç¬¬`i`ä¸ª1çš„ä½ç½®çš„æ“ä½œ, å«åšselect1(i).

æˆ‘ä»¬ç°åœ¨éœ€è¦ä¸º rank1() å’Œ select1() åˆ†åˆ«å»ºç«‹ç¼“å­˜:

### rank

å»ºç«‹ä¸€ä¸ªæ•°ç»„`rank []int32`: `ranks[i]` è®°å½• bitmap ä¸­å‰ `i*64` ä¸ªbitä¸­çš„`1`çš„æ•°é‡.
è¿™æ ·è¦è®¡ç®— rank(i) å°±åªéœ€è¦å– ranks[i/64],
å†ç”¨ä¸€ä¸ªO(1)çš„å‡½æ•°è°ƒç”¨(å¦‚`bits.OnesCount64()`)è®¡ç®— `bitmap[i:i % 64]` ä¸­çš„1çš„ä¸ªæ•°.

ä¾‹å¦‚ bitmap ä¸­ç¬¬0ä¸ª uint64 æœ‰25ä¸ª1, ç¬¬1ä¸ª uint64 æœ‰11ä¸ª1, é‚£ä¹ˆå»ºç«‹çš„ ranks ç´¢å¼•å¦‚ä¸‹:
[0, 25, 36]

```
ranks:   0  25  36
         |  |   `--------------------.
         |  `----------.             |
         v             v             v
bitmap:  0101...1010   1101...0010   0101...0010
         uint64        uint64        uint64
```

### select

selectç´¢å¼•ä¹Ÿæ˜¯ä¸€ä¸ª`[]int32`: `select[i]` è®°å½•ç¬¬`i*32`ä¸ª`1`åœ¨bitmapä¸­å“ªä¸ªä½ç½®.

ä¾‹å¦‚ç¬¬0ä¸ª`1`åœ¨ç¬¬1ä¸ªbit, ç¬¬32ä¸ª`1`åœ¨ç¬¬67ä¸ªbit, ç¬¬64ä¸ª`1`å‡ºç°åœ¨ç¬¬126ä¸ªbit,
é‚£ä¹ˆ selects çš„ç´¢å¼•å°±æ˜¯:`[1, 67, 126]`:

```
selects:  1  67  126
          |  |   `--------------.
          |  `------------.     |
          v               v     v
bitmap:  0101...1010   1101...0010   0101...0010
         uint64        uint64        uint64
```

# ä»£ç å®ç°

## Set ç»“æ„å®šä¹‰

æœ‰äº† ranks çš„ç´¢å¼•, æ‰¾å‡ºç¬¬iä¸ªbitä¹‹å‰çš„`1`(æˆ–`0`)çš„æ•°é‡å°±å¯ä»¥ç¡®å®šç”¨O(1)æ—¶é—´å®Œæˆ;
è€Œ select ç´¢å¼•, å¯ä»¥å°½å¯èƒ½è®©æ‰¾å‡ºç¬¬iä¸ª1çš„å¼€é”€è¶‹è¿‘äºO(1);
å› ä¸º selects çš„2æ¡ç´¢å¼•ä¹‹é—´å¯èƒ½è·¨è¶Šå‡ ä¸ªuint64, å–å†³äº bitmap ä¸­`1`çš„åˆ†å¸ƒ.

è¿™æ ·, æ•´ä¸ª succinctSet çš„æ•°æ®ç»“æ„å°±å®Œæ•´äº†:

```go
type Set struct {
    leaves, labelBitmap []uint64
    labels              []byte
    ranks, selects      []int32
}
```

æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹å®Œæ•´çš„ä»£ç é€»è¾‘:

## åˆ›å»º Set

ä¾æ—§ä»¥ `keys = [ab, abc, abcd, axy, buv]` ä¸ºä¾‹, æ¥æè¿° Set çš„å»ºç«‹,

-   å…ˆæ‰«ææ‰€æœ‰ keys çš„ç¬¬1åˆ—, æ‰¾åˆ°rootèŠ‚ç‚¹`^`çš„å‡ºå‘åˆ†æ”¯, æœ‰2ä¸ªlabel: `a, b`

    åŒæ—¶æŠŠæ•´ä¸ªkeysåˆ—è¡¨æŒ‰ç…§å‰ç¼€ä¸º`a`å’Œå‰ç¼€ä¸º`b`æ‹†åˆ†æˆ2éƒ¨åˆ†, é¡ºæ¬¡æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ç­‰å¾…å¤„ç†.

-   ç¬¬2æ­¥, ä»é˜Ÿåˆ—ä¸­æ‹¿å‡ºè¦å¤„ç†çš„ç¬¬2éƒ¨åˆ†: å‰ç¼€ä¸º`a`çš„keys,
    æ‰«æè¿™äº› keys çš„ç¬¬2åˆ—, æ‰¾åˆ°èŠ‚ç‚¹`1`çš„å‡ºå‘label: `b, x`

    å†æ¬¡æŠŠå‰ç¼€ä¸º`a`çš„é›†åˆæ‹†åˆ†ä¸ºå‰ç¼€ä¸º`ab`çš„é›†åˆå’Œå‰ç¼€ä¸º`ax`çš„é›†åˆ,
    é¡ºæ¬¡æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ç­‰å¾…å¤„ç†.

-   ç¬¬3æ­¥, æ‰«æå‰ç¼€ä¸º`b`çš„keyé›†åˆçš„ç¬¬2åˆ—, æ‰¾åˆ°1ä¸ªå‡ºå‘label `u`,
    æŠŠæ‰€æœ‰å‰ç¼€ä¸º`bu`çš„keyæ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨ç­‰å¾…å¤„ç†.

æœ€åç›´åˆ°æ‰€æœ‰é˜Ÿåˆ—ä¸­çš„å…ƒç´ éƒ½å¤„ç†å®Œ, trie å°±å»ºç«‹å®Œæˆ.
æœ€åå†é€šè¿‡`init()`ç»™å»ºå¥½çš„trieåš rank å’Œ select çš„ç´¢å¼•.

æ‰«æå‰ç¼€çš„è¿‡ç¨‹, ä¹Ÿå°±æ˜¯å»ºç«‹ trie èŠ‚ç‚¹çš„é¡ºåº, æŒ‰ç…§node-idæ ‡è¯†å¦‚ä¸‹:

```
â” 0  â” 1
| a  | b  â” 3
| a  | b  | c  â” 6
| a  | b  â†“ c  â†“ d
|    |    â” 4
| a  â†“ x  â†“ y
|    â” 2  â” 5
â†“ b  â†“ u  â†“ v
```

```go
func NewSet(keys []string) *Set {

    lIdx := 0
    ss := &Set{}

    type qElt struct{ s, e, col int }

    queue := []qElt{ {0, len(keys), 0} }

    for i := 0; i < len(queue); i++ {
        elt := queue[i]

        if elt.col == len(keys[elt.s]) {
            elt.s++
            setBit(&ss.leaves, i, 1)
        }

        for j := elt.s; j < elt.e; {

            frm := j

            for ; j < elt.e && keys[j][elt.col] == keys[frm][elt.col]; j++ {
            }

            queue = append(queue, qElt{frm, j, elt.col + 1})
            ss.labels = append(ss.labels, keys[frm][elt.col])
            setBit(&ss.labelBitmap, lIdx, 0)
            lIdx++
        }

        setBit(&ss.labelBitmap, lIdx, 1)
        lIdx++
    }

    ss.init()
    return ss
}
```


## æŸ¥è¯¢

trieçš„æŸ¥è¯¢è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•:
åœ¨è¦æŸ¥è¯¢çš„keyä¸­å–å‡ºä¸€ä¸ªbyte,
çœ‹å®ƒæ˜¯å¦åœ¨å½“å‰èŠ‚ç‚¹çš„ label ä¸­, å¦‚æœä¸åœ¨, å°±å¯ä»¥ç¡®è®¤ key ä¸åœ¨ succinctSet ä¸­.
å¦‚æœåœ¨, é€šè¿‡ä¹‹å‰æåˆ°çš„`select1(rank0(i))`çš„æ–¹æ³•èµ°åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹, ç»§ç»­ä»¥ä¸Šæ­¥éª¤.

å½“ key ä¸­æ‰€æœ‰ byte éƒ½æ£€æŸ¥å®Œå, çœ‹æœ€åæ˜¯å¦åœåœ¨ä¸€ä¸ª leaf èŠ‚ç‚¹,
æœ€ç»ˆç¡®è®¤æ˜¯å¦åŒ¹é…åˆ°ä¸€ä¸ªåœ¨Setä¸­å­˜åœ¨çš„key.

```go
func (ss *Set) Has(key string) bool {

    nodeId, bmIdx := 0, 0

    for i := 0; i < len(key); i++ {
        c := key[i]
        for ; ; bmIdx++ {

            if getBit(ss.labelBitmap, bmIdx) != 0 {
                return false
            }

            if ss.labels[bmIdx-nodeId] == c {
                break
            }
        }

        nodeId = countZeros(ss.labelBitmap, ss.ranks, bmIdx+1)
        bmIdx = selectIthOne(ss.labelBitmap,
                             ss.ranks, ss.selects, nodeId-1) + 1
    }

    return getBit(ss.leaves, nodeId) != 0
}

func getBit(bm []uint64, i int) uint64 {
    return bm[i>>6] & (1 << uint(i&63))
}
```

## bitmap çš„ç´¢å¼•

ä¸Šé¢æˆ‘ä»¬æåˆ°, ä» label å®šä½èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸»è¦ä¾èµ–äºè®¡ç®— bitmap çš„2ä¸ªæ“ä½œ:
è®¡ç®—æŒ‡å®šä½ç½®å‰æœ‰å‡ ä¸ª1: `rank0(i)`, ä»¥åŠæ‰¾å‡ºç¬¬iä¸ª1çš„ä½ç½®: `select1(i)`.

goé‡Œé¢æä¾›äº† uint64 çš„rankæ“ä½œ, bits.OnesCount64()
å¯ä»¥åœ¨O(1)çš„æ—¶é—´å†…è¿”å›ä¸€ä¸ª uint64 ä¸­è¢«ç½®ä¸º`1`çš„bitæ•°.
æˆ‘ä»¬ç”¨å®ƒæ¥ç»™ bitmap ä¸­æ¯ä¸ª unit64 æå‰è®¡ç®—å¥½å‰é¢æœ‰å‡ ä¸ª`1`,
è¿™æ ·åœ¨ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦å†å¤„ç†æœ€åä¸€ä¸ªuint64å°±å¯ä»¥äº†.

selectçš„ç´¢å¼•ç›´æ¥é€ä¸ªè®¡æ•°`1`çš„ä¸ªæ•°, ç„¶ååœ¨ä¸ªæ•°æ»¡32æ•´æ•°å€æ—¶æ·»åŠ ä¸€æ¡ç´¢å¼•.

```go
func (ss *Set) init() {
    ss.ranks = []int32{0}
    for i := 0; i < len(ss.labelBitmap); i++ {
        n := bits.OnesCount64(ss.labelBitmap[i])
        ss.ranks = append(ss.ranks, ss.ranks[len(ss.ranks)-1]+int32(n))
    }

    ss.selects = []int32{}
    n := 0
    for i := 0; i < len(ss.labelBitmap)<<6; i++ {
        z := int(ss.labelBitmap[i>>6]>>uint(i&63)) & 1
        if z == 1 && n&63 == 0 {
            ss.selects = append(ss.selects, int32(i))
        }
        n += z
    }
}
```

å½“æˆ‘ä»¬è¦åˆ©ç”¨ç´¢å¼•å–ç¬¬iä¸ªbitå‰æœ‰å‡ ä¸ª`0`æ—¶, é€šè¿‡`rank0(i) = i - rank1(i)` æ¥è®¡ç®—:

```go
// countZeros counts the number of "0" in a bitmap before the i-th bit(excluding
// the i-th bit) on behalf of rank index.
// E.g.:
//   countZeros("010010", 4) == 3
//   //          012345
func countZeros(bm []uint64, ranks []int32, i int) int {
    return i - int(ranks[i>>6]) - bits.OnesCount64(bm[i>>6]&(1<<uint(i&63)-1))
}
```

åœ¨æŸ¥æ‰¾ç¬¬iä¸ª`1`æ‰€åœ¨ä½ç½®æ—¶, æˆ‘ä»¬å…ˆé€šè¿‡ selects ç´¢å¼•æ‰¾åˆ°ä¸€ä¸ªæœ€æ¥è¿‘çš„ uint64,
å†å‘åé€ä¸ªæŸ¥æ‰¾ç›´åˆ°è§åˆ°ç¬¬iä¸ª`1`. è¿™ä¸€æ­¥çš„æ€§èƒ½ä¸æ˜¯ä¸¥æ ¼çš„O(1):

```go
// selectIthOne returns the index of the i-th "1" in a bitmap, on behalf of rank
// and select indexes.
// E.g.:
//   selectIthOne("010010", 1) == 4
//   //            012345
func selectIthOne(bm []uint64, ranks, selects []int32, i int) int {
    base := int(selects[i>>6] & ^63)
    findIthOne := i - int(ranks[base>>6])

    for i := base >> 6; i < len(bm); i++ {
        bitIdx := 0
        for w := bm[i]; w > 0; {
            findIthOne -= int(w & 1)
            if findIthOne < 0 {
                return i<<6 + bitIdx
            }
            t0 := bits.TrailingZeros64(w &^ 1)
            w >>= uint(t0)
            bitIdx += t0
        }
    }
    panic("no more ones")
}
```

# æ€§èƒ½åˆ†æ

æˆ‘ä»¬ç”¨ç½‘ä¸Šæœé›†åˆ°çš„æ•°æ®é›†åšäº†ä¸‹æµ‹è¯•.
æµ‹è¯•ä¸­ä½¿ç”¨çš„è´Ÿè½½æ¨¡å‹éƒ½æ˜¯ [zipf][post-zipf], æ¯”è¾ƒç¬¦åˆäº’è”ç½‘çš„çœŸå®åœºæ™¯, zipf çš„å‚æ•° s å– 1.5,
ç»†èŠ‚å‚è€ƒ [report][] çš„ä»£ç , ç»“æœå¦‚ä¸‹:

-   20ä¸‡ä¸ªç½‘ä¸Šè¯æ±‡:
    - succinctSet ç©ºé—´å¼€é”€æ˜¯æºæ•°æ®çš„ **57%**.
    - `Has()` å¼€é”€ä¸º `350 ns`.

    åŸå§‹æ•°æ®å¤§å°: 2204 KB

    è·Ÿ string æ•°ç»„çš„ bsearch, ä»¥åŠ [google-btree][] çš„å¯¹æ¯”:

    | Data         | Engine       | Size(KB) | Size/original | ns/op |
    | :--          | :--          | --:      | --:           | --:   |
    | 200kweb2     | bsearch      |  5890    |  267%         | 229   |
    | 200kweb2     | succinct.Set |  1258    |   57%         | 356   |
    | 200kweb2     | btree        | 12191    |  553%         | 483   |

-   87ä¸‡ä¸ªæŸç«™æä¾›çš„ ipv4 åˆ—è¡¨:
    - succinctSet ç©ºé—´å¼€é”€æ˜¯æºæ•°æ®çš„  **67%**.
    - `Has()` å¼€é”€ä¸º `528 ns`.

    åŸå§‹æ•°æ®å¤§å°: 6823 KB

    | Data         | Engine       | Size(KB) | Size/original | ns/op |
    | :--          | :--          | --:      | --:           | --:   |
    | 870k_ip4_hex | bsearch      | 17057    |  500%         | 276   |
    | 870k_ip4_hex | succinct.Set |  2316    |   67%         | 496   |
    | 870k_ip4_hex | btree        | 40388    | 1183%         | 577   |

å¯ä»¥çœ‹å‡ºåœ¨å†…å­˜æ–¹é¢:

- succinctSet å¯¹å†…å­˜å¼€é”€ä¼˜åŠ¿æ˜æ˜¾, ä¸ä»…å®¹é‡æ²¡æœ‰é¢å¤–å¢åŠ , è¿˜å°‘å¾ˆå¤š.

- goä¸­çš„stringæœ‰2ä¸ªå­—æ®µ: åˆ°stringå†…å®¹çš„æŒ‡é’ˆ, ä»¥åŠä¸€ä¸ªlength,
    æ‰€ä»¥æ¯æ¡è®°å½•å¼€é”€ä¼šå¤š16å­—èŠ‚.

- [google-btree][] å†…éƒ¨å› ä¸ºè¿˜æœ‰interface, é¢å¤–å­˜å‚¨å¼€é”€æ›´å¤§.


å¯¹æŸ¥è¯¢æ€§èƒ½:

- çŸ­å­—ç¬¦ä¸²æŸ¥è¯¢äºŒåˆ†æŸ¥æ‰¾æ€§èƒ½æœ€å¥½, ä¸€ä¸ªå­—ç¬¦ä¸²è¯»å–ä¸€æ¬¡å·®ä¸å¤šéƒ½èƒ½ç¼“å­˜åœ¨L1 cacheé‡Œ, å¯¹ä¸»å­˜çš„è®¿é—®åº”è¯¥éå¸¸è¶‹è¿‘äºlgâ‚‚(n).

- succinctSet å› ä¸ºæ¯ä¸ªå­—ç¬¦ä¸²çš„æ¯ä¸ªå­—ç¬¦éƒ½è¢«åˆ†æ•£å­˜å‚¨äº†,
    ä»¥åŠrankså’Œselectsçš„è®¿é—®ä¹Ÿæ˜¯è·³è·ƒçš„, åœ¨ä¸€ä¸ªkeyçš„æŸ¥è¯¢ä¸­è¦è®¿é—®å¤šä¸ªä½ç½®.
    æ‰€ä»¥å¯¹ç¼“å­˜çš„å‹å¥½ä¸å¦‚æ•°ç»„.

- btreeçš„æ—¶é—´å¼€é”€æ›´å¤§, å¯èƒ½ç”±äºé—´æ¥è®¿é—®æ¯”è¾ƒå¤š, å¯¼è‡´btreeçš„ä¼˜åŠ¿æ²¡æœ‰å‘æŒ¥å‡ºæ¥.


github: [succinct.Set][]

{% include build_ref %}
