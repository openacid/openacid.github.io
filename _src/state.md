## State

State 表示一个存储系统的状态,
每次写入到 A, A上的State都产生变化.

在本文中, State 表示为一个集合,

State 包括几个基本的:
- 集合中的元素可以是什么;
- 集合的初始状态是什么;
- 以及集合中的元素需要满足什么样的约束条件.

通过对这个集合施加不同的限制条件和诠释, 可以将它映射到人们熟悉的存储形式.

例如:

- CRDT: State 中的元素是一个个修改系统状态的命令, Cmd, 如果Cmd之间没有任何约束条件,
  那么它就是一个 [CRDT][] 的存储.

- DAG: State 中的元素是一个图的节点和边: 节点是Cmd, 边表示2个Cmd之间的顺序, 例如 Cmd1 -> Cmd2 表示cmd1 **希望** 在cmd2之后,
  那么它可以表示 [generalized-paxos][] 的存储形式
  如果允许图中有环, 那么它就呈现为 [epaxos][] 的存储形式.

- 日志: State 中元素是一个个Cmd,
  State 初始状态是一个无限长的list,
  边可以从一个list中elt指向一个cmd.
  且State的约束为: 每个elt最多只能有一个边指向一个cmd.

  那么它就是一个 [multi-paxos][] 的日志.

  ```
  list: [0, 1, 2, 3...]
         |  |  |
         |  |  v
         |  v  cmdᵢ
         v  nil
         cmd1
  ```

  如果再增加一个约束: list中不允许留空(nil),
  那么它就是一个 [raft][] 的日志.


> 不讨论状态机
>
> 我们在本文中略去状态机的角色, 因为它不是一致性算法的核心部分
> 在实现上, 它更多的是一个对系统连续变化的抽象.
> 而真正的状态是raft的日志这种记录了完整变化历史的角色.

所以我们在本文本文中只把存储系统的状态看做一个有约束的集合.




State 需要满足一些约束

## State 的合并:

因为集合是可以合并的,
由此2个同样约束的 State 也可以合并, 只需要满足在合并之后不违反约束条件.

例如上面提到的 **日志** 形式的 State, 合并过程就是
将list elt的边和cmd都放到一个集合里, 再看是否满足约束条件:
每个elt只能最多指向一个cmd:

如果合并之后不满足约束, 那就是一个冲突:


### Conflict

例如 **日志** 的 State(参考 [multi-paxos][] 的日志, 允许空洞), 
合并之后每个elt仍然至多指向一个cmd.

`[x=1, y=2]` 与 `[x=2]`      冲突,
`[x=1, y=2]` 与 `[x=1]`      不冲突,
`[x=1, y=2]` 与 `[nil, y=2]` 不冲突,
`[x=1, nil]` 与 `[nil, y=2]` 不冲突,


### State 的关系

由 State 之间的合并, 我们可以得出:
State 之间的一种关系:

显然, 如果State1 跟 State2 合并之后跟State2相同,
那么
State₂ ⊇ State₁
State2 ≥ State1


根据合并的原则, 
我们可以把这种包含关系理解成一种顺序关系:
State2 ≥ State1 : State1 ∪ State2 == State1

- 于是, 合并后都不相同的2个 State 没有大小关系, 合并后的结果是最小上界,
  跟合并前都是大于关系.

TODO 例子

- 冲突的两个 State 也没有大小关系, 没有上界.


TODO 例子





---

存储系统存储的状态 State 是一个集合.

集合加以约束可以表示成更便于使用的结构:

如果集合的每个元素是一个 可交换 的命令, 例如 `x=x+1`, `y=y+3`, `x=x+2`
那么这就是一个 [CRDT][] 系统.


如果集合的元素是一个命令, 或一个边,
那就是一个 类似 generalize-paxos 的系统.
存储的状态由一个命令组成的有向图构成,
且冲突的命令之间必须只有一条有向边.

- 一般对一个key的操作是相关的,

```
x=x+1  y=x+y
|     /|
|    / |
v  ↙   v
x=1    y=2     z=3
```


如果任意2个cmd之间都相关, 且不允许环, 那就是一个链表

```
    .- u=5
   | .-' |
   | |   v
   | |  z=y+1
   | |  | |
   | |  v  `.
   | `> y=2 |
   |    | .-'
   |    v v
   `--> x=1
```

State 的集合是一个 偏序集合



