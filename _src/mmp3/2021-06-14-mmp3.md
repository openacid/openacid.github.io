---
title:      "Multi-Master-Paxos: 3"
authors:
    - xp
categories:
    - algo
tags:
    - distributed
    - replication
    - paxos
    - multi-master
    - multi-leader
    - active-active
    - åˆ†å¸ƒå¼
    - å¤šæ´»
    - å¤šä¸»

refs:
    - x: y

article:
    image: /post-res/mmp3/mmp3-banner-big.png

mathjax: false
toc: true
toc_label: æœ¬æ–‡ç›®å½•
toc_sticky: true
excerpt: "å°å­©å­æ‰é€‰master, æˆå¹´äººåªç”¨multi-master"
---

# Background

[200è¡Œä»£ç å®ç°paxos-kv][post-paxoskv]
ä¸­ä»‹ç»äº†ä¸€æ¬¾éå¸¸ç®€æ´çš„åˆ†å¸ƒå¼kvå­˜å‚¨å®ç°, å®ƒæ˜¯åŸºäº [classic-paxos][ref-classic-paxos]
å®ç°åˆ†å¸ƒå¼ä¸€è‡´æ€§. åœ¨ [paxosçš„ç›´è§‚è§£é‡Š][post-paxos] ä¸­æˆ‘ä»¬æåˆ°, æ¯æ¬¡å†™å…¥, ä¹Ÿå°±æ˜¯æ¯ä¸ª paxos å®ä¾‹éœ€è¦2è½® RPC å®Œæˆ, æ•ˆç‡ä½.

ä¸€ä¸ªå¸¸è§çš„ä¼˜åŒ–å°±æ˜¯ mutli-paxos(æˆ–raft), ç”¨ä¸€æ¬¡ RPC å¯¹å¤šä¸ªå®ä¾‹è¿è¡Œ phase-1;
å†å¯¹æ¯ä¸ªå®ä¾‹åˆ†åˆ«è¿è¡Œ phase-2, è¿™æ ·å‡æ‘Šå¼€é”€æ˜¯ä¸€æ¬¡ RPC å®Œæˆä¸€æ¬¡å†™å…¥.
å®ƒé€šè¿‡ phase-1 åœ¨é›†ç¾¤ä¸­ç¡®å®šäº†ä¸€ä¸ªå”¯ä¸€å¯å†™çš„ leader.
è¿™ç§è®¾è®¡åœ¨è·¨æœºæˆ¿(æˆ–è·¨äº‘)éƒ¨ç½²çš„ç¯å¢ƒä¸­çš„ç¼ºé™·æ˜¯:
å¼‚åœ°æœºæˆ¿çš„å†™å…¥å°±éœ€è¦2ä¸ª RTT æ‰èƒ½å®Œæˆ:

`client â†’ leader â†’ followers â†’ leader â†’ client`

ä¹Ÿå°±æ˜¯è¯´å®ƒæ— æ³•åšåˆ° **å¼‚åœ°å¤šæ´»**, åœ¨3èŠ‚ç‚¹çš„åœºæ™¯é‡Œ, æœ‰ `2/3` çš„å†™å…¥æ•ˆç‡é™ä½åˆ°2 ä¸ª RTT.

æœ¬æ–‡ä»å¦ä¸€è§’åº¦å‡ºå‘æ¥è§£å†³å¼‚åœ°å¤šæ´»çš„é—®é¢˜, 3æœºæˆ¿éƒ¨ç½²çš„3å‰¯æœ¬é›†ç¾¤ä¸­:
- ä»»ä¸€èŠ‚ç‚¹éƒ½å¯å†™,
- ä»»ä¸€ç¬”å†™å…¥éƒ½å¯ä»¥ä¸¥æ ¼åœ¨1ä¸ª RTT å†…å®Œæˆ.

è¿™å°±æ˜¯ä»Šå¤©è¦ä»‹ç»çš„ 
[200è¡Œä»£ç å®ç°paxos-kv][post-paxoskv]
çš„æ”¹è¿›ç‰ˆ: mmp-3: multi-master-paxos 3å‰¯æœ¬å®ç°.

åŒæ · show me the code çš„åŸåˆ™ä¸èƒ½å˜: æœ¬æ–‡å®ç°çš„3èŠ‚ç‚¹å¤šæ´»ä»£ç åœ¨: [mmp3][repo-mmp3]

> å¼‚åœ°å¤šæ´»æ˜¯ç›®å‰åˆ†å¸ƒå¼é¢†åŸŸè¶Šæ¥è¶Šè¢«é‡è§†çš„ä¸€ä¸ªé—®é¢˜, æœºæˆ¿æ­£åœ¨å˜æˆå•æœº,
> å•æœºæˆ¿å¤šæœºåˆ†å¸ƒå¼åœ¨ç°åœ¨å¤§è§„æ¨¡éƒ¨ç½²çš„ä¸šåŠ¡ä¸­å·²ç»æ»¡è¶³ä¸äº†ä¸šåŠ¡çš„å¯ç”¨æ€§éœ€æ±‚äº†.
>
> å‡ ä¹æ‰€æœ‰çº¿ä¸Šç¯å¢ƒéƒ¨ç½²çš„åˆ†å¸ƒå¼å­˜å‚¨, éƒ½éœ€è¦è·¨æœºæˆ¿(æˆ–è€…è·¨äº‘)çš„éƒ¨ç½².
> è€Œå¤§å®¶ä¹Ÿç§¯æåœ¨è§£å†³è¿™äº›é—®é¢˜:
> - æˆ–è€…ç”¨é˜Ÿåˆ—ç­‰æœ€ç»ˆä¸€è‡´æ€§çš„æ‰‹æ®µæ¥å®Œæˆè·¨æœºæˆ¿çš„å¤åˆ¶, è¿™æ ·ä¼šäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´, 2æ¡äº’ç›¸å†²çªçš„æ•°æ®å¯èƒ½åŒæ—¶è¢«å†™å…¥; ä¸šåŠ¡å±‚éœ€è¦å‚ä¸è§£å†³è¿™ç±»å†²çª.
> - æˆ–è€…å°†æ•°æ®åšæ‹†åˆ†, å°†åœ¨Aåœ°å†™å…¥å¤šçš„åˆ†é…åˆ°Aæœºæˆ¿ä¸º leader çš„ sharding , å°†Båœ°å†™å…¥è¾ƒå¤šçš„æ•°æ®åˆ†é…åˆ°Bæœºæˆ¿ä¸º leader çš„ sharding .
> - æˆ–è€…ä¸€ä¸ªæœºæˆ¿ä¸ºä¸»: éƒ¨ç½²2ä¸ªå‰¯æœ¬, å¦ä¸€ä¸ªæœºæˆ¿éƒ¨ç½²1ä¸ªå‰¯æœ¬æ¥å½¢æˆ3å‰¯æœ¬çš„é›†ç¾¤, è¿™æ ·å®é™…ä¸ŠAæœºæˆ¿æ•…éšœä¼šå¯¼è‡´å…¨å±€ä¸å¯è¯»å†™, Bæœºæˆ¿åªèƒ½æä¾›é¢å¤–çš„æ•°æ®å†—ä½™, æ— æ³•æä¾›æ›´å¤šçš„æ•°æ®å¯ç”¨æ€§.


> paxos åœ¨é›†ç¾¤è¾ƒå°æ—¶å¯ä»¥é€šè¿‡å®šåˆ¶ paxos æ¥å®Œæˆ1ä¸ª RTT çš„å†™å…¥,
> å¦‚æœä½¿ç”¨ [majority-quorum][post-quorum], æœ€å¤šæ”¯æŒ5ä¸ªå‰¯æœ¬çš„å¤šæ´».
>
> åœ¨ epaxos å®šä¹‰çš„å¤šæ´»è®¾è®¡, ç®€å•ä»‹ç»äº†3èŠ‚ç‚¹çš„è®¾è®¡, ä½†å¹¶æ²¡æœ‰ç»™å‡ºå®ç°çš„ç»†èŠ‚,
> å…¶ä¸­å„ç§å†²çªçš„å¤„ç†ä»¥åŠä¿®å¤çš„æµç¨‹å¹¶æ²¡æœ‰æ˜ç¡®çš„å®šä¹‰.
>
> - åŒæ—¶ epaxos çš„ apply ç®—æ³•å­˜åœ¨ä¸å¯è§£å†³çš„ livelock é—®é¢˜:
>   é€šè¿‡ SCC æ¥ç¡®å®š instance é¡ºåºæ— æ³•ä¿è¯åœ¨æœ‰é™æ—¶é—´å†…ç»“æŸ.
>
> - å¦å¤– epaxos çš„è®¾è®¡ä¸­ç¼ºå°‘ä¸€ä¸ª rnd è®°å½•( paxos ä¸­çš„ last-seen-ballot æˆ– vbal),
>   å¯¼è‡´å…¶ä¸€è‡´æ€§å®ç°æ˜¯é”™è¯¯çš„.
>
> - ä»¥åŠ instance ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¼šåœ¨ä¿®å¤è¿‡ç¨‹ä¸­äº§ç”Ÿä¸ä¸€è‡´çš„é—®é¢˜.
>
> - epaxos éœ€è¦å¦å¤–ä¸€ä¸ªseqæ¥ç¡®å®š instance ä¹‹é—´çš„é¡ºåº, åœ¨ mmp3 çš„è®¾è®¡ä¸­, seq æ˜¯ä¸å¿…è¦çš„,
>   åªéœ€ä¾èµ–å…³ç³»å°±å¯ä»¥ç¡®å®šç¡®å®šçš„ apply é¡ºåº.

# Multi master paxos - 3

æˆ‘ä»¬ä» classic-paxos å‡ºå‘æ¥åˆ†æé—®é¢˜.

> xpçš„tips: è¦å®ç°ä¸€ä¸ªç¨³å®šçš„åˆ†å¸ƒå¼ç³»ç»Ÿ, æœ€å¥½ç”¨ raft, å› ä¸ºå¼€ç®±å°±ç”¨.
> è¦å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿ, æœ€å¥½ä» paxos å¼€å§‹.
> raft çœ‹ä¼¼ç®€å•çš„è®¾è®¡ éšè—äº†ä¸€äº›éšæ™¦çš„æ¡ä»¶, å…¶æ­£ç¡®æ€§çš„è¯æ˜è¦æ¯” paxos å¤æ‚.

æˆ‘ä»¬éœ€è¦è¾¾åˆ°2ä¸ªç›®çš„:
- 1ä¸ª RTT å®Œæˆä¸€æ¬¡commit.
- 3ä¸ªèŠ‚ç‚¹åŒæ—¶æ— å†²çªå†™.

# 1 RTT çš„ classic- paxos

å¦‚æœ classic-paxos ä¸éœ€è¦2ä¸ª RTT,
æˆ‘ä»¬å°±ä¸éœ€è¦ multi-paxos æˆ– raft è¿™äº›ä¸œè¥¿æ¥ä¼˜åŒ–å»¶è¿Ÿäº†.

åœ¨3èŠ‚ç‚¹çš„ç³»ç»Ÿä¸­, è¿™æ˜¯å¯ä»¥å®ç°çš„.

é¦–å…ˆåšä¸€äº›åŸºç¡€çš„è®¾å®š: ä¸€ä¸ª replica åœ¨ç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ªreplica(æˆ–å«ä½œserveræˆ–node), å®ƒåŒæ—¶æ˜¯ proposer å’Œ acceptor.
ä¸€ä¸ª replica æ¥å—åˆ°ä¸€ä¸ªå†™å…¥è¯·æ±‚æ—¶, å®ƒå°±ç”¨æœ¬åœ°çš„ proposer æ¥å®Œæˆæäº¤.


## å›é¡¾ classic paxos

[200è¡Œä»£ç å®ç°paxos-kv][post-paxoskv] ä»‹ç»çš„ classic-paxos å†™å…¥æµç¨‹å¦‚ä¸‹,
replica-0 ä¸Šçš„ proposer P0, é¡ºæ¬¡å®Œæˆ phase-1, phase-2 å’Œ commit:

```mermaid
sequenceDiagram
    participant Client
    participant R0
    participant R1
    participant R2

    Client->>+R0: set V

        Note over R0: NewProposer: P0(bal=1,V)

        Note over R0: Prepared: last_bal=1

        R0->>+R1: Prepare bal=1
        Note over R1: Prepared: last_bal=1
        R1->>-R0: last_bal=1

        Note over R0: Accepted: last_bal=1,vbal=1,V

        R0->>+R1: Accept bal=1,V
        Note over R1: Accepted: last_bal=1,vbal=1,V
        R1->>-R0: last_bal=1

    R0->>-Client: OK

    R0->>R1: Commit vbal=1,V
    R0->>R2: Commit vbal=1,V
```

ğŸ¤”
æ€è€ƒä»¥ä¸Šè¿‡ç¨‹...

## ä¼˜åŒ– classic paxos ä¸º 1ä¸ª RTT

å› ä¸º proposer æœ¬èº«åªæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„, åœ¨ paxos ä¸­, å®ƒä¸éœ€è¦è·Ÿ acceptor æœ‰ä»€ä¹ˆç»‘å®šå…³ç³»,
æ‰€ä»¥, æˆ‘ä»¬å¯ä»¥**è®© proposer è¿è¡Œåœ¨ä»»ä½•ä¸€ä¸ª replica ä¸Š**:
æŠŠ proposer å‘åˆ°å¦ä¸€ä¸ª replica ä¸Šè¿è¡Œ, 
è¿™æ ·æ¶ˆæ¯çš„ä¼ è¾“å°±å¯ä»¥è½¬å˜æˆ proposer çš„ä¼ è¾“.

è¦è¾¾åˆ° paxos è¦æ±‚çš„ 2/3çš„å¤šæ•°æ´¾,
ä¹Ÿåªéœ€è¦å°† proposer å‘åˆ°å¦å¤–ä¸€ä¸ª replica, 
å› ä¸ºè¿™ä¸ª proposer æ°¸è¿œåªæœ‰1ä¸ªå®ä¾‹, æ‰€ä»¥ä¸ä¼šå‡ºç°ä¸ä¸€è‡´(proposer æˆ–è€…åœ¨R0ä¸Šå·¥ä½œæˆ–è€…åœ¨åœ¨R1ä¸Šå·¥ä½œ).

> å¦‚æœè¦å°† proposer å‘åˆ° 2ä¸ª replica å°±ä¼šå¤æ‚ä¸€äº›, ä¾‹å¦‚5èŠ‚ç‚¹ä¸­ quorum=3, 2ä¸ªä¸åŒçš„ proposer
> å¯èƒ½ä¼šå°è¯•ä½¿ç”¨ä¸åŒçš„å€¼.

é€šè¿‡å‘é€ proposer çš„æ–¹å¼, paxos å¯ä»¥è¢«ä¼˜åŒ–æˆå¦‚ä¸‹çš„1 RTTå®ç°: P0 åœ¨ R1
ä¸Šé¡ºæ¬¡æ‰§è¡Œ phase-1 å’Œ phase-2, ç„¶åå†è¢«é€ä¼šR0:

```mermaid
sequenceDiagram
    participant Client
    participant R0
    participant R1
    participant R2

    Client->>+R0: set V

        Note over R0: NewProposer: P0(bal=1,V)

        Note over R0: Prepared: last_bal=1

        R0->>+R1: send P0(bal=1, V)
        Note over R1: Prepared: last_bal=1
        Note over R1: Accepted: last_bal=1,vbal=1,V
        R1->>-R0: send P0(bal=1,V)

        Note over R0: Accepted: last_bal=1,vbal=1,V

    R0->>-Client: OK

    R0->>R1: Commit
    R0->>R2: Commit
```

> åœ¨ä¼ è¾“ proposer çš„è¿‡ç¨‹ä¸­, åŒºåˆ«äºåŸå§‹ paxos çš„æ˜¯: å¾€è¿”ä¸¤ä¸ªè¿‡ç¨‹éƒ½è¦åŒ…æ‹¬ proposer çš„å®Œæ•´ä¿¡æ¯:
> - R0 åˆ° R1 çš„è¿‡ç¨‹ä¸­, è¦å¸¦ä¸Šç”¨æˆ·è¦æäº¤çš„å€¼, ä»¥ä¾¿åœ¨ R1 ä¸Š Prepare æˆåŠŸåç›´æ¥è¿è¡Œ Accept;
> - R1 åˆ° R0 çš„è¿‡ç¨‹ä¸­, è¦å¸¦ä¸Š R1 çš„ Prepare å’Œ Accept çš„æ‰§è¡Œç»“æœ.


è¿™æ ·ä¸€è½® RPC å, R0 å’Œ R1 å°±å¯ä»¥å½¢æˆå¤šæ•°æ´¾, ç„¶å R0 å¯ä»¥ç›´æ¥ commit.

æ³¨æ„, è¿™ä¸ªæ¨¡å‹ä¸­, é™¤äº† proposer çš„ä½ç½®å˜åŒ–äº†, è·Ÿ classisc-paxos æ²¡æœ‰ä»»ä½•åŒºåˆ«!
ä¹Ÿå°±æ˜¯è¯´, ä»»ä½• paxos èƒ½å®Œæˆçš„äº‹æƒ…å®ƒéƒ½å¯ä»¥å®Œæˆ.

ç°åœ¨æˆ‘ä»¬å®Œæˆäº†ç¬¬ä¸€ä¸ªä»»åŠ¡.
å¦‚æœä»¥æ­¤æ¨¡å‹æ¥é‡å†™ [200è¡Œä»£ç å®ç°paxos-kv][post-paxoskv],
å¯ä»¥åœ¨3å‰¯æœ¬ç³»ç»Ÿä¸Šå®ç°1 RTTæäº¤, ä½†å¤šå†™å…¥ç‚¹ä¾ç„¶ä¼šæœ‰å†²çª,
ä¾‹å¦‚ R0 å’Œ R1 åŒæ—¶å‘èµ·åŒä¸€ä¸ªpaxos instanceçš„å†™å…¥, R0 åœ¨æ”¶åˆ°å‘é€å›æ¥çš„ P0 å,
å¯èƒ½å°±ä¼šå‘ç°æœ¬åœ°çš„ instance å·²ç»è¢« P1 ä»¥æ›´é«˜çš„ ballot è¦†ç›–äº†, è¦é‡æ–°æå‡P0
çš„ballotå†é‡è¯•.

è¿™å°±æ˜¯æˆ‘ä»¬è¦è§£å†³çš„ç¬¬äºŒä¸ªé—®é¢˜: é¿å…ä¸åŒ replica çš„å†™å…¥å†²çª.


# Multi column log

2ä¸ª replica åŒæ—¶å†™ä¸€ä¸ª instance äº§ç”Ÿæ´»é”, å¯¼è‡´æ— æ³•ä¿è¯1ä¸ª RTT å®Œæˆå†™å…¥.
è¦é¿å…å†²çª, æˆ‘ä»¬å°±éœ€è¦è®©æ¯ä¸ª replica ä¸èƒ½äº§ç”Ÿäº’ç›¸å†²çªçš„ instance,
**æ‰€ä»¥ç»™æ¯ä¸ª replica åˆ†é… instance çš„ç©ºé—´è¦åˆ†å¼€**.

åœ¨ mmp3 çš„å®ç°ä¸­, æœ‰3ä¸ªreplica å°±éœ€è¦æœ‰3åˆ— instance , æ¯ä¸ª replica åªå†™å…¶ä¸­ä¸€åˆ—.

```graphviz
digraph queue_demo
{

    size="10,10";
    dpi=100;

    layout=dot;
    rankdir=TD;
    node[shape=record, style=filled];
    splines=ortho;
    graph [labelloc = "b" ];

    nodesep=0.05;

    subgraph cluster_R0 {
        label = "replica-0";
        P0[fillcolor="#f0e0d0"];
        {
            rank=same;
            // ordering="out";
            // outputMode="nodefirst";
            node[width=0];

            C00[fillcolor="#f0e0d0", label="{<e4>a4|a3|a2|a1| A}"];
            C01[fillcolor="#ffffd0", label="{  |  |<e2>b2|b1| B}"];
            C02[fillcolor="#d0f0d0", label="{  |<e3>c3|c2|c1| C}"];

            r0[style=invisible, fixedsize=true, width=0];
            r0->C00->C01->C02 [style=invis];
        }

    }

    subgraph cluster_R1 {
        label = "replica-1";
        P1[fillcolor="#ffffd0"];
        {
            rank=same;
            node[width=0];

            C10[fillcolor="#f0e0d0", label="{<e4>a4|a3|a2|a1| A}"];
            C11[fillcolor="#ffffd0", label="{  |  |<e2>b2|b1| B}"];
            C12[fillcolor="#d0f0d0", label="{  |<e3>c3|c2|c1| C}"];

            r1[style=invisible, fixedsize=true, width=0];
            r1->C10->C11->C12 [style=invis];
        }
    }

    subgraph cluster_R2 {
        label = "replica-2";
        P2[fillcolor="#d0f0d0"];
        {
            rank=same;
            node[width=0];

            C20[fillcolor="#f0e0d0", label="{<e4>a4|a3|a2|a1| A}"];
            C21[fillcolor="#ffffd0", label="{  |  |<e2>b2|b1| B}"];
            C22[fillcolor="#d0f0d0", label="{  |<e3>c3|c2|c1| C}"];

            r2[style=invisible, fixedsize=true, width=0];
            r2->C20->C21->C22 [style=invis];
        }
    }


    {
        edge[weight=0];
        P0 -> C00:e4;
        P0 -> C10:e4;

        P1 -> C01:e2;
        P1 -> C11:e2;

        P2 -> C12:e3;
        P2 -> C22:e3;
    }
}
```

ä¾‹å¦‚:
- R0 ç»´æŠ¤ä¸€ä¸ª proposer P0, ä¸æ–­çš„è¿è¡Œ paxos åœ¨æ¯ä¸ª replica ä¸Š column `A` çš„ instance,
- R1 ç»´æŠ¤ proposer P1, åªå†™æ¯ä¸ª replica ä¸Šçš„ column `B` åˆ—çš„ instance.

> è¿™ç§ç»“æ„æœ‰ç‚¹ç±»ä¼¼äº 3 ä¸ªæ ‡å‡†çš„ raft ç»„, æ¯ç»„éƒ½éƒ¨ç½²åœ¨3ä¸ªreplicaä¸Š, ç¬¬iç»„çš„raftçš„leaderå°±æ˜¯R[i]

è¿™æ ·, å› ä¸ºæ²¡æœ‰ instance å†²çª, æ‰€ä»¥ä¸è®ºä»»ä½•ä¸€ä¸ª replica ä¸Šæ”¶åˆ°çš„å†™è¯·æ±‚, éƒ½åªéœ€ 1ä¸ª RTT å®Œæˆ instance çš„æäº¤.

ä½†æ˜¯!

è¿™3åˆ—çš„ instance ç›®å‰è¿˜æ˜¯**æ— å…³**çš„, è¦æƒ³å°† instance åº”ç”¨åˆ° state machine, æ‰€æœ‰ replica ä¸Šçš„ instance éƒ½å¿…é¡»ä»¥ç›¸åŒçš„é¡ºåº apply.
(ä¸åƒ raft é‡Œçš„ instance æ˜¯ç®€å•çš„å•è°ƒé€’å¢çš„, åªè¦ä¿è¯ instance ä¸€è‡´, apply çš„é¡ºåºå°±ä¸€è‡´).

å› æ­¤åœ¨ mmp3 ä¸­, é™¤äº† instance å†…å®¹ä¸€è‡´å¤–, è¿˜éœ€è¦é¢å¤–å¢åŠ æ¯åˆ— instance ä¹‹é—´çš„çº¦æŸ,
æ¥ä¿è¯ apply é¡ºåºä¸€è‡´. 3ä¸ª column ä¸­çš„ instance ä¹‹é—´æ˜¯ä¸€ç§(è¾ƒå¼±ä½†ä¸€è‡´çš„) æ‹“æ‰‘é¡ºåº, å› æ­¤åœ¨ mmp3 ä¸­,
paxos è¦ç¡®å®šçš„å€¼(Value)åŒ…æ‹¬2ä¸ª:
- ç”¨æˆ·è¦æäº¤çš„æ•°æ®: ä¸€æ¡æ“ä½œ state machine çš„æ—¥å¿—: instance.Val,
- è¿˜éœ€è¦ç¡®å®šè¿™ä¸ª instance ä¸å…¶ä»– instance çš„å…³ç³»**.


## ä½¿ç”¨ paxos ç¡®å®š instance ä¹‹é—´çš„å…³ç³»

è¿™ä¸ª**å…³ç³»**æˆ‘ä»¬æè¿°ä¸º: ä¸€ä¸ª instance `X` çœ‹åˆ°äº†å“ªäº›å…¶ä»– instance: ç”¨ `X.Deps` æ¥è¡¨ç¤º, ç”¨å®ƒæ¥ç¡®å®š instance ä¹‹é—´çš„ apply çš„é¡ºåº:

> ä¾‹å¦‚åœ¨å•æœºç³»ç»Ÿä¸­, å¹¶å‘å†™å…¥3æ¡æ•°æ®a, b, c, å¯ä»¥è¿™æ ·ç¡®å®š a, b, c çš„é¡ºåº:
> **å¦‚æœ a å†™å…¥æ—¶æ²¡æœ‰çœ‹åˆ° b ,é‚£ä¹ˆ a å°±åœ¨ b ä¹‹å‰è¿è¡Œ**.
> æ‰€ä»¥å¯è§æ€§å°±è¡¨ç¤ºäº† instance ä¹‹é—´çš„é¡ºåº.
>
> å½“ç„¶è¿™ä¸ªæ€è·¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¦å¤æ‚ä¸€äº›, å› ä¸ºå¤šä¸ª replica ä¹‹é—´æ²¡æœ‰å•æœºä¸­çš„é”çš„ä¿æŠ¤,
> å¤šä¸ª replica ä¸ŠåŒä¸€ä¸ª instance çœ‹åˆ°çš„å…¶ä»– instance ä¹Ÿå¯èƒ½ä¸ä¸€æ ·.

æœ€ç»ˆ mmp3 ä¸­çš„ instance æ•°æ®ç»“æ„ç›¸æ¯” classic-paxos, å¤šäº†ä¸€ä¸ª`Deps`å­—æ®µ:
-  instance.Deps: çœ‹åˆ°äº†å“ªäº›å…¶ä»–çš„ instance.

```proto
message Ins {
    InsId          InsId

    Cmd            Val
    repeated int64 Deps // <--

    BallotNum      VBal // <--
    bool           Committed
}
```

`Deps` çš„å®ç°åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤çš„å˜åŒ–:

## Proposer é€‰æ‹© Deps çš„å€¼

åœ¨ä¸Šé¢ 1-RTT çš„ classic-paxos åŸºç¡€ä¸Š:

- åœ¨åˆå§‹åŒ– instance X çš„æ—¶å€™(ä¹Ÿå°±æ˜¯åˆ›å»º`X`å, åœ¨æœ¬åœ°replicaæ‰§è¡Œprepareçš„æ—¶å€™),
  å°†å½“å‰ replica ä¸Šæ‰€æœ‰çŸ¥é“å…¶å­˜åœ¨çš„ instance é›†åˆåˆå§‹åŒ–ä¸º`X.Deps`(åŒ…æ‹¬ replica ä¸Šèƒ½çœ‹åˆ°çš„æ‰€æœ‰ instance, ä»¥åŠè¿™äº› instance
  çœ‹åˆ°çš„ instance, è™½ç„¶é—´æ¥çœ‹åˆ°çš„ instance å¯èƒ½ä¸å­˜åœ¨äºå½“å‰ replica),

- æ‰§è¡Œ accept çš„æ—¶å€™, æœ€ç»ˆ`X.Deps`çš„å€¼ä¸º2æ¬¡ prepare è·å¾—çš„`Deps`çš„**å¹¶é›†**ä½œä¸º accept çš„å€¼.

ä¾‹å¦‚ instance `a4`, åœ¨åˆ›å»ºå®ƒçš„ replica ä¸Šå’Œè¢«å¤åˆ¶åˆ°çš„å¦ä¸€ä¸ª replica ä¸Šåˆ†åˆ«çœ‹åˆ°
`b2, c2` å’Œ `b1, c3`, å¯¹åº”å¾—åˆ°çš„2ä¸ª `a4.Deps` åˆ†åˆ«æ˜¯:
`[4, 2, 2]` å’Œ `[4, 1, 3]`:

```graphviz
digraph seen
{

    size="5,5";
    dpi=100;

    layout=dot
    rankdir=LR;
    ranksep=0.1;
    splines=ortho;

    nodesep=0.04;
    labelloc = "t"
    node [shape=plaintext, style=filled]
    node[width=0, height=0];
    node [shape=rect]
    edge[minlen=1]


    edge [weight=1000 style=invis color=dimgrey]

    e004 -> e014 -> e024 -> s04 -> e104 -> e114 -> e124
    e003 -> e013 -> e023 -> s03 -> e103 -> e113 -> e123
    e002 -> e012 -> e022 -> s02 -> e102 -> e112 -> e122
    e001 -> e011 -> e021 -> s01 -> e101 -> e111 -> e121

    rank=same {e004 -> e003 -> e002 -> e001}
    rank=same {e014 -> e013 -> e012 -> e011}
    rank=same {e024 -> e023 -> e022 -> e021}

    rank=same {e104 -> e103 -> e102 -> e101}
    rank=same {e114 -> e113 -> e112 -> e111}
    rank=same {e124 -> e123 -> e122 -> e121}


    e004 [label=a4, fillcolor="#ffe0d0"]
    e003 [label=a3, fillcolor="#ffe0d0"]
    e002 [label=a2, fillcolor="#ffe0d0"]
    e001 [label=a1, fillcolor="#ffe0d0"]

    e014 [label=b4, fillcolor="#ffffd0"]
    e013 [label=b3, fillcolor="#ffffd0"]
    e012 [label=b2, fillcolor="#ffffd0"]
    e011 [label=b1, fillcolor="#ffffd0"]

    e024 [label=c4, fillcolor="#d0ffd0"]
    e023 [label=c3, fillcolor="#d0ffd0"]
    e022 [label=c2, fillcolor="#d0ffd0"]
    e021 [label=c1, fillcolor="#d0ffd0"]


    e104 [label=a4, fillcolor="#ffe0d0"]
    e103 [label=a3, fillcolor="#ffe0d0"]
    e102 [label=a2, fillcolor="#ffe0d0"]
    e101 [label=a1, fillcolor="#ffe0d0"]

    e114 [label=b4, fillcolor="#ffffd0"]
    e113 [label=b3, fillcolor="#ffffd0"]
    e112 [label=b2, fillcolor="#ffffd0"]
    e111 [label=b1, fillcolor="#ffffd0"]

    e124 [label=c4, fillcolor="#d0ffd0"]
    e123 [label=c3, fillcolor="#d0ffd0"]
    e122 [label=c2, fillcolor="#d0ffd0"]
    e121 [label=c1, fillcolor="#d0ffd0"]


    s04 [style=invis]
    s03 [style=invis]
    s02 [style=invis]
    s01 [style=invis]

    // replica-1 Deps

    e004 [fillcolor="#a0b0e0"]
    e012 [fillcolor="#a0d0f0"]
    e022 [fillcolor="#a0d0f0"]

    e014 [style=invis]
    e013 [style=invis]
    e024 [style=invis]
    e023 [style=invis]

    edge [style="", arrowhead=none]
    e004 -> e012 -> e022[weight=0]

    // replica-2 Deps

    e104 [fillcolor="#a0b0e0"]
    e111 [fillcolor="#a0d0f0"]
    e123 [fillcolor="#a0d0f0"]

    e114 [style=invis]
    e113 [style=invis]
    e112 [style=invis]
    e124 [style=invis]

    edge [style="", arrowhead=none]
    e104 -> e111 -> e123[weight=0]
}

```

é‚£ä¹ˆ `a4` å°†ç”¨æ¥è¿è¡Œ accpet çš„ `Deps` å€¼å°±æ˜¯ `[4, 2, 3]`:

```graphviz
digraph seen
{

    size="5,5";
    dpi=100;

    layout=dot
    rankdir=LR;
    ranksep=0.1;
    splines=ortho;

    nodesep=0.04;
    labelloc = "t"
    node [shape=plaintext, style=filled]
    node[width=0, height=0];
    node [shape=rect]
    edge[minlen=1]


    edge [weight=1000 style=invis color=dimgrey]

    e004 -> e014 -> e024
    e003 -> e013 -> e023
    e002 -> e012 -> e022
    e001 -> e011 -> e021

    rank=same {e004 -> e003 -> e002 -> e001}
    rank=same {e014 -> e013 -> e012 -> e011}
    rank=same {e024 -> e023 -> e022 -> e021}

    e004 [label=a4, fillcolor="#ffe0d0"]
    e003 [label=a3, fillcolor="#ffe0d0"]
    e002 [label=a2, fillcolor="#ffe0d0"]
    e001 [label=a1, fillcolor="#ffe0d0"]

    e014 [label=b4, fillcolor="#ffffd0"]
    e013 [label=b3, fillcolor="#ffffd0"]
    e012 [label=b2, fillcolor="#ffffd0"]
    e011 [label=b1, fillcolor="#ffffd0"]

    e024 [label=c4, fillcolor="#d0ffd0"]
    e023 [label=c3, fillcolor="#d0ffd0"]
    e022 [label=c2, fillcolor="#d0ffd0"]
    e021 [label=c1, fillcolor="#d0ffd0"]


    // replica-1 Deps

    e004 [fillcolor="#a0b0e0"]
    e012 [fillcolor="#a0d0f0"]
    e023 [fillcolor="#a0d0f0"]

    e014 [style=invis]
    e013 [style=invis]
    e024 [style=invis]

    edge [style="", arrowhead=none]
    e004 -> e012 -> e023[weight=0]
}
```

> classic-paxos ä¸­è¦æ±‚ prepare é˜¶æ®µçœ‹åˆ°çš„å·²å­˜åœ¨çš„å€¼è¦ä½¿ç”¨,
> è€Œ mmp3 ä¸­å°†æ‰€æœ‰ prepare é˜¶æ®µçœ‹åˆ°çš„ `Deps` çš„å€¼åšäº†å¹¶é›†, 
> å®é™…ä¸Šå¹¶æ²¡æœ‰ç ´å paxos çš„çº¦æŸ,
> åªä¸è¿‡ classic-paxos å‡è®¾å®ƒçš„**å€¼**æ˜¯ä»»æ„çš„, ä¸ä¸€å®šå¯å–å¹¶é›†,
> mmp3 ä¸­å¯ä»¥æŠŠ prepare è¿‡ç¨‹ä¸­çœ‹åˆ°çš„ `Deps` çš„å€¼è®¤ä¸ºæ˜¯ `VBal` ä¸º 0 çš„ä¸€ä¸ªå€¼,
>
> è¯»è€…å¯ä»¥è‡ªè¡ŒéªŒè¯, å®ƒä¸ä¼šç ´å classic-paxos è¦æ±‚çš„ä»»ä½•çº¦æŸ.

å› ä¸º `X.Deps` çš„å€¼çš„ç¡®å®šä¹Ÿé€šè¿‡ paxos,
æ‰€ä»¥å¯ä»¥ä¿è¯æ¯ä¸ª replica ä¸Šçš„æ¯ä¸ª instance æœ€ç»ˆæäº¤çš„ `Deps` éƒ½æ˜¯ä¸€è‡´çš„.

è¿™æ—¶å†é€šè¿‡ä¸€ä¸ªç¡®å®šçš„ç®—æ³•ä½¿ç”¨æ¯ä¸ª instance `Deps`çš„å€¼æ¥å†³å®š apply çš„é¡ºåº,
å°±å¯ä»¥ä¿è¯å¤šä¸ª replica ä¸Šçš„ state machine æœ€ç»ˆçŠ¶æ€ä¸€è‡´.

ä»¥ä¸Šä¸¤ç‚¹æ»¡è¶³äº† apply ç®—æ³•çš„ç¬¬ä¸€ä¸ªè¦æ±‚: **Consistency**.
æ­¤å¤–, apply çš„é¡ºåºè¿˜éœ€æä¾›å¦å¤–ä¸€ä¸ªä¿è¯ **Linearizability**, å³:
å¦‚æœ propose A å‘ç”Ÿåœ¨ commit B ä¹‹å, é‚£ä¹ˆ A åº”è¯¥åœ¨ B ä¹‹åapply.

è¿™æ˜¯ä¸€ä¸ªç›´è§‰ä¸Šçš„è¦æ±‚: å¦‚æœä¸€ä¸ªå‘½ä»¤ `set x=1` å‘ç»™å­˜å‚¨ç³»ç»Ÿå¹¶è¿”å›OK(committed),
é‚£ä¹ˆè¿™ä¹‹åå‘ç»™å­˜å‚¨çš„ `get x` å‘½ä»¤, åº”è¯¥ä¸€å®šèƒ½çœ‹åˆ°`x=1`çš„å€¼.

> å®é™…ä¸Šxpè®¤ä¸ºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå…¨å±€èŒƒå›´å†…ä½¿ç”¨ç»å¯¹æ—¶é—´çš„å…ˆåå¹¶ä¸æ˜¯ä¸€ä¸ªç†æ€§çš„é€‰æ‹©.
> ä¸è¿‡å®ƒæ›´å®¹æ˜“è¢«ä¸šåŠ¡ä½¿ç”¨.

æ¥ä¸‹æ¥æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªç®—æ³•æ¥æ»¡è¶³**Linearizability**çš„è¦æ±‚:


# Apply ç®—æ³•: æœ‰ç¯æœ‰å‘å›¾ä¸­èŠ‚ç‚¹çš„å®šåº

## Interfering instance

mmp3 ä¸­è®¾å®š: ä»»æ„2ä¸ª instance éƒ½æ˜¯ interfering çš„,
å³, äº¤æ¢2ä¸ª instance çš„ apply é¡ºåºä¼šå¯¼è‡´ç»“æœä¸åŒ(è™½ç„¶å¯èƒ½æ˜¯å¯ä»¥äº’æ¢é¡ºåºçš„).

> epaxos ä¸­è®¤ä¸º set x=1 å’Œ set y=2 è¿™2ä¸ª instance
> å¯ä»¥äº’æ¢é¡ºåº, å› ä¸ºxçš„å€¼è·Ÿyçš„å€¼æ— å…³,
> ä½† set x=y å’Œ set y=2 è¿™2ä¸ª instance ä¸èƒ½äº’æ¢é¡ºåº apply, å› ä¸ºé¡ºåºçš„å˜åŒ–ä¼šäº§ç”Ÿä¸åŒçš„xçš„ç»“æœ.
> ä¹Ÿæ˜¯å› ä¸º epaxos éœ€è¦é€šè¿‡å‡å°‘ interfering çš„æ•°é‡æ¥å®ç°1ä¸ª RTT, æ‰€ä»¥æ‰æœ‰äº†è¿™ä¸ªè®¾è®¡.

åœ¨3 replica çš„ç³»ç»Ÿä¸­,  **mmp3 æœ‰æ— å†²çªéƒ½åªéœ€è¦1ä¸ª RTT**, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ— éœ€æ‹…å¿ƒ
interfering çš„ instance çš„å†²çªå¸¦æ¥çš„å¦ä¸€ä¸ªRTTå¼€é”€.
åªéœ€å‡è®¾ä»»æ„2ä¸ª instance éƒ½æ˜¯ interfering çš„, è¿™æ ·åå€’èƒ½ç®€åŒ–é—®é¢˜.


## Lemma-0: instance ä¹‹é—´çš„ä¾èµ–å…³ç³»

å®šä¹‰ A ä¾èµ– B, å³  `A â†’ B` ä¸º: `A.Deps âˆ‹ B`.

å› ä¸º mmp3 å‡å®šä»»æ„2ä¸ªinstanceéƒ½æ˜¯interferingçš„,
å¹¶ä¸”2ä¸ª instance æäº¤çš„ quorum å¿…ç„¶æœ‰äº¤é›†,
æ‰€ä»¥ä»»æ„2ä¸ª instance ä¹‹é—´è‡³å°‘æœ‰ä¸€ä¸ªä¾èµ–å…³ç³», å³, A, Bä¹‹é—´çš„å…³ç³»åªå¯èƒ½æ˜¯:

- A â†’ B
- B â†’ A
- A â†” B

> ä¾èµ–å…³ç³»æ„æˆä¸€ä¸ªå¯èƒ½å¸¦ç¯çš„æœ‰å‘å›¾, ä¾‹å¦‚æŒ‰ç…§ä»¥ä¸‹æ—¶é—´é¡ºåºæ‰§è¡Œ:
> - R0 propose a1, a1.Deps = [1, 0, 0],
> - R1 propose b1, b1.Deps = [0, 1, 0],
> - R0 send a1 to R1, a1.Deps = [1, 1, 0]
> - R1 send b1 to R0, b1.Deps = [1, 1, 0]
> - R0 commit a1
> - R1 commit b1
> 
> è¿™æ · a1 âˆˆ b1.Deps ä¸” b1 âˆˆ a1.Deps

ä¾èµ–å…³ç³»å¾ˆç›´è§‚, è¿™ä¸ªä¾èµ–å…³ç³»çš„å›¾ä¸­,
æˆ‘ä»¬å°†è¯•å›¾å¯»æ‰¾ä¸€ä¸ªæœ‰é™å¤§å°çš„é›†åˆæ¥å®ç°ä¸€ä¸ªæœ‰æ•ˆçš„ apply ç®—æ³•.


## Lemma-1: ç”¨Depsç¡®å®šLinearizability

é¦–å…ˆæˆ‘ä»¬æœ‰ä¸€ä¸ªå°ç»“è®º:

**å¦‚æœ A åœ¨ B commit ä¹‹åè¢« propose, é‚£ä¹ˆä¸€å®šæœ‰ A.Deps âŠƒ B.Deps**.

å› ä¸º B å¦‚æœ commit äº†,
é‚£ä¹ˆ `B.Deps`, ä¹Ÿå°±æ˜¯ B çœ‹åˆ°çš„æ‰€æœ‰å…¶ä»– instance çš„ id é›†åˆ, å°±å·²ç»å¤åˆ¶åˆ°äº†æŸä¸ª quorum.
é‚£ä¹ˆ A åœ¨è¿è¡Œ paxos çš„æ—¶å€™,ä¸€å®šä¼šçœ‹åˆ° B commit çš„ `B.Deps` çš„å€¼.

åˆå› ä¸º `A.Deps` æ˜¯2ä¸ªåœ¨ prepare é˜¶æ®µçœ‹åˆ°çš„ `Deps`çš„å€¼çš„å¹¶é›†, 
å› æ­¤ `A.Deps` ä¸€å®šåŒ…å«å…¨éƒ¨ `B.Deps` çš„instance.


äºæ˜¯å®ç° apply ç®—æ³•çš„æ€è·¯å°±æ˜¯:

- å¦‚æœ A.Deps âŠƒ B.Deps, å…ˆ apply B, å³å¯ä»¥ä¿è¯Linearizability.
- å…¶ä»–æƒ…å†µä¸‹, é€‰æ‹©ä½•ç§é¡ºåºéƒ½ä¸ä¼šç ´å Linearizability,
  æ‰€ä»¥ mmp3 ä¸­ä½¿ç”¨ instance çš„ (columnIndex, index) çš„å¤§å°æ’åºæ¥ç¡®å®š apply é¡ºåº.

> epaxos æä¾›äº†ä¸€ç§ç®€å•ç²—æš´çš„æ–¹æ³•æ¥åœ¨æœ‰ç¯å›¾ä¸­ç¡®å®š apply é¡ºåº:
> ä»å›¾ä¸­ä¸€ä¸ªèŠ‚ç‚¹å‡ºå‘:
> æ‰¾åˆ°æœ€å¤§è¿é€šå­å›¾(Strongly-Connected-Component or SCC)(æ²¡æœ‰å‡ºå‘è¾¹çš„ä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªSCC),
> ç„¶åæŒ‰ç…§èŠ‚ç‚¹, ä¹Ÿå°±æ˜¯ instance çš„æŸä¸ªå±æ€§(ä¾‹å¦‚epaxosä¸­ä½¿ç”¨(seq, instanceId)) æ¥æ’åºä¸€ä¸ªSCCä¸­çš„èŠ‚ç‚¹, å†æŒ‰é¡ºåº apply.
>
> epaxos çš„ SCC ç®—æ³•æœ‰ä¸ªé—®é¢˜, å°±æ˜¯ä¸€ä¸ª SCC å¯èƒ½æ— é™å¢å¤§, ä¾‹å¦‚ A commit
> ä¹‹å‰æœ‰å¦ä¸€ä¸ªinterfering çš„ instance B è¢« propose, ç„¶å B commit
> ä¹‹å‰åˆå‡ºç°interfering çš„ instance C...,
>
> é‚£ä¹ˆ epaxos çš„åšæ³•å°±æ— æ³•ä¿è¯åœ¨æœ‰é™æ—¶é—´å†…æ‰¾å‡º SCC.
>
> epaxos å»ºè®®ä¸­æ–­ä¸€å°æ®µæ—¶é—´çš„æ–° instance çš„ propose æ¥æ–­å¼€ SCC,
> è¿™ä¹Ÿæ˜¯ä¸å®¹æ˜“å®ç°çš„, å› ä¸ºå¿…é¡»åœ¨n-1ä¸ª replica åŒæ—¶ä¸­æ–­æ‰æœ‰æ•ˆ.
> åªè¦æœ‰2ä¸ª replica åœ¨æŒç»­çš„å†™å…¥æ–° instance, é‚£ä¹ˆå°±æœ‰å¯èƒ½é€ æˆæ— é™å¤§çš„ SCC.



## Lemma-2: ä¸éœ€è¦ SCC

ç¬¬2ä¸ªå°ç»“è®º:

**å¦‚æœ A, Bä¸å±äºåŒä¸€ä¸ª SCC, å³, A âˆˆ SCCâ‚ B âˆ‰ SCCâ‚, é‚£ä¹ˆ**:
- **A â†’ B â‡’ A.Deps âŠƒ B.Deps**.
- **B â†’ A â‡’ B.Deps âŠƒ A.Deps**.

å› ä¸ºæ ¹æ® Lemma-0,
ä»»æ„2ä¸ª instance è‡³å°‘æœ‰ä¸€ä¸ªä¾èµ–å…³ç³»,
å¦‚æœX âˆˆ B.Deps ä¸” X âˆ‰ A.Deps,
é‚£ä¹ˆå¿…ç„¶æœ‰ X â†’ A, å¯¼è‡´ A â†’ B â†’ X â†’ A æˆä¸ºä¸€ä¸ªSCC.

å› æ­¤, **ä¸è®ºA, Bæ˜¯å¦åœ¨ä¸€ä¸ª SCC ä¸­, ä¿è¯ Linearizability
çš„æ¡ä»¶éƒ½å¯ä»¥ç”¨ Deps æ¥ç¡®å®š, 
æ‰€ä»¥æˆ‘ä»¬çš„ç®—æ³•ä¸å¿…å¯»æ‰¾ SCC , åªéœ€éå†ä¾èµ–å…³ç³»**.


## å‡å°éå†æ•°é‡: åªéœ€è€ƒè™‘æœ€è€çš„ instance

ä»¥ä¸Š apply ç®—æ³•è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ä¸ºæœ€å¤šåªè€ƒè™‘3ä¸ª instnace çš„æ–¹å¼:

å‡è®¾ a1, a2 æ˜¯ column-A ä¸Šç›¸é‚»çš„2ä¸ª instance, é‚£ä¹ˆä¸€å®šæœ‰ `a1 âˆˆ a2.Deps`.
æ ¹æ® apply ç®—æ³•è®¾è®¡, `a1.Deps âŠƒ a2.Deps` ä¸€å®šä¸æˆç«‹, a2 ä¸€å®šä¸ä¼šåœ¨ a1 ä¹‹å‰ apply:
- å¦‚æœ a1 ä¸ä¾èµ– a2, a1 ä¸€å®šå…ˆapply,
- å¦‚æœ a1 ä¾èµ– a2, ä½† a1 çš„ `(a3.columnIndex, a3.index)` è¾ƒå°, æ‰€ä»¥ a1 ä¹Ÿä¸€å®šä¼šåœ¨ a2 ä¹‹å‰apply.

å› æ­¤åªéœ€è€ƒè™‘æ¯ä¸ª column ä¸Šæœ€è€çš„ä¸€ä¸ªæœª apply çš„ instance å°±å¯ä»¥æ‰¾å‡ºä¸‹ä¸€ä¸ª apply
çš„ instance.
åœ¨ mmp3 ä¸­, æœ€å¤šæœ‰3ä¸ª(ä½†ç®—æ³•æœ¬èº«ä¸é™äº3).


## Lemma-3: Deps é›†åˆæ•°é‡æ¥å†³å®š Linearizability

å®šä¹‰ä¸€ä¸ªä¾èµ–æ•°é‡:
**|X.Deps| ä¸º X ä¾èµ–çš„, æœª apply çš„ instance çš„æ‰€åœ¨ column çš„æ•°é‡**.

ä¾‹å¦‚: a3.Deps = [3, 2, 2]:
- å¦‚æœå®Œæˆ apply çš„ instance æ˜¯ [2, 1, 1], å³ a1, a2, b1, c1,
  é‚£ä¹ˆæ­¤æ—¶a3åœ¨3ä¸ª column ä¸Šéƒ½ä¾èµ–ä¸€ä¸ªæœª apply çš„ instance: `|a3.Deps|=3`.

- ä¹‹åå¦‚æœc2 è¢« apply äº†, é‚£ä¹ˆ`|a3.Deps| = 2`.

```graphviz
digraph seen
{

    size="10,10";
    dpi=100;

    layout=dot
    rankdir=LR;
    ranksep=0.1;
    splines=ortho;

    nodesep=0.04;
    labelloc = "t"
    node [shape=plaintext, style=filled]
    node[width=0, height=0];
    node [shape=rect]
    edge[minlen=1]
    graph [labelloc = "b" ];


    edge [weight=1000 style=invis color=dimgrey]

    e004 -> e014 -> e024
    e003 -> e013 -> e023
    e002 -> e012 -> e022
    e001 -> e011 -> e021
    e000 -> e010 -> e020

    rank=same {e004 -> e003 -> e002 -> e001 -> e000}
    rank=same {e014 -> e013 -> e012 -> e011 -> e010}
    rank=same {e024 -> e023 -> e022 -> e021 -> e020}


    e004 [label=a4, fillcolor="#ffe0d0"]
    e003 [label=a3, fillcolor="#ffe0d0"]
    e002 [label=a2, fillcolor="#ffe0d0"]
    e001 [label=a1, fillcolor="#ffe0d0"]

    e014 [label=b4, fillcolor="#ffffd0"]
    e013 [label=b3, fillcolor="#ffffd0"]
    e012 [label=b2, fillcolor="#ffffd0"]
    e011 [label=b1, fillcolor="#ffffd0"]

    e024 [label=c4, fillcolor="#d0ffd0"]
    e023 [label=c3, fillcolor="#d0ffd0"]
    e022 [label=c2, fillcolor="#d0ffd0"]
    e021 [label=c1, fillcolor="#d0ffd0"]

    e000 [label="A"]
    e010 [label="B"]
    e020 [label="C"]


    // next apply:

    e003 [fillcolor="#a0d0f0"]
    e012 [fillcolor="#a0d0f0"]
    e022 [fillcolor="#a0d0f0"]

    // applied:

    e002 [fillcolor="#90a0d0"]
    e001 [fillcolor="#90a0d0"]
    e011 [fillcolor="#90a0d0"]
    e021 [fillcolor="#90a0d0"]

    edge [style="", arrowhead=none]
    e003 -> e012 -> e022[weight=0]

}
```

è¿™é‡Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ä¸€ä¸ªç»“è®º:
`A.Deps âŠƒ B.Deps â‡’ |A.Deps| > |B.Deps|`.


æœ€ç»ˆ apply ç®—æ³•ä¸º:

**æ‰¾åˆ°ä¸€ä¸ª column ä¸Šä¸‹ä¸€ä¸ªå·² commit, æœª apply çš„ instance X,
éå†`X.Deps`, å¾—åˆ°æœªéå†è¿‡çš„ column ä¸Šçš„æœ€è€çš„æœª apply çš„ instance,
éå†ç»“æŸå, é€‰æ‹©(|X.Deps|, X.columnIndex) æœ€å°çš„ä¸€ä¸ªapply åˆ° state machine**.

ä¸‹æ¬¡å† apply æ—¶, é‡æ–°æ„é€ è¿™ä¸ªå›¾, æ‰¾åˆ°ç¬¬äºŒä¸ªè¦æ‰§è¡Œçš„ instance.

> å¿…é¡»é‡æ–°éå†, å› ä¸ºä¹‹å‰æ’åºç¬¬2çš„ instance, åœ¨æ–°åŠ å…¥ä¸€ä¸ª instance ä¹‹åå¯èƒ½è¿˜æ˜¯ç¬¬2.

è¿™æ ·, æ¯ä¸ª replica ä¸Š, committed çš„ instance çš„ Deps å€¼éƒ½ä¸€æ ·,
æœ€è€çš„3ä¸ª instance æ„æˆçš„ä¾èµ–å›¾ä¹Ÿéƒ½ä¸€æ ·,
äºæ˜¯æ‰¾å‡ºç¬¬1ä¸ª apply çš„ instance ä¹Ÿä¸€æ ·,
é‡å¤è¿™ä¸ªæ­¥éª¤, æ‰¾å‡ºçš„ç¬¬2ä¸ª apply çš„ instance ä¹Ÿä¸€æ ·...
æœ€ç»ˆæ¯ä¸ª replica ä¸Šçš„ state machine è¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€, ä¿è¯äº† **Consistency**.


## Apply æ‰§è¡Œçš„ä¾‹å­


ä¾‹å¦‚ä»¥ä¸‹ 20 ä¸ª instance çš„ Deps å…³ç³»æ˜¯ä¸€ä¸ªæœ‰å‘å›¾, æœ€ç»ˆç”Ÿæˆçš„ apply
é¡ºåºæ˜¯ä¸€ä¸ªå•å‘è·¯å¾„:

```graphviz
digraph x
{
node [shape=plaintext]
rankdir=LR
X0X0 [ label="a0"]
X0X0 -> X1X1 [ color="#aaaadd"]
X0X0 -> X2X3 [ color="#aaaadd"]
X0X1 [ label="a1"]
X0X1 -> X0X0 [ color="#aaaadd"]
X0X1 -> X1X1 [ color="#aaaadd"]
X0X1 -> X2X3 [ color="#aaaadd"]
X0X2 [ label="a2"]
X0X2 -> X0X1 [ color="#aaaadd"]
X0X2 -> X1X3 [ color="#aaaadd"]
X0X2 -> X2X3 [ color="#aaaadd"]
X0X3 [ label="a3"]
X0X3 -> X0X2 [ color="#aaaadd"]
X0X3 -> X1X3 [ color="#aaaadd"]
X0X3 -> X2X3 [ color="#aaaadd"]
X0X4 [ label="a4"]
X0X4 -> X0X3 [ color="#aaaadd"]
X0X4 -> X1X4 [ color="#aaaadd"]
X0X4 -> X2X3 [ color="#aaaadd"]
X0X5 [ label="a5"]
X0X5 -> X0X4 [ color="#aaaadd"]
X0X5 -> X1X4 [ color="#aaaadd"]
X0X5 -> X2X3 [ color="#aaaadd"]
X0X6 [ label="a6"]
X0X6 -> X0X5 [ color="#aaaadd"]
X0X6 -> X1X4 [ color="#aaaadd"]
X0X6 -> X2X5 [ color="#aaaadd"]
{ rank=same X0X0 X0X1 X0X2 X0X3 X0X4 X0X5 X0X6 }
X1X0 [ label="b0"]
X1X0 -> X2X3 [ color="#aaaadd"]
X1X1 [ label="b1"]
X1X1 -> X0X0 [ color="#aaaadd"]
X1X1 -> X1X0 [ color="#aaaadd"]
X1X1 -> X2X3 [ color="#aaaadd"]
X1X2 [ label="b2"]
X1X2 -> X0X3 [ color="#aaaadd"]
X1X2 -> X1X1 [ color="#aaaadd"]
X1X2 -> X2X3 [ color="#aaaadd"]
X1X3 [ label="b3"]
X1X3 -> X0X4 [ color="#aaaadd"]
X1X3 -> X1X2 [ color="#aaaadd"]
X1X3 -> X2X3 [ color="#aaaadd"]
X1X4 [ label="b4"]
X1X4 -> X0X4 [ color="#aaaadd"]
X1X4 -> X1X3 [ color="#aaaadd"]
X1X4 -> X2X3 [ color="#aaaadd"]
X1X5 [ label="b5"]
X1X5 -> X0X6 [ color="#aaaadd"]
X1X5 -> X1X4 [ color="#aaaadd"]
X1X5 -> X2X4 [ color="#aaaadd"]
{ rank=same X1X0 X1X1 X1X2 X1X3 X1X4 X1X5 }
X2X0 [ label="c0"]
X2X0 -> X1X0 [ color="#aaaadd"]
X2X1 [ label="c1"]
X2X1 -> X2X0 [ color="#aaaadd"]
X2X2 [ label="c2"]
X2X2 -> X1X0 [ color="#aaaadd"]
X2X2 -> X2X1 [ color="#aaaadd"]
X2X3 [ label="c3"]
X2X3 -> X1X0 [ color="#aaaadd"]
X2X3 -> X2X2 [ color="#aaaadd"]
X2X4 [ label="c4"]
X2X4 -> X0X5 [ color="#aaaadd"]
X2X4 -> X1X4 [ color="#aaaadd"]
X2X4 -> X2X3 [ color="#aaaadd"]
X2X5 [ label="c5"]
X2X5 -> X0X6 [ color="#aaaadd"]
X2X5 -> X1X5 [ color="#aaaadd"]
X2X5 -> X2X4 [ color="#aaaadd"]
X2X6 [ label="c6"]
X2X6 -> X0X6 [ color="#aaaadd"]
X2X6 -> X1X5 [ color="#aaaadd"]
X2X6 -> X2X5 [ color="#aaaadd"]
{ rank=same X2X0 X2X1 X2X2 X2X3 X2X4 X2X5 X2X6 }
X2X0 -> X1X0 [ color="#444444", penwidth=3]
X2X1 -> X2X0 [ color="#444444", penwidth=3]
X2X2 -> X2X1 [ color="#444444", penwidth=3]
X2X3 -> X2X2 [ color="#444444", penwidth=3]
X0X0 -> X2X3 [ color="#444444", penwidth=3]
X1X1 -> X0X0 [ color="#444444", penwidth=3]
X0X1 -> X1X1 [ color="#444444", penwidth=3]
X0X2 -> X0X1 [ color="#444444", penwidth=3]
X0X3 -> X0X2 [ color="#444444", penwidth=3]
X1X2 -> X0X3 [ color="#444444", penwidth=3]
X0X4 -> X1X2 [ color="#444444", penwidth=3]
X1X3 -> X0X4 [ color="#444444", penwidth=3]
X1X4 -> X1X3 [ color="#444444", penwidth=3]
X0X5 -> X1X4 [ color="#444444", penwidth=3]
X2X4 -> X0X5 [ color="#444444", penwidth=3]
X0X6 -> X2X4 [ color="#444444", penwidth=3]
X1X5 -> X0X6 [ color="#444444", penwidth=3]
X2X5 -> X1X5 [ color="#444444", penwidth=3]
X2X6 -> X2X5 [ color="#444444", penwidth=3]
}
```



# RPCçš„è¶…æ—¶é‡è¯•

paxos å‡è®¾å·¥ä½œåœ¨ä¸€ä¸ªç½‘ç»œä¸å¯é çš„ç¯å¢ƒä¸­, åœ¨æ ‡å‡†çš„å®ç°ä¸­, å¦‚æœæŸä¸ªè¯·æ±‚è¶…æ—¶,
ç†è®ºä¸Šåº”è¯¥è¿›è¡Œé‡è¯•. mmp3 çš„è¿è¡Œç¯å¢ƒå‡è®¾ä¸ classic-paxos ä¸€æ ·, ä¹Ÿéœ€è¦å¯¹è¶…æ—¶é‡è¯•.
è¿™é‡Œè·Ÿ classic-paxos æœ‰ä¸€ç‚¹å·®åˆ«, å°±æ˜¯**é‡è¯•æ—¶å¿…é¡»æå‡è‡ªå·±çš„ BallotNum**,
é‡æ–°åœ¨æœ¬åœ°æ‰§è¡Œ prepare, å†ç”¨æ–°çš„ BallotNum é‡å‘RPC.

è¿™æ˜¯å› ä¸º prepare è¿‡ç¨‹ä¸­, åœ¨æ¯ä¸ª replica ä¸Šå¾—åˆ°çš„ `Deps` çš„å€¼å¯èƒ½ä¸åŒ.

ä¾‹å¦‚R0 propose çš„ instance X, åœ¨ R1 å’Œ R2 ä¸Šçš„ prepare å,
å¯èƒ½ä¼šåˆ†åˆ«å¾—åˆ°ä¸åŒçš„`X.Deps`çš„å€¼(2ä¸ªreplicaåŒ…å«çš„instanceä¸åŒ).
ä½¿ç”¨åŒä¸€ä¸ª BallotNum æ— æ³•åŒºåˆ†å“ªä¸€ä¸ªæ‰æ˜¯æœ€æ–°çš„å€¼.
é‡è¯•æå‡BallotNum, æ‰èƒ½ä¿è¯æœ€åè¢«ç¡®å®šçš„å€¼èƒ½è¢«è¯†åˆ«å‡ºæ¥.

ä¸€ä¸ªä¿®å¤è¿›ç¨‹(ä¾‹å¦‚R0å®•æœºå, R1æˆ–R2éƒ½å¯ä»¥é‡æ–°è¿è¡Œ paxos è¿›è¡Œä¿®å¤), åœ¨R1 å’Œ R2ä¸Šçœ‹åˆ°2ä¸ªä¸åŒ BallotNum çš„ X,
é‚£ä¹ˆè¯´æ˜è¾ƒå° BallotNum çš„ `X` æ²¡æœ‰æˆåŠŸè¿”å›åº”ç­”ç»™ R0, R0 æ”¾å¼ƒäº†å®ƒ, å¹¶è¿›è¡Œäº†é‡è¯•.
è¿™æ—¶åªéœ€è€ƒè™‘è¾ƒå¤§ BallotNum çš„ instance , å®ƒæ˜¯å”¯ä¸€å¯èƒ½è¢« R0 commit çš„.

ä»¥ä¸‹æ˜¯é‡è¯•è¿‡ç¨‹:

```mermaid
sequenceDiagram
    participant R0
    participant R1
    participant R2


    Note over R0: NewProposer: P(bal=1)

    Note over R0: Prepared: last_bal=1

    R0->>+R1: send P(bal=1)
    Note over R1: Prepared: last_bal=1
    Note over R1: Accepted: last_bal=1,vbal=1,V,Seen_1
    R1->>-R0: timeout

    R0->>+R2: send P(bal=2)
    Note over R2: Prepared: last_bal=2
    Note over R2: Accepted: last_bal=2,vbal=2,V,Seen_2
    R2->>-R0: OK
```


# recovery

ä¸Šé¢æåˆ°çš„é‡è¯•æœºåˆ¶ä¸ºæ­£ç¡®çš„recoveryåšå¥½äº†å‡†å¤‡:
å½“ R0 å‘èµ·ä¸€è½® paxos åå¹¶å®•æœºäº†, R1 æˆ– R2 éƒ½å¯ä»¥é€šè¿‡è¶…æ—¶æ£€æŸ¥æ¥å‘ç°è¿™ä¸ªé—®é¢˜å¹¶ä¿®å¤æœª commit çš„ instance .
è¦ä¿®å¤çš„å†…å®¹ä¾æ—§æ˜¯2ä¸ª:  instance è¦æ‰§è¡Œçš„å‘½ä»¤ Val , ä»¥åŠ instance çœ‹åˆ°å“ªäº›å…¶ä»–çš„ instance: Deps.

å› ä¸ºè¿™2ä¸ªå€¼éƒ½æ˜¯é€šè¿‡ classic-paxos æ¥ç¡®ç«‹çš„, ä¿®å¤è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•, æå‡ BallotNum å†è¿è¡Œä¸€æ¬¡ paxos å°±å¯ä»¥äº†.
ç›¸å½“äºå°† R0 çš„leadership æŠ¢èµ°èµ‹äºˆç»™äº†å¦ä¸€ä¸ª replica.


# ä»£ç å’Œæµ‹è¯•

git repo [mmp3][repo-mmp3] æ˜¯ä¸€ä»½æœ¬æ–‡ä»‹ç»çš„ multi-master çš„ä¸‰å‰¯æœ¬å®ç°(mmp3 åˆ†æ”¯),
å…¶ä¸­ä¸»è¦çš„ server ç«¯ instance æäº¤çš„é€»è¾‘å®ç°åœ¨`mmp.go`,
apply ç®—æ³•å®ç°åœ¨`apply_*`ä¸­.

ä»£ç ä¸­é™¤äº†åŸºæœ¬çš„å•å…ƒæµ‹è¯•, æœ€ä¸»è¦çš„æ˜¯:
`Test_set_get` å¯¹ä¸€ä¸ªä¸‰å‰¯æœ¬é›†ç¾¤è¿›è¡Œéšæœºè¯»å†™å‹æµ‹,
è¿™ä¸ªæµ‹è¯•ä¸­æ¨¡æ‹Ÿå‘é€å’Œæ¥å—çš„ç½‘ç»œé”™è¯¯(å„20%å‡ ç‡), åœ¨è¿™ç§æƒ…å†µä¸‹, æ£€æŸ¥:
- å…¨éƒ¨å†™è¯·æ±‚éƒ½æäº¤
- 3ä¸ª replica çš„ instance ä¸€è‡´
- 3ä¸ª replica ä¸Š apply é¡ºåºä¸€è‡´, ä»¥åŠæœ€ç»ˆ state machine ä¸­çš„çŠ¶æ€ä¸€è‡´.


# Limitation

mmp3 è®¾è®¡ä¸Šåªæ”¯æŒ3èŠ‚ç‚¹ç³»ç»Ÿ, å…¶æ¬¡è¿™ä¸ªå®ç°ä¸­ä¸åŒ…å«æˆå‘˜å˜æ›´å®ç°.


# æ€»ç»“

mmp3 æ˜¯ä¸€ä¸ªå®Œå…¨å¯¹ç­‰çš„è®¾è®¡å®ç°çš„multi-master consensus.
ä¹‹å‰åœ¨è¯•å›¾åŸºäº epaxos å®ç°ä¸€ä¸ª multi-master çš„å­˜å‚¨,
ä¸­é—´å´å‘ç°å‡ å¤„ä¸æ˜“ä¿®å¤çš„é—®é¢˜(å¼€å§‹è¿˜æœ‰å‡ ä¸ªå®¹æ˜“ä¿®å¤çš„é—®é¢˜),
äºæ˜¯æ‰“ç®—è‡ªå·±è®¾è®¡ä¸€å¥—.


æœŸå¾…ä¸å¯¹è¿™ä¸ªæ–¹å‘æ„Ÿå…´è¶£å„è·¯ç¥ä»™äº¤æµè›‹é€¼~
