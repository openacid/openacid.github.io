<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.17.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>掐指算算: 你的CDN多花了几百万? - OpenACID Blog</title>
<meta name="description" content="在上篇互联网中对象访问频率的91分布我们通过90%的流量由10%的内容产生这句经验描述，得出了访问频率的zipf模型:CDN (Content delivery network)就是一个典型的符合zipf分布的缓存系统:将缓存服务部署在距离用户最近的上百个地区（CDN边缘机房），当用户需要访问热门内容时，只需在边缘机房读取，以此达到性能优化。因为符合zipf模型，所以，如果一个边缘机房的容量对全量数据的占比变化1%，会带来每年数十万元的成本变化。一个中等规模的CDN系统，调优前后，可能会有每年几百万的成本差别。本文从原理到实践跟大家一起分析下CDN的成本构成，以及zipf如何影响成本。本文结构">


  <meta name="author" content="张炎泼(xp)">


<meta property="og:type" content="article">
<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="OpenACID Blog">
<meta property="og:title" content="掐指算算: 你的CDN多花了几百万?">
<meta property="og:url" content="http://localhost:4000/tech/cdn/">


  <meta property="og:description" content="在上篇互联网中对象访问频率的91分布我们通过90%的流量由10%的内容产生这句经验描述，得出了访问频率的zipf模型:CDN (Content delivery network)就是一个典型的符合zipf分布的缓存系统:将缓存服务部署在距离用户最近的上百个地区（CDN边缘机房），当用户需要访问热门内容时，只需在边缘机房读取，以此达到性能优化。因为符合zipf模型，所以，如果一个边缘机房的容量对全量数据的占比变化1%，会带来每年数十万元的成本变化。一个中等规模的CDN系统，调优前后，可能会有每年几百万的成本差别。本文从原理到实践跟大家一起分析下CDN的成本构成，以及zipf如何影响成本。本文结构">







  <meta property="article:published_time" content="2019-11-21T00:00:00+08:00">





  

  


<link rel="canonical" href="http://localhost:4000/tech/cdn/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "OpenACID-分布式研究小院",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="OpenACID Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="apple-touch-icon" sizes="180x180"    href="/assets/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">
<link rel="manifest"                            href="/assets/images/favicon/site.webmanifest">

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo/icon-lemon-margin.png" alt=""></a>
        
        <a class="site-title" href="/">
          OpenACID Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="https://github.com/orgs/openacid/people" >About Us</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">切换菜单</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">
  
  
  <p>

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/author/xp.jpg" alt="张炎泼(xp)" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">张炎泼(xp)</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>正在学画画, 主业是码农</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">关注</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://drmingdrmer.github.io/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i> 个人博客</a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/drmingdrmer" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://www.weibo.com/drdrxp" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-weibo" aria-hidden="true"></i> Weibo
          </a>
        </li>
      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>

  </p>
  
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="掐指算算: 你的CDN多花了几百万?">
    <meta itemprop="description" content="在上篇互联网中对象访问频率的91分布我们通过90%的流量由10%的内容产生这句经验描述，得出了访问频率的zipf模型:CDN (Content delivery network)就是一个典型的符合zipf分布的缓存系统:将缓存服务部署在距离用户最近的上百个地区（CDN边缘机房），当用户需要访问热门内容时，只需在边缘机房读取，以此达到性能优化。因为符合zipf模型，所以，如果一个边缘机房的容量对全量数据的占比变化1%，会带来每年数十万元的成本变化。一个中等规模的CDN系统，调优前后，可能会有每年几百万的成本差别。本文从原理到实践跟大家一起分析下CDN的成本构成，以及zipf如何影响成本。本文结构">
    <meta itemprop="datePublished" content="November 21, 2019">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">掐指算算: 你的CDN多花了几百万?
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 分钟阅读

</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> 本文目录</h4></header>
              <ul class="toc__menu">
  <li><a href="#本文结构">本文结构</a></li>
  <li><a href="#文件访问频率的分布规律">文件访问频率的分布规律</a></li>
  <li><a href="#cdn成本构成">CDN成本构成</a></li>
  <li><a href="#确定业务参数">确定业务参数</a></li>
  <li><a href="#确定业务模型-拟合zipf曲线">确定业务模型-拟合zipf曲线</a></li>
  <li><a href="#通过zipf建立cdn边缘容量和回源率的关系">通过zipf建立CDN边缘容量和回源率的关系</a></li>
  <li><a href="#确定it设施单位成本">确定IT设施单位成本</a></li>
  <li><a href="#找出最优配置">找出最优配置</a></li>
  <li><a href="#总结">总结</a></li>
</ul>
            </nav>
          </aside>
        
        <p>在上篇
<a href="/tech/zipf">互联网中对象访问频率的91分布</a>
我们通过
<code class="highlighter-rouge">90%的流量由10%的内容产生</code>
这句经验描述，
得出了访问频率的<a href="https://en.wikipedia.org/wiki/Zipf%27s_law">zipf</a>模型:</p>

<img src="/publish/cdn/images/f_k_=_c_k_s-1396bdc4d1ac3bd10b1f0b860cbcabba.png" style="display: block; margin: 0 auto 1.3em auto" alt="f(k) = c/k^s"/>

<p>CDN (<a href="https://en.wikipedia.org/wiki/Content_delivery_network">Content delivery network</a>)
就是一个典型的符合zipf分布的缓存系统:
将缓存服务部署在距离用户最近的上百个地区（CDN边缘机房），
当用户需要访问热门内容时，只需在边缘机房读取，以此达到性能优化。</p>

<p>因为符合zipf模型，
所以，如果一个边缘机房的容量对全量数据的占比变化1%，<strong>会带来每年数十万元的成本变化</strong>。
一个中等规模的CDN系统，调优前后，<strong>可能会有每年几百万的成本差别</strong>。</p>

<p>本文从原理到实践跟大家一起分析下CDN的成本构成，以及zipf如何影响成本。</p>

<h1 id="本文结构">本文结构</h1>

<p><img src="/post-res/cache-hit/bigmap.jpg" alt="xxx" /></p>

<!--more-->

<h1 id="文件访问频率的分布规律">文件访问频率的分布规律</h1>

<p>按照前文
<a href="/tech/zipf">互联网中对象访问频率的91分布</a>
中介绍，
下图是从真实业务中提取的1000个URL访问次数，
按照访问次数从高到低进行排序的zipf曲线:</p>

<p><img src="/post-res/cache-hit/1kfile.png" alt="xxx" /></p>

<center>图1 访问频率分布</center>

<p>基于上图所呈现的访问热度分布，CDN边缘机房会缓存最热的文件
(对应图中橘黄色部分)，
为用户提供更好的访问质量，
而剩下蓝色部分不太频繁被访问的文件，
则按照正常的方式回源站拉取，再返回给用户。</p>

<p>于是就有了由存储/回源构成的CDN的成本:</p>

<h1 id="cdn成本构成">CDN成本构成</h1>

<p>构成CDN的成本主要由2部分组成:</p>

<ul>
  <li>边缘机房中用于存储热文件(橘黄色)的服务器开销;</li>
  <li>拉取本地不存在的冷文件(蓝色)时，访问内容源站(存储全量数据)的带宽开销。</li>
</ul>

<p>显然边缘存储量越大，可缓存的内容就越多，
回源率(回源下载带宽/业务总下载带宽)就会越低，因此:</p>

<ul>
  <li>边缘存储成本上升，会带来回源带宽成本下降。</li>
  <li>反之边缘存储成本下调，则会带来回源成本的上升。</li>
</ul>

<p>接下来我们通过3个步骤，找到一个合适的边缘容量，<strong>让存储和带宽的成本总和达到一个极小值</strong>:</p>

<ul>
  <li>量化业务参数;</li>
  <li>确定业务的模型，也就是zipf中的参数;</li>
  <li>根据单位成本找出业务场景中的最优边缘容量，以及其对应的最低成本。</li>
</ul>

<h1 id="确定业务参数">确定业务参数</h1>

<p>一个假想的业务场景和CDN服务配置如下:</p>

<ul>
  <li>每个CDN边缘机房对外提供的日常下载总带宽: <code class="highlighter-rouge">20Gbps</code>，</li>
  <li>源站中所有文件的<strong>总量</strong><code class="highlighter-rouge">n</code>: <code class="highlighter-rouge">7200TB</code>，</li>
  <li>边缘机房的存储容量占源站文件总量的比值: <code class="highlighter-rouge">e</code>(edge)，例如(图1)中，<code class="highlighter-rouge">e=10%</code>，每个边缘机房能存储1/10的内容。</li>
  <li>回源率<code class="highlighter-rouge">b</code>(backsource) 是边缘机房消耗的回源带宽跟这个边缘机房下载带宽的比值，例如(图1)中，<code class="highlighter-rouge">e=10%</code>时，<code class="highlighter-rouge">b=6%</code>。</li>
</ul>

<p><img src="/post-res/cache-hit/cdn-arch.jpg" alt="xxx" /></p>

<p>其中下载带宽和文件总量<code class="highlighter-rouge">n</code>是业务属性;
<code class="highlighter-rouge">e</code>和<code class="highlighter-rouge">b</code>是CDN的属性，不取决于业务，是由CDN提供商选择，并最终决定成本的因素。</p>

<blockquote>
  <p><code class="highlighter-rouge">e</code>，边缘容量
对应(图1)中橘黄色部分的x方向的<strong>宽度</strong>，图中<code class="highlighter-rouge">e</code>的值是10%。</p>

  <p><code class="highlighter-rouge">b</code> 对应(图1)中的蓝色部分，
是需要回源的请求，在(图1)中，<code class="highlighter-rouge">b</code>的值是蓝色部分的<strong>访问次数之和</strong>(不同于<code class="highlighter-rouge">e</code>，不是宽度)，
跟所有文件总访问次数之和的比值。</p>
</blockquote>

<h1 id="确定业务模型-拟合zipf曲线">确定业务模型-拟合zipf曲线</h1>

<p>业务场景确定后，找出最佳成本的第一步是为这个热度分布曲线建立模型，
以便后面的计算。
根据我们上一篇中介绍过的
<a href="/tech/zipf#%E5%A6%82%E4%BD%95%E5%B0%86%E8%AE%BF%E9%97%AE%E8%AE%A1%E6%95%B0%E8%BD%AC%E6%8D%A2%E6%88%90%E5%AF%B9%E5%BA%94%E7%9A%84zipf%E5%88%86%E5%B8%83%E7%9A%84%E5%85%AC%E5%BC%8F">转换成对应的zipf分布的公式</a>
的方法，找出zipf曲线的2个参数:</p>

<p>把x，y轴分别取对数后，图像会呈现一个线性关系:</p>

<img src="/publish/cdn/images/log_f_k_=_log_c_-_s_times_log_k_-195d8e7b30cb589b7e96128b1c359698.png" style="display: block; margin: 0 auto 1.3em auto" alt="log(f(k)) = log(c) - s \times log(k)"/>

<p><img src="/post-res/cache-hit/1kloglog-regression.png" alt="xxx" /></p>

<center>(图2) 取对数后呈现线性关系</center>

<p>然后通过<a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E9%A1%B9%E5%BC%8F%E5%9B%9E%E5%BD%92">多项式回归</a>，对(图2)中的点拟合一条直线，就可以得到<code class="highlighter-rouge">c</code>和<code class="highlighter-rouge">s</code>。</p>

<p>例如我们使用预先准备好的url计数文件
<a href="/post-res/cache-hit/file-access-count.txt">file-access-count.txt</a>
作为例子，
使用这个
<a href="/post-res/cache-hit/find-zipf.py">find-zipf.py</a>
脚本来拟合可以得到:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> python2 find-zipf.py
6.796073 - 0.708331x
</code></pre></div></div>

<p>再分别对两边取指数，就从日志中得到了zipf 曲线的参数:
<strong>第k热的对象和它被访问次数的关系</strong>:</p>

<img src="/publish/cdn/images/f_k_=_894_k_0_708331_-ecbea0e8911157baa1f1171c3e680fcf.png" style="display: block; margin: 0 auto 1.3em auto" alt="f(k) =
894/
k^{0.708331}"/>

<p>其中<code class="highlighter-rouge">s</code>的值 <code class="highlighter-rouge">s=0.708331</code>是我们后面计算需要用到的。</p>

<blockquote>
  <p>zipf中的<code class="highlighter-rouge">c</code>参数在我们的分析中没有被使用到，
因为<code class="highlighter-rouge">c</code>只决定了文件被访问频率的分布的绝对值，而不影响分布的相对值。
而我们要考察的回源率<code class="highlighter-rouge">b</code>，是一个比值，它只跟频率分布的相对值有关。</p>
</blockquote>

<h1 id="通过zipf建立cdn边缘容量和回源率的关系">通过zipf建立CDN边缘容量和回源率的关系</h1>

<p>确定了zipf方程后，
我们就可以准确的给出CDN系统中以下3个关键变量的关系:</p>

<ul>
  <li>全量文件<code class="highlighter-rouge">n</code>TB，</li>
  <li>边缘机房容量<code class="highlighter-rouge">e*n</code>TB，</li>
  <li>和回源率<code class="highlighter-rouge">b</code>, <code class="highlighter-rouge">b= 不在边缘的文件的请求数 / 全部请求数</code>。</li>
</ul>

<img src="/publish/cdn/images/b_=_frac_int__en_n_c_k_s_dk_int_1_n_c_k_s_dk_=_frac_n_1-s_-_en_1-s_n_1-s_-_1_-21a1cb154db40952431ea25e1a2aa9c8.png" style="display: block; margin: 0 auto 1.3em auto" alt="b =

\frac
{\int_{en}^n c/k^s dk}
{\int_1^n c/k^s dk}

=

\frac
{n^{1-s}-(en)^{1-s}}
{n^{1-s} - 1}"/>

<p>因为<code class="highlighter-rouge">s</code> 已经通过直线拟合得到了，而<code class="highlighter-rouge">e</code>和<code class="highlighter-rouge">b</code>可以从边缘机房的具体配置和访问日志得到。
于是我们可以确定<code class="highlighter-rouge">n</code>的值，
也就是说(划重点):</p>

<p><strong>CDN可以根据访问模型估算源站的总文件量</strong>。</p>

<blockquote>
  <p>虽然源站信息一般不会直接透漏给CDN提供商，
但实际上这个信息对CDN来说是可估算的。</p>

  <p>同样，对于源站来说，他知道自己的全量数据<code class="highlighter-rouge">n</code>的值，以及回源率<code class="highlighter-rouge">b</code>的值，
通过这个公式也可以知道CDN的 <strong>一个边缘机房的存储容量<code class="highlighter-rouge">e</code></strong>。</p>
</blockquote>

<h1 id="确定it设施单位成本">确定IT设施单位成本</h1>

<p>有了<code class="highlighter-rouge">b</code>，<code class="highlighter-rouge">e</code>的关系，接下来给出基础<strong>成本数据</strong>，就可以确定最优成本对应的<code class="highlighter-rouge">e</code>的值了:</p>

<p>从网上搜一些基础数据(如服务器价格，硬盘价格，各家云大厂提供的带宽单价等)，
折算成单位成本为后面计算时使用:</p>

<ul>
  <li>边缘机房的存储的成本是 <code class="highlighter-rouge">1 元/TB/天</code>，包括服务器和租机房的费用，三年均摊。</li>
  <li>边缘机房拉取源站内容的带宽成本是 <code class="highlighter-rouge">600 元/Gbps/天</code>。</li>
</ul>

<blockquote>
  <p>价格等数值因为是从网上搜来的，可能跟实际运营中的数据相差很多，这里只为用来说明原理，
确定方法，不保证数值上跟真实环境完全吻合。</p>
</blockquote>

<p>根据以上设定，我们可以得到一个边缘机房中:</p>

<ul>
  <li>存储成本是: <code class="highlighter-rouge">7200TB * e * 1元/TB/天</code></li>
  <li>回源带宽成本: <code class="highlighter-rouge">20Gbps * b * 600元/Gbps/天</code></li>
</ul>

<h1 id="找出最优配置">找出最优配置</h1>

<p>现在所有的模型，场景和数据都准备好了，
最后我们把它们放在一起得到最终结论: <strong>成本对边缘容量的变化</strong>:</p>

<ol>
  <li>选择不同的边缘容量<code class="highlighter-rouge">e</code>的值((图1)橘黄色部分的宽度)，</li>
  <li>根据回源率b的公式计算对应的回源率<code class="highlighter-rouge">b</code>((图1)蓝色部分积分/蓝色黄色部分积分)，</li>
  <li>再结合单位成本，得出每个<code class="highlighter-rouge">e</code>对应的总成本，</li>
</ol>

<p>最后我们得到如下一个边缘容量<code class="highlighter-rouge">e</code>决定回源率<code class="highlighter-rouge">b</code>和成本的表格:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">e:边缘存储容量占比%</th>
      <th style="text-align: right">b:回源率%</th>
      <th style="text-align: right">存储成本</th>
      <th style="text-align: right">回源带宽成本</th>
      <th style="text-align: right">总成本</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">2.00%</td>
      <td style="text-align: right">12.14%</td>
      <td style="text-align: right">144</td>
      <td style="text-align: right">1456.8</td>
      <td style="text-align: right">1600.8</td>
    </tr>
    <tr>
      <td style="text-align: right">3.00%</td>
      <td style="text-align: right">10.64%</td>
      <td style="text-align: right">216</td>
      <td style="text-align: right">1276.8</td>
      <td style="text-align: right">1492.8</td>
    </tr>
    <tr>
      <td style="text-align: right">4.00%</td>
      <td style="text-align: right">9.62%</td>
      <td style="text-align: right">288</td>
      <td style="text-align: right">1154.4</td>
      <td style="text-align: right">1442.4</td>
    </tr>
    <tr>
      <td style="text-align: right">5.00%</td>
      <td style="text-align: right">8.85%</td>
      <td style="text-align: right">360</td>
      <td style="text-align: right">1062.0</td>
      <td style="text-align: right">1422.0</td>
    </tr>
    <tr>
      <td style="text-align: right"><code class="highlighter-rouge">min ------&gt; 6.00%</code></td>
      <td style="text-align: right">8.23%</td>
      <td style="text-align: right">432</td>
      <td style="text-align: right">987.6</td>
      <td style="text-align: right"><strong>1419.6</strong></td>
    </tr>
    <tr>
      <td style="text-align: right">7.00%</td>
      <td style="text-align: right">7.72%</td>
      <td style="text-align: right">504</td>
      <td style="text-align: right">926.4</td>
      <td style="text-align: right">1430.4</td>
    </tr>
    <tr>
      <td style="text-align: right">8.00%</td>
      <td style="text-align: right">7.28%</td>
      <td style="text-align: right">576</td>
      <td style="text-align: right">873.6</td>
      <td style="text-align: right">1449.6</td>
    </tr>
    <tr>
      <td style="text-align: right">9.00%</td>
      <td style="text-align: right">6.89%</td>
      <td style="text-align: right">648</td>
      <td style="text-align: right">826.8</td>
      <td style="text-align: right">1474.8</td>
    </tr>
    <tr>
      <td style="text-align: right">10.00%</td>
      <td style="text-align: right">6.56%</td>
      <td style="text-align: right">720</td>
      <td style="text-align: right">787.2</td>
      <td style="text-align: right">1507.2</td>
    </tr>
    <tr>
      <td style="text-align: right">…</td>
      <td style="text-align: right">…</td>
      <td style="text-align: right">…</td>
      <td style="text-align: right">…</td>
      <td style="text-align: right">…</td>
    </tr>
  </tbody>
</table>

<p>我们看到，在这个业务场景中，<strong>边缘容量取到6%时，总成本会达到最低: 1419.6 元/天</strong>。</p>

<p>把<code class="highlighter-rouge">e</code>变化作为x轴，画出边缘存储成本和回源带宽成本随<code class="highlighter-rouge">e</code>变化的曲线如下图，
趋势看起来就更清楚了:</p>

<p><img src="/post-res/cache-hit/edge-backsource-cost.png" alt="xxx" /></p>

<p>我们看到总成本(红色曲线)在这个图上有一个极小值，大概在<code class="highlighter-rouge">e=6%</code>的位置。</p>

<p>而如果边缘机房的容量配置不在<code class="highlighter-rouge">6%</code>这个位置，譬如达到<strong><code class="highlighter-rouge">10%</code></strong>，
一个边缘机房每天就会多花掉<code class="highlighter-rouge">1507-1419= 88</code> 元，
如果整个CDN系统有<code class="highlighter-rouge">100</code>个边缘机房，</p>

<p><strong>一年多花的钱就是320万</strong> (<code class="highlighter-rouge">88 * 100 * 365</code>)。</p>

<blockquote>
  <p>当然，在实际运营一个CDN这种庞大的系统的时候，还有很多因素需要考虑:</p>
  <ul>
    <li>如边缘机房的存储容量带来的性能提升，</li>
    <li>低回源率带来的整体延迟降低等。</li>
  </ul>

  <p>因此我们的结论尚不能作为优化的标准，而只能作为优化的参考:</p>
  <ul>
    <li>知道理论上限在哪，</li>
    <li>不做无效的尝试，</li>
    <li>制定有依据的目标，</li>
    <li>了解运营策略调整的成本等等。</li>
  </ul>
</blockquote>

<h1 id="总结">总结</h1>

<p>算完了，休息一下。</p>

<p>互联网的各种服务之间都是相互关联的。
虽然目前看来，源站和CDN之间的协作还是单方面的，一方去适应另一方，
或一方服务另一方的模式。
其实源站和边缘之间，本应是一个整体，但市场的划分导致了技术和设施层面上的分离，
让这个本应完整的框架分离成了2个或多个部分。</p>

<p>这里我们看到的源站和边缘之间的关系，
还只是开始，这些只不过是数学结论上的互相了解，
源站和边缘之间应该有比这更大的的协作空间。</p>

<p>试想一下，边缘和源站之间如果能在单向数据下载的基础上建立双向数据通讯，
在中心源站数据发生变化要通知边缘缓存的基础上，
如果边缘发生的事情能很快推送到中心，
才是真正的互联网模式。</p>

<p>市场一直在变化，
每次在这些变化背后，
一定是有一个什么新的东西出现，是让用户使用到了更方便或更高效的东西，
才让技术的格局发生了变化(google之于yahoo，微信之于邮箱，twitter之于博客)。</p>

<p>出色的支持和适配可以产生优质的产品，但我相信协作和互通更能带来质的变化。
作为一个技术从业人员，发现这些改变的可能，实现这些改变，并把这种改变服务于可受益的人，
也许就是最开心的事情了: <strong>Discover, Design, Distribute</strong>…</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 标签: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#backsource" class="page__taxonomy-item" rel="tag">backsource</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#cache" class="page__taxonomy-item" rel="tag">cache</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#cdn" class="page__taxonomy-item" rel="tag">CDN</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#center" class="page__taxonomy-item" rel="tag">center</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#edge" class="page__taxonomy-item" rel="tag">edge</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#hit" class="page__taxonomy-item" rel="tag">hit</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#log-log" class="page__taxonomy-item" rel="tag">log-log</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#rate" class="page__taxonomy-item" rel="tag">rate</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#zipf" class="page__taxonomy-item" rel="tag">zipf</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#%E7%BC%93%E5%AD%98" class="page__taxonomy-item" rel="tag">缓存</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#%E8%BE%B9%E7%BC%98" class="page__taxonomy-item" rel="tag">边缘</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 分类: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#tech" class="page__taxonomy-item" rel="tag">tech</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新时间:</strong> <time datetime="2019-11-21T00:00:00+08:00">November 21, 2019</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">分享</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%E6%8E%90%E6%8C%87%E7%AE%97%E7%AE%97%3A+%E4%BD%A0%E7%9A%84CDN%E5%A4%9A%E8%8A%B1%E4%BA%86%E5%87%A0%E7%99%BE%E4%B8%87%3F%20http%3A%2F%2Flocalhost%3A4000%2Ftech%2Fcdn%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Ftech%2Fcdn%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Ftech%2Fcdn%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/tech/zipf/" class="pagination--pager" title="互联网中对象访问频率的91分布
">向前</a>
    
    
      <a href="#" class="pagination--pager disabled">向后</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">猜您还喜欢</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tech/zipf/" rel="permalink">互联网中对象访问频率的91分布
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 分钟阅读

</p>
    
    <p class="archive__item-excerpt" itemprop="description">在互联网领域, 流行着这么一句话:


  90%的流量由10%的内容产生.


缓存也由此产生: 只为最频繁访问的10%的内容提供更快的存储,
就可以以很低的成本提供尽可能好的服务质量.

一般符合这种互联网访问模型的曲线是下图这样的.
对每个访问的url做独立计数, 并按照从访问最多到最低排序:



这句是...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/culture/code-of-conduct/" rel="permalink">OpenACID’s Code of Conduct
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 分钟阅读

</p>
    
    <p class="archive__item-excerpt" itemprop="description">社交规则

避免”故作惊讶”

第一条规则是, 当对方说他不知道某件事情时, 你最好不要(刻意的或无意的)表现得很惊讶。

包括技术问题(“什么?!我不能相信你不知道堆栈是什么!) 和非技术问题(“你不知道谁是RMS ?!”)
(RMS: Richard Matthew Stallman,  自由软件奠基人)。
...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tech/algorithm/slimtrie-impl/" rel="permalink">SlimTrie: 单机百亿文件的极致索引-实现篇
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  20 分钟阅读

</p>
    
    <p class="archive__item-excerpt" itemprop="description">



Github:  SlimTrie


    上一篇
    
        《SlimTrie 设计篇》
    
    中，我们介绍了单机百亿文件的索引设计思路，今天我们来具体介绍下它代码级别的实现。文中我们要解决的问题是: 
    在一台通用的100TB的存储服务器的内存中, 索引100亿个...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tech/algorithm/slimtrie-design/" rel="permalink">SlimTrie: 单机百亿文件的极致索引-设计篇
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  15 分钟阅读

</p>
    
    <p class="archive__item-excerpt" itemprop="description">



Github:  SlimTrie


    背景


    当下信息社会每天都产生大量需要保存的数据，这些数据在刺激海量存储技术发展的同时也带来了新的挑战。比如，海量数据为存储系统增加了大量的小文件，这些小文件的元数据如何管理？如何控制定位某个文件的时间和空间开销？


    随着对数据实时性要求...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="输入您要搜索的关键词..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->



<script language="javascript" type="text/x-mathjax-config">
    MathJax.Hub.Config({
      jax: ["input/TeX", "output/SVG"],
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
          processEscapes: true
        }
    });
</script>
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_SVG"> </script>




<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>关注:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 OpenACID-分布式研究小院. 技术来自于 <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/tech/cdn/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/tech/cdn"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://openacid.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
