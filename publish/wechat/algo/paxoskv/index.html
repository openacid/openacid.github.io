<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.2 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>200è¡Œä»£ç å®ç°åŸºäºpaxosçš„kvå­˜å‚¨ - OpenACID Blog</title>
<meta name="description" content="ç”¨200è¡Œä»£ç å®ç°ä¸€ä¸ªåŸºäºpaxosçš„kvå­˜å‚¨, ä»¥æœ€ç®€æ´çš„å½¢å¼å±•ç¤ºpaxoså¦‚ä½•è¿è¡Œ, ä½œä¸º paxosçš„ç›´è§‚è§£é‡Š è¿™ç¯‡æ•™ç¨‹ä¸­çš„ä»£ç ç¤ºä¾‹éƒ¨åˆ†">


  <meta name="author" content="å¼ ç‚æ³¼(xp)">
  
  <meta property="article:author" content="å¼ ç‚æ³¼(xp)">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="OpenACID Blog">
<meta property="og:title" content="200è¡Œä»£ç å®ç°åŸºäºpaxosçš„kvå­˜å‚¨">
<meta property="og:url" content="https://blog.openacid.com/algo/paxoskv/">


  <meta property="og:description" content="ç”¨200è¡Œä»£ç å®ç°ä¸€ä¸ªåŸºäºpaxosçš„kvå­˜å‚¨, ä»¥æœ€ç®€æ´çš„å½¢å¼å±•ç¤ºpaxoså¦‚ä½•è¿è¡Œ, ä½œä¸º paxosçš„ç›´è§‚è§£é‡Š è¿™ç¯‡æ•™ç¨‹ä¸­çš„ä»£ç ç¤ºä¾‹éƒ¨åˆ†">







  <meta property="article:published_time" content="2020-10-28T00:00:00+08:00">





  

  


<link rel="canonical" href="https://blog.openacid.com/algo/paxoskv/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "OpenACID-åˆ†å¸ƒå¼ç ”ç©¶å°é™¢",
      "url": "https://blog.openacid.com/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="OpenACID Blog Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="apple-touch-icon" sizes="180x180"    href="/assets/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon/favicon-16x16.png">
<link rel="manifest"                            href="/assets/images/favicon/site.webmanifest">

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">è·³è½¬é“¾æ¥</h2>
  <ul>
    <li>[è½¬åˆ°ä¸»å¯¼èˆªæ ]</li>
    <li>[è½¬åˆ°å†…å®¹]</li>
    <li>[è½¬åˆ°åº•éƒ¨]</li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please [upgrade your browser] to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/logo/icon-lemon-margin.png" alt=""></a>
        
        <a class="site-title" href="/">
          OpenACID Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              [About Us]
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">åˆ‡æ¢æœç´¢</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">åˆ‡æ¢èœå•</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">
  
  
  <p>

  
    <div class="author__avatar">
      
        <img src="/assets/images/author/xp.jpg" alt="å¼ ç‚æ³¼(xp)" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">å¼ ç‚æ³¼(xp)</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>æ­£åœ¨å­¦ç”»ç”», ä¸»ä¸šæ˜¯ç å†œ</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">å…³æ³¨</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li>[<i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">ä¸ªäººåšå®¢</span>]</li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          [
            <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span>
          ]
        </li>
      

      

      

      

      

      

      

      

      

      

      
        <li>
          [
            <i class="fab fa-fw fa-weibo" aria-hidden="true"></i><span class="label">Weibo</span>
          ]
        </li>
      

      

      

      

      <!--
  <li>
    [
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    ]
  </li>
-->
    </ul>
  </div>

  </p>
  
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="200è¡Œä»£ç å®ç°åŸºäºpaxosçš„kvå­˜å‚¨">
    <meta itemprop="description" content="ç”¨200è¡Œä»£ç å®ç°ä¸€ä¸ªåŸºäºpaxosçš„kvå­˜å‚¨, ä»¥æœ€ç®€æ´çš„å½¢å¼å±•ç¤ºpaxoså¦‚ä½•è¿è¡Œ, ä½œä¸º paxosçš„ç›´è§‚è§£é‡Š è¿™ç¯‡æ•™ç¨‹ä¸­çš„ä»£ç ç¤ºä¾‹éƒ¨åˆ†">
    <meta itemprop="datePublished" content="2020-10-28T00:00:00+08:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">200è¡Œä»£ç å®ç°åŸºäºpaxosçš„kvå­˜å‚¨
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          30 åˆ†é’Ÿé˜…è¯»
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> æœ¬æ–‡ç›®å½•</h4></header>
              <ul class="toc__menu">
  <li>[å‰è¨€]</li>
  <li>[è¿è¡Œå’Œä½¿ç”¨]</li>
  <li>[ä»å¤´å®ç°paxoskv]
    <ul>
      <li>[Paxos ç›¸å…³çš„æ•°æ®ç»“æ„]
        <ul>
          <li>[Proposer å’Œ Acceptor]</li>
          <li>[å®šä¹‰RPCæ¶ˆæ¯ç»“æ„]</li>
        </ul>
      </li>
      <li>[ä½¿ç”¨protobufå’Œgrpcç”ŸæˆæœåŠ¡æ¡†æ¶]</li>
      <li>[å®ç°å­˜å‚¨çš„æœåŠ¡å™¨ç«¯]
        <ul>
          <li>[å®ç° Acceptor çš„ grpc æœåŠ¡ handler]</li>
          <li>[å®ç°Proposer é€»è¾‘]
            <ul>
              <li>[Phase1]</li>
              <li>[client ä¸ server ç«¯çš„è¿æ¥]</li>
              <li>[Phase2]</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>[å®Œæ•´çš„paxosé€»è¾‘]</li>
    </ul>
  </li>
  <li>[å®ç°è¯»æ“ä½œ]</li>
  <li>[æ–‡ä¸­ä¾‹å­]</li>
  <li>[ä¸‹ä¸€æ­¥]</li>
</ul>

            </nav>
          </aside>
        
        <p style="font-size: 0.7rem; font-weight: bolder;">
æœ¬æ–‡é“¾æ¥: [https://blog.openacid.com/algo/paxoskv/]


</p>


        
          



<img src="/post-res/paxoskv/paxoskv-banner-small.png" alt="200è¡Œä»£ç å®ç°åŸºäºpaxosçš„kvå­˜å‚¨" class="page__hero-image">

        

        <h1 id="å‰è¨€">å‰è¨€</h1>

<p>å†™å®Œ [paxosçš„ç›´è§‚è§£é‡Š] ä¹‹å,
ç½‘å‹éƒ½è¯´ç–—æ•ˆç”šå¥½, ä½†æ˜¯ä¹Ÿä¼šå¯¹è¿™ç¯‡æ•™ç¨‹ä¸­ä¸€äº›ç¯èŠ‚æå‡ºç–‘é—®(æœ‰ç–‘é—®è¯´æ˜çœŸçš„çœ‹æ‡‚äº† ğŸ¤” ) ,
ä¾‹å¦‚æ€ä¹ˆæŠŠåªèƒ½ç¡®å®šä¸€ä¸ªå€¼çš„paxosåº”ç”¨åˆ°å®é™…åœºæ™¯ä¸­.</p>

<p>æ—¢ç„¶<strong>Talk is cheap</strong>, é‚£ä¹ˆå°±<strong>Show me the code</strong>,
è¿™æ¬¡æˆ‘ä»¬æŠŠæ•™ç¨‹ä¸­æè¿°çš„å†…å®¹ç›´æ¥ç”¨ä»£ç å®ç°å‡ºæ¥, å¸Œæœ›èƒ½è¦†ç›–åˆ°æ•™ç¨‹ä¸­çš„æ¶‰åŠçš„æ¯ä¸ªç»†èŠ‚. å¸®åŠ©å¤§å®¶ç†è§£paxosçš„è¿è¡Œæœºåˆ¶.</p>

<p><strong>è¿™æ˜¯ä¸€ä¸ªåŸºäºpaxos, 200è¡Œä»£ç çš„kvå­˜å‚¨ç³»ç»Ÿçš„ç®€å•å®ç°, ä½œä¸º [paxosçš„ç›´è§‚è§£é‡Š] è¿™ç¯‡æ•™ç¨‹ä¸­çš„ä»£ç ç¤ºä¾‹éƒ¨åˆ†</strong>.
Paxosçš„åŸç†æœ¬æ–‡ä¸å†ä»‹ç»äº†,
æœ¬æ–‡æåˆ°çš„æ•°æ®ç»“æ„ä½¿ç”¨[protobuf]å®šä¹‰,
ç½‘ç»œéƒ¨åˆ†ä½¿ç”¨[grpc]å®šä¹‰. å¦å¤–200è¡Œgoä»£ç å®ç°paxoså­˜å‚¨.</p>

<p>æ–‡ä¸­çš„ä»£ç å¯èƒ½åšäº†ç®€åŒ–, å®Œæ•´ä»£ç å®ç°åœ¨ [paxoskv]  è¿™ä¸ªé¡¹ç›®ä¸­(naiveåˆ†æ”¯).</p>

<h1 id="è¿è¡Œå’Œä½¿ç”¨">è¿è¡Œå’Œä½¿ç”¨</h1>

<p>ğŸš€</p>

<p>è·‘ä¸€ä¸‹:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/openacid/paxoskv.git
<span class="nb">cd </span>paxoskv
go <span class="nb">test</span> <span class="nt">-v</span> ./...
</code></pre></div></div>

<p>è¿™ä¸ªé¡¹ç›®ä¸­é™¤äº†paxoså®ç°, ç”¨3ä¸ªtest caseæè¿°äº†3ä¸ªpaxosè¿è¡Œçš„ä¾‹å­,</p>

<ul>
  <li>[TestCase1SingleProposer]: æ— å†²çªè¿è¡Œ.</li>
  <li>[TestCase2DoubleProposer]: æœ‰å†²çªè¿è¡Œ.</li>
  <li>[Example_setAndGetByKeyVer]: ä½œä¸ºkey-valä½¿ç”¨.</li>
</ul>

<p>æµ‹è¯•ä»£ç æè¿°äº†å‡ ä¸ªpaxosè¿è¡Œä¾‹å­çš„è¡Œä¸º, è¿è¡Œæµ‹è¯•å¯ä»¥ç¡®è®¤paxosçš„å®ç°ç¬¦åˆé¢„æœŸ.</p>

<p>æœ¬æ–‡ä¸­ protobuf çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹:</p>

<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">service</span> <span class="n">PaxosKV</span> <span class="p">{</span>
    <span class="k">rpc</span> <span class="n">Prepare</span> <span class="p">(</span><span class="n">Proposer</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Acceptor</span><span class="p">)</span> <span class="p">{}</span>
    <span class="k">rpc</span> <span class="n">Accept</span> <span class="p">(</span><span class="n">Proposer</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Acceptor</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">BallotNum</span> <span class="p">{</span>
    <span class="kt">int64</span> <span class="na">N</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int64</span> <span class="na">ProposerId</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">Value</span> <span class="p">{</span>
    <span class="kt">int64</span> <span class="na">Vi64</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">PaxosInstanceId</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="na">Key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int64</span>  <span class="na">Ver</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">Acceptor</span> <span class="p">{</span>
    <span class="n">BallotNum</span> <span class="na">LastBal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">Value</span>     <span class="na">Val</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">BallotNum</span> <span class="na">VBal</span>    <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">message</span> <span class="nc">Proposer</span> <span class="p">{</span>
    <span class="n">PaxosInstanceId</span> <span class="na">Id</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">BallotNum</span>       <span class="na">Bal</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">Value</span>           <span class="na">Val</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä»¥åŠä¸»è¦çš„å‡½æ•°å®ç°:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// struct KVServer</span>
<span class="n">Storage</span> <span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">Versions</span>
<span class="k">func</span> <span class="n">Accept</span><span class="p">(</span><span class="n">c</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">Prepare</span><span class="p">(</span><span class="n">c</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">getLockedVersion</span><span class="p">(</span><span class="n">id</span> <span class="o">*</span><span class="n">PaxosInstanceId</span><span class="p">)</span> <span class="o">*</span><span class="n">Version</span>

<span class="c">// struct Proposer</span>
<span class="k">func</span> <span class="n">Phase1</span><span class="p">(</span><span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span> <span class="n">quorum</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Value</span><span class="p">,</span> <span class="o">*</span><span class="n">BallotNum</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">Phase2</span><span class="p">(</span><span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span> <span class="n">quorum</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">BallotNum</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">RunPaxos</span><span class="p">(</span><span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span> <span class="n">val</span> <span class="o">*</span><span class="n">Value</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Value</span><span class="p">)</span>
<span class="k">func</span> <span class="n">rpcToAll</span><span class="p">(</span><span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span> <span class="n">action</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">)</span>

<span class="k">func</span> <span class="n">ServeAcceptors</span><span class="p">(</span><span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="n">grpc</span><span class="o">.</span><span class="n">Server</span><span class="p">)</span>
</code></pre></div></div>

<h1 id="ä»å¤´å®ç°paxoskv">ä»å¤´å®ç°paxoskv</h1>

<h2 id="paxos-ç›¸å…³çš„æ•°æ®ç»“æ„">Paxos ç›¸å…³çš„æ•°æ®ç»“æ„</h2>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬çš„æ•°æ®ç»“æ„å’ŒæœåŠ¡æ¡†æ¶ä½¿ç”¨ [protobuf] å’Œ [grpc] å®ç°,
é¦–å…ˆæ˜¯æœ€åº•å±‚çš„paxosæ•°æ®ç»“æ„:</p>

<h3 id="proposer-å’Œ-acceptor">Proposer å’Œ Acceptor</h3>

<p>åœ¨ [slide-27] ä¸­æˆ‘ä»¬ä»‹ç»äº†1ä¸ª Acceptor æ‰€éœ€çš„å­—æ®µ:</p>

<blockquote>
  <p>åœ¨å­˜å‚¨ç«¯(Acceptor)ä¹Ÿæœ‰å‡ ä¸ªæ¦‚å¿µ:</p>

  <ul>
    <li>last_rnd æ˜¯Acceptorè®°ä½çš„æœ€åä¸€æ¬¡è¿›è¡Œå†™å‰è¯»å–çš„Proposer(å®¢æˆ·ç«¯)æ˜¯è°, ä»¥æ­¤æ¥å†³å®šè°å¯ä»¥åœ¨åé¢çœŸæ­£æŠŠä¸€ä¸ªå€¼å†™åˆ°å­˜å‚¨ä¸­.</li>
    <li>v æ˜¯æœ€åè¢«å†™å…¥çš„å€¼.</li>
    <li>vrnd è·Ÿvæ˜¯ä¸€å¯¹, å®ƒè®°å½•äº†åœ¨å“ªä¸ªRoundä¸­vè¢«å†™å…¥äº†.</li>
  </ul>
</blockquote>

<p><img src="/post-res/paxos/slide-imgs/paxos-27.jpg" alt="" /></p>

<p>åŸæ–‡ä¸­è¿™äº›åè¯æ˜¯å‚è€ƒäº† [paxos made simple] ä¸­çš„åç§°, ä½†åœ¨ [Leslie Lamport]
åé¢çš„å‡ ç¯‡paperä¸­éƒ½æ¢äº†åç§°, ä¸ºäº†åç»­æ–¹ä¾¿, åœ¨[paxoskv]çš„ä»£ç å®ç°ä¸­ä¹Ÿåšäº†ç›¸åº”çš„æ›¿æ¢:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rnd      ==&gt; Bal   // æ¯ä¸€è½®paxosçš„ç¼–å·, BallotNum
vrnd     ==&gt; VBal  // åœ¨å“ªä¸ªBallotä¸­vè¢«Acceptor æ¥å—(voted)
last_rnd ==&gt; LastBal
</code></pre></div></div>

<p>Proposerçš„å­—æ®µä¹Ÿå¾ˆç®€å•, å®ƒéœ€è¦è®°å½•:</p>
<ul>
  <li>å½“å‰çš„ballot number: <code class="highlighter-rouge">Bal</code>,</li>
  <li>ä»¥åŠå®ƒé€‰æ‹©åœ¨Phase2è¿è¡Œçš„å€¼: <code class="highlighter-rouge">Val</code> ([slide-29]).</li>
</ul>

<p>äºæ˜¯åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ç”¨protobufå®šä¹‰è¿™ä¸¤ä¸ªè§’è‰²çš„æ•°æ®ç»“æ„, å¦‚ä»£ç  [paxoskv.proto] ä¸­çš„å£°æ˜, å¦‚ä¸‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message Acceptor {
  BallotNum LastBal = 1;
  Value     Val = 2;
  BallotNum VBal = 3;
}

message Proposer {
  PaxosInstanceId Id = 1;

  BallotNum Bal = 2;
  Value     Val = 3;
}
</code></pre></div></div>

<p>å…¶ä¸­Proposerè¿˜éœ€è¦ä¸€ä¸ªPaxosInstanceId,
æ¥æ ‡è¯†å½“å‰çš„paxoså®ä¾‹ä¸ºå“ªä¸ªkeyçš„å“ªä¸ªversionåœ¨åšå†³å®š, [paxos made simple]
ä¸­åªæè¿°äº†ä¸€ä¸ªpaxoså®ä¾‹çš„ç®—æ³•(å¯¹åº”ä¸€ä¸ªkeyçš„ä¸€æ¬¡ä¿®æ”¹), è¦å®ç°å¤šæ¬¡ä¿®æ”¹,
å°±éœ€è¦å¢åŠ è¿™ä¸ªå­—æ®µæ¥åŒºåˆ†ä¸åŒçš„paxoså®ä¾‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message PaxosInstanceId {
  string Key = 1;
  int64  Ver = 2;
}
</code></pre></div></div>

<p>[paxoskv.proto] è¿˜å®šä¹‰äº†ä¸€ä¸ªBallotNum, 
å› ä¸ºè¦ä¿è¯å…¨ç³»ç»Ÿå†…çš„BallotNuméƒ½æœ‰åºä¸”ä¸é‡å¤,
ä¸€èˆ¬çš„åšæ³•å°±æ˜¯ç”¨ä¸€ä¸ªæœ¬åœ°å•è°ƒé€’å¢çš„æ•´æ•°, å’Œä¸€ä¸ªå…¨å±€å”¯ä¸€çš„idç»„åˆèµ·æ¥å®ç°:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>message BallotNum {
    int64 N = 1;
    int64 ProposerId = 2;
}
</code></pre></div></div>

<h3 id="å®šä¹‰rpcæ¶ˆæ¯ç»“æ„">å®šä¹‰RPCæ¶ˆæ¯ç»“æ„</h3>

<p>RPCæ¶ˆæ¯å®šä¹‰äº†Proposerå’ŒAcceptorä¹‹é—´çš„é€šè®¯.</p>

<p>åœ¨ä¸€ä¸ªpaxosç³»ç»Ÿä¸­, è‡³å°‘è¦æœ‰4ä¸ªæ¶ˆæ¯:</p>
<ul>
  <li>Phase1çš„ Prepare-request, Prepare-reply,</li>
  <li>å’ŒPhase2çš„ Accept-request, Accept-reply,</li>
</ul>

<p>å¦‚[slide-28] æ‰€æè¿°çš„(åŸæ–‡ä¸­ä½¿ç”¨rnd, è¿™é‡Œä½¿ç”¨Bal, éƒ½æ˜¯åŒä¸€ä¸ªæ¦‚å¿µ):</p>

<blockquote>
  <p>Phase-1(Prepare):</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>request:
    Bal: int

reply:
    LastBal: int
    Val:     string
    VBal:    int
</code></pre></div>  </div>

  <p>Phase-2(Accept):</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>request:
    Bal: int
    Val:   string

reply:
    LastBal: int
</code></pre></div>  </div>
</blockquote>

<p>åœ¨Prepare-requestæˆ–Accept-requestä¸­, å‘é€çš„æ˜¯ä¸€éƒ¨åˆ†æˆ–å…¨éƒ¨çš„Proposerçš„å­—æ®µ,
å› æ­¤æˆ‘ä»¬åœ¨ä»£ç ä¸­:</p>
<ul>
  <li>ç›´æ¥æŠŠProposerçš„ç»“æ„ä½“ä½œä¸ºrequestçš„ç»“æ„ä½“.</li>
  <li>åŒæ ·æŠŠAcceptorçš„ç»“æ„ä½“ä½œä¸ºreplyçš„ç»“æ„ä½“.</li>
</ul>

<p>åœ¨ä½¿ç”¨çš„æ—¶å€™åªä½¿ç”¨å…¶ä¸­å‡ ä¸ªå­—æ®µ.  å¯¹åº”æˆ‘ä»¬çš„ RPC æœåŠ¡ [PaxosKV] å®šä¹‰å¦‚ä¸‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service PaxosKV {
    rpc Prepare (Proposer) returns (Acceptor) {}
    rpc Accept (Proposer) returns (Acceptor) {}
}
</code></pre></div></div>

<h2 id="ä½¿ç”¨protobufå’Œgrpcç”ŸæˆæœåŠ¡æ¡†æ¶">ä½¿ç”¨protobufå’Œgrpcç”ŸæˆæœåŠ¡æ¡†æ¶</h2>

<p>ğŸš€</p>

<p>protobufå¯ä»¥å°†[paxoskv.proto]ç›´æ¥ç”Ÿæˆgoä»£ç (
ä»£ç åº“ä¸­å·²ç»åŒ…å«äº†ç”Ÿæˆå¥½çš„ä»£ç : [paxoskv.pb.go], åªæœ‰ä¿®æ”¹[paxoskv.proto]
ä¹‹åæ‰éœ€è¦é‡æ–°ç”Ÿæˆ)</p>

<ul>
  <li>
    <p>é¦–å…ˆå®‰è£…protobufçš„ç¼–è¯‘å™¨ protoc, å¯ä»¥æ ¹æ®
[install-protoc] ä¸­çš„æ­¥éª¤å®‰è£…, ä¸€èˆ¬ç®€å•çš„ä¸€è¡Œå‘½ä»¤å°±å¯ä»¥äº†:</p>

    <ul>
      <li>Linux: <code class="highlighter-rouge">apt install -y protobuf-compiler</code></li>
      <li>Mac: <code class="highlighter-rouge">brew install protobuf</code></li>
    </ul>

    <p>å®‰è£…å¥½ä¹‹åé€šè¿‡<code class="highlighter-rouge">protoc --version</code>ç¡®è®¤ç‰ˆæœ¬, è‡³å°‘åº”è¯¥æ˜¯3.x: <code class="highlighter-rouge">libprotoc 3.13.0</code></p>
  </li>
  <li>
    <p>å®‰è£…protocçš„goè¯­è¨€ç”Ÿæˆæ’ä»¶ protoc-gen-go:</p>

    <p><code class="highlighter-rouge">go get -u github.com/golang/protobuf/protoc-gen-go</code></p>
  </li>
  <li>
    <p>é‡æ–°ç¼–è¯‘<code class="highlighter-rouge">protokv.proto</code>æ–‡ä»¶: ç›´æ¥<code class="highlighter-rouge">make gen</code> æˆ–:</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  protoc \
      --proto_path=proto \
      --go_out=plugins=grpc:paxoskv \
      paxoskv.proto
</code></pre></div>    </div>
  </li>
</ul>

<p>ç”Ÿæˆåçš„[paxoskv.pb.go]ä»£ç ä¸­å¯ä»¥çœ‹åˆ°, å…¶ä¸­ä¸»è¦çš„æ•°æ®ç»“æ„ä¾‹å¦‚Acceptorçš„å®šä¹‰:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Acceptor</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">LastBal</span> <span class="o">*</span><span class="n">BallotNum</span> <span class="o">...</span>
  <span class="n">Val</span>     <span class="o">*</span><span class="n">Value</span> <span class="o">...</span>
  <span class="n">VBal</span>    <span class="o">*</span><span class="n">BallotNum</span> <span class="o">...</span>
        <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä»¥åŠKVæœåŠ¡çš„clientç«¯å’Œserverç«¯çš„ä»£ç , clientç«¯æ˜¯å®ç°å¥½çš„,
serverç«¯åªæœ‰ä¸€ä¸ªinterface, åé¢æˆ‘ä»¬éœ€è¦æ¥å®Œæˆå®ƒçš„å®ç°:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">paxosKVClient</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">cc</span> <span class="o">*</span><span class="n">grpc</span><span class="o">.</span><span class="n">ClientConn</span>
<span class="p">}</span>
<span class="k">type</span> <span class="n">PaxosKVClient</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">Prepare</span><span class="p">(</span>
    <span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
    <span class="n">in</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">,</span>
    <span class="n">opts</span> <span class="o">...</span><span class="n">grpc</span><span class="o">.</span><span class="n">CallOption</span>
  <span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

  <span class="n">Accept</span><span class="p">(</span>
    <span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
    <span class="n">in</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">,</span>
    <span class="n">opts</span> <span class="o">...</span><span class="n">grpc</span><span class="o">.</span><span class="n">CallOption</span>
  <span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">PaxosKVServer</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="n">Prepare</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
          <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
  <span class="n">Accept</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
         <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="å®ç°å­˜å‚¨çš„æœåŠ¡å™¨ç«¯">å®ç°å­˜å‚¨çš„æœåŠ¡å™¨ç«¯</h2>

<p>[impl.go] æ˜¯æ‰€æœ‰å®ç°éƒ¨åˆ†, æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªKVServerç»“æ„ä½“, ç”¨æ¥å®ç°grpcæœåŠ¡çš„interface <code class="highlighter-rouge">PaxosKVServer</code>;
å…¶ä¸­ä½¿ç”¨ä¸€ä¸ªå†…å­˜é‡Œçš„mapç»“æ„æ¨¡æ‹Ÿæ•°æ®çš„å­˜å‚¨:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Version</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">mu</span>       <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
  <span class="n">acceptor</span> <span class="n">Acceptor</span>
<span class="p">}</span>
<span class="k">type</span> <span class="n">Versions</span> <span class="k">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">]</span><span class="o">*</span><span class="n">Version</span>
<span class="k">type</span> <span class="n">KVServer</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">mu</span>      <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
  <span class="n">Storage</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="n">Versions</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å…¶ä¸­<code class="highlighter-rouge">Version</code>å¯¹åº”ä¸€ä¸ªkeyçš„ä¸€æ¬¡å˜åŒ–, ä¹Ÿå°±æ˜¯å¯¹åº”ä¸€ä¸ªpaxoså®ä¾‹.
Versionså¯¹åº”ä¸€ä¸ªkeyçš„ä¸€ç³»åˆ—å˜åŒ–.
Storageå°±æ˜¯æ‰€æœ‰keyçš„æ‰€æœ‰å˜åŒ–.</p>

<h3 id="å®ç°-acceptor-çš„-grpc-æœåŠ¡-handler">å®ç° Acceptor çš„ grpc æœåŠ¡ handler</h3>

<p>Acceptor, æ˜¯è¿™ä¸ªç³»ç»Ÿé‡Œçš„serverç«¯, ç›‘å¬ä¸€ä¸ªç«¯å£,
ç­‰å¾…Proposerå‘æ¥çš„è¯·æ±‚å¹¶å¤„ç†, ç„¶åç»™å‡ºåº”ç­”.</p>

<p>æ ¹æ®paxosçš„å®šä¹‰, Acceptorçš„é€»è¾‘å¾ˆç®€å•:
åœ¨ [slide-28] ä¸­æè¿°:</p>

<p><img src="/post-res/paxos/slide-imgs/paxos-28.jpg" alt="img" /></p>

<p>æ ¹æ®æ•™ç¨‹é‡Œçš„æè¿°, ä¸º KVServer å®šä¹‰handle Prepare-requestçš„ä»£ç :</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">KVServer</span><span class="p">)</span> <span class="n">Prepare</span><span class="p">(</span>
    <span class="n">c</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
    <span class="n">r</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">v</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">getLockedVersion</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
  <span class="k">defer</span> <span class="n">v</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>

  <span class="n">reply</span> <span class="o">:=</span> <span class="n">v</span><span class="o">.</span><span class="n">acceptor</span>

  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">Bal</span><span class="o">.</span><span class="n">GE</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">acceptor</span><span class="o">.</span><span class="n">LastBal</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">v</span><span class="o">.</span><span class="n">acceptor</span><span class="o">.</span><span class="n">LastBal</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">Bal</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç åˆ†3æ­¥:</p>
<ul>
  <li>å–å¾—paxoså®ä¾‹,</li>
  <li>ç”Ÿæˆåº”ç­”: Acceptoræ€»æ˜¯è¿”å›<code class="highlighter-rouge">LastBal</code>, <code class="highlighter-rouge">Val</code>, <code class="highlighter-rouge">VBal</code> è¿™3ä¸ªå­—æ®µ, æ‰€ä»¥ç›´æ¥æŠŠAcceptorèµ‹å€¼ç»™reply.</li>
  <li>æœ€åæ›´æ–°Acceptorçš„çŠ¶æ€: ç„¶åæŒ‰ç…§paxosç®—æ³•æè¿°, å¦‚æœè¯·æ±‚ä¸­çš„ballot numberæ›´å¤§, åˆ™è®°å½•ä¸‹æ¥,
è¡¨ç¤ºä¸åœ¨æ¥å—æ›´å°ballot numberçš„Proposer.</li>
</ul>

<p>å…¶ä¸­<code class="highlighter-rouge">getLockedVersion()</code>
ä»<code class="highlighter-rouge">KVServer.Storage</code>ä¸­æ ¹æ®request å‘æ¥çš„PaxosInstanceIdä¸­çš„å­—æ®µkeyå’Œverè·å–ä¸€ä¸ªæŒ‡å®šAcceptorçš„å®ä¾‹:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">KVServer</span><span class="p">)</span> <span class="n">getLockedVersion</span><span class="p">(</span>
    <span class="n">id</span> <span class="o">*</span><span class="n">PaxosInstanceId</span><span class="p">)</span> <span class="o">*</span><span class="n">Version</span> <span class="p">{</span>

  <span class="n">s</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
  <span class="k">defer</span> <span class="n">s</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>

  <span class="n">key</span> <span class="o">:=</span> <span class="n">id</span><span class="o">.</span><span class="n">Key</span>
  <span class="n">ver</span> <span class="o">:=</span> <span class="n">id</span><span class="o">.</span><span class="n">Ver</span>
  <span class="n">rec</span><span class="p">,</span> <span class="n">found</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">found</span> <span class="p">{</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">Versions</span><span class="p">{}</span>
    <span class="n">s</span><span class="o">.</span><span class="n">Storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span>
  <span class="p">}</span>

  <span class="n">v</span><span class="p">,</span> <span class="n">found</span> <span class="o">:=</span> <span class="n">rec</span><span class="p">[</span><span class="n">ver</span><span class="p">]</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">found</span> <span class="p">{</span>
    <span class="c">// initialize an empty paxos instance</span>
    <span class="n">rec</span><span class="p">[</span><span class="n">ver</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Version</span><span class="p">{</span>
      <span class="n">acceptor</span><span class="o">:</span> <span class="n">Acceptor</span><span class="p">{</span>
        <span class="n">LastBal</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">BallotNum</span><span class="p">{},</span>
        <span class="n">VBal</span><span class="o">:</span>    <span class="o">&amp;</span><span class="n">BallotNum</span><span class="p">{},</span>
      <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="n">ver</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="n">v</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">v</span>
<span class="p">}</span>
</code></pre></div></div>

<p>handle Accept-requestçš„å¤„ç†ç±»ä¼¼, åœ¨ [slide-31] ä¸­æè¿°:
<img src="/post-res/paxos/slide-imgs/paxos-31.jpg" alt="img" /></p>

<p><code class="highlighter-rouge">Accept()</code> è¦è®°å½•3ä¸ªå€¼,</p>
<ul>
  <li><code class="highlighter-rouge">LastBal</code>: Acceptorçœ‹åˆ°çš„æœ€å¤§çš„ballot number;</li>
  <li><code class="highlighter-rouge">Val</code>: Proposeré€‰æ‹©çš„å€¼,</li>
  <li>ä»¥åŠ<code class="highlighter-rouge">VBal</code>: Proposerçš„ballot number:</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">KVServer</span><span class="p">)</span> <span class="n">Accept</span><span class="p">(</span>
    <span class="n">c</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
    <span class="n">r</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">v</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">getLockedVersion</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
  <span class="k">defer</span> <span class="n">v</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>

  <span class="n">reply</span> <span class="o">:=</span> <span class="n">Acceptor</span><span class="p">{</span>
    <span class="n">LastBal</span><span class="o">:</span> <span class="o">&amp;*</span><span class="n">v</span><span class="o">.</span><span class="n">acceptor</span><span class="o">.</span><span class="n">LastBal</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">Bal</span><span class="o">.</span><span class="n">GE</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">acceptor</span><span class="o">.</span><span class="n">LastBal</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">v</span><span class="o">.</span><span class="n">acceptor</span><span class="o">.</span><span class="n">LastBal</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">Bal</span>
    <span class="n">v</span><span class="o">.</span><span class="n">acceptor</span><span class="o">.</span><span class="n">Val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">Val</span>
    <span class="n">v</span><span class="o">.</span><span class="n">acceptor</span><span class="o">.</span><span class="n">VBal</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">Bal</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Acceptor çš„é€»è¾‘åˆ°æ­¤å®Œæ•´äº†, å†çœ‹Proposer:</p>

<h3 id="å®ç°proposer-é€»è¾‘">å®ç°Proposer é€»è¾‘</h3>

<p>Proposerçš„è¿è¡Œåˆ†2ä¸ªé˜¶æ®µ, Phase1 å’Œ Phase2, ä¸ Prepare å’Œ Accept å¯¹åº”.</p>

<h4 id="phase1">Phase1</h4>

<p>åœ¨ [impl.go] çš„å®ç°ä¸­, <code class="highlighter-rouge">Proposer.Phase1()</code>å‡½æ•°è´Ÿè´£Phase1çš„é€»è¾‘:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="n">Phase1</span><span class="p">(</span>
    <span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span>
    <span class="n">quorum</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Value</span><span class="p">,</span> <span class="o">*</span><span class="n">BallotNum</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">replies</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">rpcToAll</span><span class="p">(</span><span class="n">acceptorIds</span><span class="p">,</span> <span class="s">"Prepare"</span><span class="p">)</span>

  <span class="n">ok</span> <span class="o">:=</span> <span class="m">0</span>
  <span class="n">higherBal</span> <span class="o">:=</span> <span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">Bal</span>
  <span class="n">maxVoted</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Acceptor</span><span class="p">{</span><span class="n">VBal</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">BallotNum</span><span class="p">{}}</span>

  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">replies</span> <span class="p">{</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">Bal</span><span class="o">.</span><span class="n">GE</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">LastBal</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">higherBal</span> <span class="o">=</span> <span class="o">*</span><span class="n">r</span><span class="o">.</span><span class="n">LastBal</span>
      <span class="k">continue</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">VBal</span><span class="o">.</span><span class="n">GE</span><span class="p">(</span><span class="n">maxVoted</span><span class="o">.</span><span class="n">VBal</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">maxVoted</span> <span class="o">=</span> <span class="n">r</span>
    <span class="p">}</span>

    <span class="n">ok</span> <span class="o">+=</span> <span class="m">1</span>
    <span class="k">if</span> <span class="n">ok</span> <span class="o">==</span> <span class="n">quorum</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">maxVoted</span><span class="o">.</span><span class="n">Val</span><span class="p">,</span> <span class="no">nil</span><span class="p">,</span> <span class="no">nil</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">higherBal</span><span class="p">,</span> <span class="n">NotEnoughQuorum</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç é¦–å…ˆé€šè¿‡ <code class="highlighter-rouge">rpcToAll()</code> å‘æ‰€æœ‰Acceptorå‘é€Prepare-requestè¯·æ±‚,
ç„¶åæ‰¾å‡ºæ‰€æœ‰çš„æˆåŠŸçš„reply:</p>

<ul>
  <li>å¦‚æœå‘ç°ä¸€ä¸ªæ›´å¤§çš„ballot number, è¡¨ç¤ºä¸€ä¸ªPrepare<strong>å¤±è´¥</strong>: æœ‰æ›´æ–°çš„Proposerå­˜åœ¨;</li>
  <li>å¦åˆ™, å®ƒæ˜¯ä¸€ä¸ª<strong>æˆåŠŸ</strong>çš„åº”ç­”,
å†çœ‹å®ƒæœ‰æ²¡æœ‰è¿”å›ä¸€ä¸ªå·²ç»è¢«Acceptoræ¥å—(voted)çš„å€¼.</li>
</ul>

<p>æœ€å, æˆåŠŸåº”ç­”å¦‚æœè¾¾åˆ°å¤šæ•°æ´¾(quorum), åˆ™è®¤ä¸ºPhase1 å®Œæˆ,
è¿”å›æœ€åä¸€ä¸ªè¢«votedçš„å€¼, ä¹Ÿå°±æ˜¯VBalæœ€å¤§çš„é‚£ä¸ª. è®©ä¸Šå±‚è°ƒç”¨è€…ç»§ç»­Phase2;</p>

<p>å¦‚æœæ²¡æœ‰è¾¾åˆ°quorum, è¿™æ—¶å¯èƒ½æ˜¯æœ‰å¤šä¸ªProposerå¹¶å‘è¿è¡Œè€Œé€ æˆå†²çª, æœ‰æ›´å¤§çš„ballot number, è¿™æ—¶åˆ™æŠŠè§åˆ°çš„æœ€å¤§ballot numberè¿”å›, ç”±ä¸Šå±‚è°ƒç”¨è€…æå‡ballot
numberå†é‡è¯•.</p>

<h4 id="client-ä¸-server-ç«¯çš„è¿æ¥">client ä¸ server ç«¯çš„è¿æ¥</h4>

<p>ä¸Šé¢ç”¨åˆ°çš„ <code class="highlighter-rouge">rpcToAll</code> åœ¨è¿™ä¸ªé¡¹ç›®ä¸­çš„å®ç°clientç«¯(Proposer)åˆ°serverç«¯(Acceptor)çš„é€šè®¯, å®ƒæ˜¯ä¸€ä¸ªååˆ† <del>ç®€æ´ç¾è§‚</del> ç®€é™‹çš„ grpc å®¢æˆ·ç«¯å®ç°:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="n">rpcToAll</span><span class="p">(</span>
    <span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span>
    <span class="n">action</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="n">Acceptor</span> <span class="p">{</span>

  <span class="n">replies</span> <span class="o">:=</span> <span class="p">[]</span><span class="o">*</span><span class="n">Acceptor</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">aid</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">acceptorIds</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">err</span> <span class="kt">error</span>
    <span class="n">address</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"127.0.0.1:%d"</span><span class="p">,</span>
        <span class="n">AcceptorBasePort</span><span class="o">+</span><span class="kt">int64</span><span class="p">(</span><span class="n">aid</span><span class="p">))</span>

    <span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span>
        <span class="n">address</span><span class="p">,</span> <span class="n">grpc</span><span class="o">.</span><span class="n">WithInsecure</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"did not connect: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="n">c</span> <span class="o">:=</span> <span class="n">NewPaxosKVClient</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span>
        <span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
    <span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>

    <span class="k">var</span> <span class="n">reply</span> <span class="o">*</span><span class="n">Acceptor</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">"Prepare"</span> <span class="p">{</span>
      <span class="n">reply</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Prepare</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">"Accept"</span> <span class="p">{</span>
      <span class="n">reply</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Accept</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">continue</span>
    <span class="p">}</span>
    <span class="n">replies</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">replies</span><span class="p">,</span> <span class="n">reply</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">replies</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="phase2">Phase2</h4>

<p>Proposerè¿è¡Œçš„Phase2
åœ¨[slide-30] ä¸­æè¿°, æ¯”Phase1æ›´ç®€å•:</p>

<blockquote>
  <p>åœ¨ç¬¬2é˜¶æ®µphase-2, Proposer Xå°†å®ƒé€‰å®šçš„å€¼å†™å…¥åˆ°Acceptorä¸­, è¿™ä¸ªå€¼å¯èƒ½æ˜¯å®ƒè‡ªå·±è¦å†™å…¥çš„å€¼, æˆ–è€…æ˜¯å®ƒä»æŸä¸ªAcceptorä¸Šè¯»åˆ°çš„v(ä¿®å¤).</p>
</blockquote>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="n">Phase2</span><span class="p">(</span>
    <span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span>
    <span class="n">quorum</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">BallotNum</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">replies</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">rpcToAll</span><span class="p">(</span><span class="n">acceptorIds</span><span class="p">,</span> <span class="s">"Accept"</span><span class="p">)</span>

  <span class="n">ok</span> <span class="o">:=</span> <span class="m">0</span>
  <span class="n">higherBal</span> <span class="o">:=</span> <span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">Bal</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">replies</span> <span class="p">{</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">Bal</span><span class="o">.</span><span class="n">GE</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">LastBal</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">higherBal</span> <span class="o">=</span> <span class="o">*</span><span class="n">r</span><span class="o">.</span><span class="n">LastBal</span>
      <span class="k">continue</span>
    <span class="p">}</span>
    <span class="n">ok</span> <span class="o">+=</span> <span class="m">1</span>
    <span class="k">if</span> <span class="n">ok</span> <span class="o">==</span> <span class="n">quorum</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="no">nil</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">higherBal</span><span class="p">,</span> <span class="n">NotEnoughQuorum</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬çœ‹åˆ°, å®ƒåªéœ€è¦ç¡®è®¤æˆ Phase2 çš„åŠŸåº”ç­”æ•°é‡è¾¾åˆ°quorumå°±å¯ä»¥äº†.
å¦å¤–åŒæ ·å®ƒä¹Ÿæœ‰è´£ä»»åœ¨ Phase2 å¤±è´¥æ—¶è¿”å›çœ‹åˆ°çš„æ›´å¤§çš„ballot number,
å› ä¸ºåœ¨ Phase1 å’Œ Phase2 ä¹‹é—´å¯èƒ½æœ‰å…¶ä»– Proposer ä½¿ç”¨æ›´å¤§çš„ballot numberæ‰“æ–­äº†å½“å‰Proposerçš„æ‰§è¡Œ,
å°±åƒ[slide-33] çš„å†²çªè§£å†³çš„ä¾‹å­ä¸­æè¿°çš„é‚£æ ·. åé¢è®².</p>

<h2 id="å®Œæ•´çš„paxosé€»è¾‘">å®Œæ•´çš„paxosé€»è¾‘</h2>

<p>å®Œæ•´çš„ paxos ç”± Proposer è´Ÿè´£, åŒ…æ‹¬: å¦‚ä½•é€‰æ‹©ä¸€ä¸ªå€¼, ä½¿å¾—ä¸€è‡´æ€§å¾—ä»¥ä¿è¯.
å¦‚ [slide-29] ä¸­æè¿°çš„:</p>
<blockquote>
  <p>Proposer Xæ”¶åˆ°å¤šæ•°(quorum)ä¸ªåº”ç­”, å°±è®¤ä¸ºæ˜¯å¯ä»¥ç»§ç»­è¿è¡Œçš„.å¦‚æœæ²¡æœ‰è”ç³»åˆ°å¤šäºåŠæ•°çš„acceptor, æ•´ä¸ªç³»ç»Ÿå°±hangä½äº†, è¿™ä¹Ÿæ˜¯paxoså£°ç§°çš„åªèƒ½è¿è¡Œå°‘äºåŠæ•°çš„èŠ‚ç‚¹å¤±æ•ˆ.
è¿™æ—¶Proposeré¢ä¸´2ç§æƒ…å†µ:</p>

  <p>æ‰€æœ‰åº”ç­”ä¸­éƒ½æ²¡æœ‰ä»»ä½•éç©ºçš„v, è¿™è¡¨ç¤ºç³»ç»Ÿä¹‹å‰æ˜¯å¹²å‡€çš„, æ²¡æœ‰ä»»ä½•å€¼å·²ç»è¢«å…¶ä»–paxoså®¢æˆ·ç«¯å®Œæˆäº†å†™å…¥(å› ä¸ºä¸€ä¸ªå¤šæ•°æ´¾è¯»ä¸€å®šä¼šçœ‹åˆ°ä¸€ä¸ªå¤šæ•°æ´¾å†™çš„ç»“æœ). è¿™æ—¶Proposer Xç»§ç»­å°†å®ƒè¦å†™çš„å€¼åœ¨phase-2ä¸­çœŸæ­£å†™å…¥åˆ°å¤šäºåŠæ•°çš„Acceptorä¸­.</p>

  <p>å¦‚æœæ”¶åˆ°äº†æŸä¸ªåº”ç­”åŒ…å«è¢«å†™å…¥çš„vå’Œvrnd, è¿™æ—¶, Proposer X å¿…é¡»å‡è®¾æœ‰å…¶ä»–å®¢æˆ·ç«¯(Proposer) æ­£åœ¨è¿è¡Œ, è™½ç„¶Xä¸çŸ¥é“å¯¹æ–¹æ˜¯å¦å·²ç»æˆåŠŸç»“æŸ, ä½†ä»»ä½•å·²ç»å†™å…¥çš„å€¼éƒ½ä¸èƒ½è¢«ä¿®æ”¹!, æ‰€ä»¥Xå¿…é¡»ä¿æŒåŸæœ‰çš„å€¼. äºæ˜¯Xå°†çœ‹åˆ°çš„æœ€å¤§vrndå¯¹åº”çš„vä½œä¸ºXçš„phase-2å°†è¦å†™å…¥çš„å€¼.</p>

  <p>è¿™æ—¶å®é™…ä¸Šå¯ä»¥è®¤ä¸ºXæ‰§è¡Œäº†ä¸€æ¬¡(ä¸çŸ¥æ˜¯å¦å·²ç»ä¸­æ–­çš„)å…¶ä»–å®¢æˆ·ç«¯(Proposer)çš„ä¿®å¤.</p>
</blockquote>

<p><img src="/post-res/paxos/slide-imgs/paxos-29.jpg" alt="img" /></p>

<p>åŸºäº Acceptor çš„æœåŠ¡ç«¯å’Œ Proposer 2ä¸ª Phase çš„å®ç°,
æœ€åæŠŠè¿™äº›ç¯èŠ‚ç»„åˆåˆ°ä¸€èµ·ç»„æˆä¸€ä¸ªå®Œæ•´çš„paxos, 
åœ¨æˆ‘ä»¬çš„ä»£ç  [RunPaxos] è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆè¿™äº›äº‹æƒ…:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Proposer</span><span class="p">)</span> <span class="n">RunPaxos</span><span class="p">(</span>
    <span class="n">acceptorIds</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span>
    <span class="n">val</span> <span class="o">*</span><span class="n">Value</span><span class="p">)</span> <span class="o">*</span><span class="n">Value</span> <span class="p">{</span>

  <span class="n">quorum</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">acceptorIds</span><span class="p">)</span><span class="o">/</span><span class="m">2</span> <span class="o">+</span> <span class="m">1</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Val</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">maxVotedVal</span><span class="p">,</span> <span class="n">higherBal</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Phase1</span><span class="p">(</span>
        <span class="n">acceptorIds</span><span class="p">,</span> <span class="n">quorum</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">p</span><span class="o">.</span><span class="n">Bal</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">higherBal</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="m">1</span>
      <span class="k">continue</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">maxVotedVal</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">p</span><span class="o">.</span><span class="n">Val</span> <span class="o">=</span> <span class="n">maxVotedVal</span>
    <span class="p">}</span>

    <span class="c">// val == nil æ˜¯ä¸€ä¸ªè¯»æ“ä½œ,</span>
    <span class="c">// æ²¡æœ‰è¯»åˆ°votedå€¼ä¸éœ€è¦Phase2</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">Val</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">nil</span>
    <span class="p">}</span>

    <span class="n">higherBal</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Phase2</span><span class="p">(</span>
        <span class="n">acceptorIds</span><span class="p">,</span> <span class="n">quorum</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">p</span><span class="o">.</span><span class="n">Bal</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">higherBal</span><span class="o">.</span><span class="n">N</span> <span class="o">+</span> <span class="m">1</span>
      <span class="k">continue</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">Val</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç å®Œæˆäº†å‡ ä»¶äº‹: è¿è¡Œ Phase1, æœ‰votedçš„å€¼å°±é€‰å®ƒ, æ²¡æœ‰å°±é€‰è‡ªå·±è¦å†™çš„å€¼<code class="highlighter-rouge">val</code>,
ç„¶åè¿è¡Œ Phase2.</p>

<p>å°±åƒ Phase1 Phase2 ä¸­æè¿°çš„ä¸€æ ·, ä»»ä½•ä¸€ä¸ªé˜¶æ®µ, å¦‚æœæ²¡è¾¾åˆ°quorum, å°±éœ€è¦æå‡é‡åˆ°çš„æ›´å¤§çš„ballot number,
é‡è¯•å»è§£å†³é‡åˆ°çš„ballot numberå†²çª.</p>

<p>è¿™ä¸ªå‡½æ•°æ¥å—2ä¸ªå‚æ•°:</p>
<ul>
  <li>æ‰€æœ‰Acceptorçš„åˆ—è¡¨(ç”¨ä¸€ä¸ªæ•´æ•°çš„idè¡¨ç¤ºä¸€ä¸ªAcceptor),</li>
  <li>ä»¥åŠè¦æäº¤çš„å€¼.</li>
</ul>

<p>å…¶ä¸­, æŒ‰ç…§paxosçš„æè¿°, è¿™ä¸ªå€¼<code class="highlighter-rouge">val</code><strong>ä¸ä¸€å®šèƒ½æäº¤</strong>:
å¦‚æœpaxosåœ¨ Phase1 å®Œæˆåçœ‹åˆ°äº†å…¶ä»–å·²ç»æ¥å—çš„å€¼(voted value), é‚£å°±è¦é€‰æ‹©å·²æ¥æ”¶çš„å€¼, æ”¾å¼ƒ<code class="highlighter-rouge">val</code>.
é‡åˆ°è¿™ç§æƒ…å†µ, åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­, ä¾‹å¦‚è¦å†™å…¥key=foo, ver=3çš„å€¼ä¸ºbar,
å¦‚æœæ²¡èƒ½é€‰æ‹©bar, å°±è¦é€‰æ‹©ä¸‹ä¸€ä¸ªç‰ˆæœ¬key=foo, ver=4å†å°è¯•å†™å…¥.</p>

<p>è¿™æ ·ä¸æ–­çš„é‡è¯•å¾ªç¯, å†™æ“ä½œæœ€ç»ˆéƒ½èƒ½æˆåŠŸå†™å…¥ä¸€ä¸ªå€¼(ä¸€ä¸ªkeyçš„ä¸€ä¸ªç‰ˆæœ¬çš„å€¼).</p>

<h1 id="å®ç°è¯»æ“ä½œ">å®ç°è¯»æ“ä½œ</h1>

<p>åœ¨æˆ‘ä»¬è¿™ä¸ªNB(naive and bsice)çš„ç³»ç»Ÿä¸­, è¯»å’Œå†™ä¸€æ ·éƒ½è¦é€šè¿‡ä¸€æ¬¡paxosç®—æ³•æ¥å®Œæˆ.
å› ä¸ºå†™å…¥è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡paxosæ‰§è¡Œ,
è€Œpaxosåªä¿è¯åœ¨ä¸€ä¸ªquorumä¸­å†™å…¥ç¡®å®šçš„å€¼, ä¸ä¿è¯æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ªå€¼.
å› æ­¤ä¸€æ¬¡è¯»æ“ä½œå¦‚æœè¦è¯»åˆ°æœ€åå†™å…¥çš„å€¼,
è‡³å°‘è¦è¿›è¡Œä¸€æ¬¡<strong>å¤šæ•°æ´¾è¯»</strong>.</p>

<p>ä½†å¤šæ•°æ´¾è¯»è¿˜ä¸å¤Ÿ: å®ƒå¯èƒ½è¯»åˆ°ä¸€ä¸ªæœªå®Œæˆçš„paxoså†™å…¥, å¦‚ [slide-11] ä¸­æè¿°çš„è„è¯»é—®é¢˜,
è¯»å–åˆ°çš„æœ€å¤§VBalçš„å€¼, å¯èƒ½ä¸æ˜¯ç¡®å®šçš„å€¼(å†™å…¥åˆ°å¤šæ•°æ´¾).</p>

<p>ä¾‹å¦‚ä¸‹é¢çš„çŠ¶æ€:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Val=foo    Val=bar    ?
VBal=3     VBal=2     ?
-------    -------    --
A0         A1         A2
</code></pre></div></div>
<p>å¦‚æœProposerè¯•å›¾è¯», åœ¨ Phase1 è”ç³»åˆ°A0 A1è¿™2ä¸ªAcceptor,
é‚£ä¹ˆfooå’Œbarè¿™2ä¸ªå€¼å“ªä¸ªæ˜¯ç¡®å®šä¸‹æ¥çš„, è¦å–å†³äºA2çš„çŠ¶æ€.
æ‰€ä»¥è¿™æ—¶è¦å†æŠŠæœ€å¤§<code class="highlighter-rouge">VBal</code>çš„å€¼è·‘å®Œä¸€æ¬¡ Phase2, è®©å®ƒè¢«ç¡®å®šä¸‹æ¥,
ç„¶åæ‰èƒ½æŠŠç»“æœè¿”å›ç»™ä¸Šå±‚(å¦åˆ™å¦ä¸€ä¸ªProposerå¯èƒ½è”ç³»åˆ°A1 å’Œ A2, ç„¶åè®¤ä¸ºVal=baræ˜¯è¢«ç¡®å®šçš„å€¼).</p>

<p>å½“ç„¶å¦‚æœ Proposer åœ¨è¯»å–æµç¨‹çš„ Phase1 æˆåŠŸåæ²¡æœ‰çœ‹åˆ°ä»»ä½•å·²ç»votedçš„å€¼(ä¾‹å¦‚æ²¡æœ‰çœ‹åˆ°fooæˆ–bar),
å°±ä¸ç”¨è·‘ Phase2 äº†.</p>

<p>æ‰€ä»¥åœ¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­, è¯»æ“ä½œä¹Ÿæ˜¯ä¸€æ¬¡ [RunPaxos] å‡½æ•°çš„è°ƒç”¨, é™¤äº†å®ƒå¹¶ä¸proposeä»»ä½•æ–°çš„å€¼,
ä¸ºäº†æ”¯æŒè¯»æ“ä½œ, æ‰€ä»¥åœ¨ä¸Šé¢çš„ä»£ç ä¸­ Phase2 ä¹‹å‰åŠ å…¥ä¸€ä¸ªåˆ¤æ–­,
<strong>å¦‚æœä¼ å…¥çš„valå’Œå·²votedçš„å€¼éƒ½ä¸ºç©º, åˆ™ç›´æ¥è¿”å›</strong>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">Val</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>[Example_setAndGetByKeyVer] è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨paxoså®ç°ä¸€ä¸ªkvå­˜å‚¨,
å®ç°è¯»å’Œå†™çš„ä»£ç å¤§æ¦‚è¿™æ ·:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prop</span> <span class="o">:=</span> <span class="n">Proposer</span><span class="p">{</span>
  <span class="n">Id</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">PaxosInstanceId</span><span class="p">{</span>
    <span class="n">Key</span><span class="o">:</span> <span class="s">"foo"</span><span class="p">,</span>
    <span class="n">Ver</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">Bal</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">BallotNum</span><span class="p">{</span><span class="n">N</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">ProposerId</span><span class="o">:</span> <span class="m">2</span><span class="p">},</span>
<span class="p">}</span>

<span class="c">// å†™:</span>
<span class="n">v</span> <span class="o">:=</span> <span class="n">prop</span><span class="o">.</span><span class="n">RunPaxos</span><span class="p">(</span><span class="n">acceptorIds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Value</span><span class="p">{</span><span class="n">Vi64</span><span class="o">:</span> <span class="m">5</span><span class="p">})</span>

<span class="c">// è¯»:</span>
<span class="n">v</span> <span class="o">:=</span> <span class="n">prop</span><span class="o">.</span><span class="n">RunPaxos</span><span class="p">(</span><span class="n">acceptorIds</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
</code></pre></div></div>

<p>åˆ°ç°åœ¨ä¸ºæ­¢, æœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„åŠŸèƒ½éƒ½å®ç°å®Œäº†, å®Œæ•´å®ç°åœ¨ [impl.go] ä¸­.</p>

<p>æ¥ç€æˆ‘ä»¬ç”¨æµ‹è¯•ç”¨ä¾‹å®ç°1ä¸‹ [paxosçš„ç›´è§‚è§£é‡Š] ä¸­åˆ—å‡ºçš„2ä¸ªä¾‹å­,
ä»ä»£ç çœ‹poxosçš„è¿è¡Œ:</p>

<h1 id="æ–‡ä¸­ä¾‹å­">æ–‡ä¸­ä¾‹å­</h1>

<p>ç¬¬1ä¸ªä¾‹å­æ˜¯ paxos æ— å†²çªçš„è¿è¡Œ [slide-32]:</p>

<p><img src="/post-res/paxos/slide-imgs/paxos-32.jpg" alt="" /></p>

<p>æŠŠå®ƒå†™æˆtest case, ç¡®è®¤æ•™ç¨‹ä¸­æ¯æ­¥æ“ä½œä¹‹åçš„ç»“æœéƒ½å¦‚é¢„æœŸ
[TestCase1SingleProposer]:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestCase1SingleProposer</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ta</span> <span class="o">:=</span> <span class="n">require</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

  <span class="n">acceptorIds</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">}</span>
  <span class="n">quorum</span> <span class="o">:=</span> <span class="m">2</span>

  <span class="c">// å¯åŠ¨3ä¸ªAcceptorçš„æœåŠ¡</span>
  <span class="n">servers</span> <span class="o">:=</span> <span class="n">ServeAcceptors</span><span class="p">(</span><span class="n">acceptorIds</span><span class="p">)</span>
  <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">servers</span> <span class="p">{</span>
      <span class="n">s</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}()</span>

  <span class="c">// ç”¨è¦æ›´æ–°çš„keyå’Œversionå®šä¹‰paxos å®ä¾‹çš„id</span>
  <span class="n">paxosId</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">PaxosInstanceId</span><span class="p">{</span>
    <span class="n">Key</span><span class="o">:</span> <span class="s">"i"</span><span class="p">,</span>
    <span class="n">Ver</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">var</span> <span class="n">val</span> <span class="kt">int64</span> <span class="o">=</span> <span class="m">10</span>

  <span class="c">// å®šä¹‰Proposer, éšä¾¿é€‰ä¸ªProposer id 10.</span>
  <span class="k">var</span> <span class="n">pidx</span> <span class="kt">int64</span> <span class="o">=</span> <span class="m">10</span>
  <span class="n">px</span> <span class="o">:=</span> <span class="n">Proposer</span><span class="p">{</span>
    <span class="n">Id</span><span class="o">:</span>  <span class="n">paxosId</span><span class="p">,</span>
    <span class="n">Bal</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">BallotNum</span><span class="p">{</span><span class="n">N</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">ProposerId</span><span class="o">:</span> <span class="n">pidx</span><span class="p">},</span>
  <span class="p">}</span>

  <span class="c">// ç”¨å·¦è¾¹2ä¸ªAcceptorè¿è¡ŒPhase1,</span>
  <span class="c">// æˆåŠŸ, æ²¡æœ‰çœ‹åˆ°å…¶ä»–çš„ballot number</span>
  <span class="n">latestVal</span><span class="p">,</span> <span class="n">higherBal</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">px</span><span class="o">.</span><span class="n">Phase1</span><span class="p">(</span>
      <span class="p">[]</span><span class="kt">int64</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">},</span> <span class="n">quorum</span><span class="p">)</span>

  <span class="n">ta</span><span class="o">.</span><span class="n">Nil</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"constitued a quorum"</span><span class="p">)</span>
  <span class="n">ta</span><span class="o">.</span><span class="n">Nil</span><span class="p">(</span><span class="n">higherBal</span><span class="p">,</span> <span class="s">"no other proposer is seen"</span><span class="p">)</span>
  <span class="n">ta</span><span class="o">.</span><span class="n">Nil</span><span class="p">(</span><span class="n">latestVal</span><span class="p">,</span> <span class="s">"no voted value"</span><span class="p">)</span>

  <span class="c">// Phase1æˆåŠŸå, å› ä¸ºæ²¡æœ‰çœ‹åˆ°å…¶ä»–votedçš„å€¼,</span>
  <span class="c">// Proposeré€‰æ‹©å®ƒè‡ªå·±çš„å€¼è¿›è¡Œåé¢çš„Phase2</span>
  <span class="n">px</span><span class="o">.</span><span class="n">Val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Value</span><span class="p">{</span><span class="n">Vi64</span><span class="o">:</span> <span class="n">val</span><span class="p">}</span>

  <span class="c">// Phase 2</span>
  <span class="n">higherBal</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">Phase2</span><span class="p">(</span>
      <span class="p">[]</span><span class="kt">int64</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">},</span> <span class="n">quorum</span><span class="p">)</span>

  <span class="n">ta</span><span class="o">.</span><span class="n">Nil</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"constitued a quorum"</span><span class="p">)</span>
  <span class="n">ta</span><span class="o">.</span><span class="n">Nil</span><span class="p">(</span><span class="n">higherBal</span><span class="p">,</span> <span class="s">"no other proposer is seen"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç¬¬2ä¸ªä¾‹å­å¯¹åº”2ä¸ªProposeré‡åˆ°å†²çªå¹¶è§£å†³å†²çªçš„ä¾‹å­, ç•¥é•¿ä¸è´´åœ¨æ–‡ä¸­äº†,
ä»£ç å¯ä»¥åœ¨ [TestCase2DoubleProposer] çœ‹åˆ°</p>

<p><img src="/post-res/paxos/slide-imgs/paxos-33.jpg" alt="" /></p>

<h1 id="ä¸‹ä¸€æ­¥">ä¸‹ä¸€æ­¥</h1>

<p>æˆ‘ä»¬å®ç°äº†æŒ‡å®škey, verçš„å­˜å‚¨ç³»ç»Ÿ, ä½†ç›¸æ¯”çœŸæ­£ç”Ÿäº§å¯ç”¨çš„kvå­˜å‚¨, è¿˜ç¼ºå°‘ä¸€äº›ä¸œè¥¿:</p>

<ul>
  <li>
    <p>å†™æ“ä½œä¸€èˆ¬éƒ½ä¸éœ€è¦ç”¨æˆ·æŒ‡å®šver, æ‰€ä»¥è¿˜éœ€è¦å®ç°<strong>å¯¹æŒ‡å®škeyæŸ¥æ‰¾æœ€å¤§verçš„åŠŸèƒ½</strong>.
è¿™äº›è·Ÿpaxoså…³ç³»ä¸å¤§, ç°åœ¨è¿™ä¸ªå®ç°ä¸­å°±çœå»äº†è¿™äº›é€»è¾‘. ä»¥åå†è®². ğŸ¤”</p>
  </li>
  <li>
    <p>å…¶æ¬¡ä¸ºäº†è®©è¯»æ“ä½œä¸éœ€è¦æŒ‡å®šver, è¿˜éœ€è¦ä¸€ä¸ª<strong>snapshot</strong>åŠŸèƒ½, ä¹Ÿå°±æ˜¯ä¿å­˜ä¸€ä¸ªkey-valueçš„map,
è¿™ä¸ªmapä¸­åªéœ€è¦è®°å½•æ¯ä¸ªkeyæœ€æ–°çš„valueå€¼(ä»¥åŠverç­‰).
æœ‰äº†è¿™ä¸ªmapä¹‹å, å·²ç»ç¡®è®¤çš„å€¼å¯¹åº”çš„versionå°±å¯ä»¥åˆ æ‰äº†. ä¹Ÿå°±æ˜¯è¯´Versions
ç»“æ„åªä½œä¸ºæ¯ä¸ªkeyçš„<strong>ä¿®æ”¹æ—¥å¿—</strong>å­˜åœ¨, ç”¨äºå­˜å‚¨æ¯æ¬¡ä¿®æ”¹å¯¹åº”çš„paxoså®ä¾‹.</p>
  </li>
  <li>
    <p>snapshotåŠŸèƒ½è¿˜ä¼šå¼•å…¥åº”å¦å¤–ä¸€ä¸ªéœ€æ±‚, å°±æ˜¯[paxos made simple] ä¸­çš„ learn çš„è¡Œä¸º,
  å¯¹åº”Phase3, æœ¬æ–‡ä¸­æè¿°çš„è¿™ä¸ªå­˜å‚¨ä¸­, åªæœ‰ProposerçŸ¥é“æŸä¸ªkey-verè¾¾åˆ°å¤šæ•°æ´¾,
  Acceptorè¿˜ä¸çŸ¥é“, (æ‰€ä»¥è¯»çš„æ—¶å€™è¿˜è¦èµ°ä¸€épaxos).
  åœ¨è®ºæ–‡ä¸­çš„æè¿°æ˜¯Acceptoræ¥å—ä¸€ä¸ªå€¼æ—¶(vote), ä¹Ÿè¦æŠŠè¿™ä¸ªäº‹æƒ…é€šçŸ¥å…¶ä»– Learnerè§’è‰²,
  æˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªAcceptorä¹Ÿè®¾å®šæˆLearner: <strong>Acceptor voteä¸€ä¸ªå€¼æ—¶é™¤äº†åº”ç­”Proposer,
  ä¹Ÿå¹¿æ’­è¿™ä¸ªäº‹ä»¶ç»™å…¶ä»–Acceptor</strong>, è¿™æ ·æ¯ä¸ªAcceptorä¹Ÿå°±å¯ä»¥çŸ¥é“å“ªä¸ªå€¼æ˜¯è¾¾åˆ°quorumäº†(safe), å¯ä»¥ç›´æ¥è¢«è¯»å–.</p>

    <p>ä½†åœ¨å®é™…å®ç°æ—¶, è¿™ç§æ–¹æ³•äº§ç”Ÿçš„æ¶ˆæ¯ä¼šè¾¾åˆ° nÂ² çº§åˆ«çš„æ•°é‡.
  æ‰€ä»¥ä¸€èˆ¬åšæ³•æ˜¯è®©Proposeråšè¿™ä»¶äº‹: å½“Proposeræ”¶åˆ°ä¸€ä¸ªquorumçš„Phase2åº”ç­”å,
  å†å¹¿æ’­ä¸€æ¡æ¶ˆæ¯å‘Šè¯‰æ‰€æœ‰çš„Acceptor: è¿™ä¸ªpaxoså®ä¾‹å·²ç»safeäº†,
  è¿™ä¸ªæ¶ˆæ¯åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­éƒ½å°±ç§°ä½œ<strong>Commit</strong>.</p>
  </li>
</ul>

<p>ä»¥ä¸Šè¿™3å—å†…å®¹, åç»­æ’­å‡º, ä¸‹ä¸ªç‰ˆæœ¬çš„å®ç°å°†ä½¿ç”¨ç»å…¸çš„log åŠ 
snapshotçš„æ–¹å¼å­˜å‚¨æ•°æ®.</p>

<p>å„ä½æœ‹å‹å¯¹å“ªäº›æ–¹é¢æ„Ÿå…´è¶£, æ¬¢è¿å‚¬æ›´ ğŸ¤”â€¦</p>

<hr />

<p>æœ¬æ–‡ç”¨åˆ°çš„ä»£ç åœ¨ paxoskv é¡¹ç›®çš„ naive åˆ†æ”¯ä¸Š:
[https://github.com/openacid/paxoskv/tree/naive]</p>

<p>å¦‚æœ‰ä»€ä¹ˆæœ¬æ–‡é—æ¼çš„åœ°æ–¹, æˆ–æœ‰ä»»ä½•å¥½æƒ³æ³•, æ¬¢è¿éšæ—¶äº¤æµè®¨è®º,</p>

<p>æœ¬æ–‡ç›¸å…³é—®é¢˜å¯ä»¥åœ¨ paxoskv è¿™ä¸ªé¡¹ç›®ä¸Šæ åŸºhub [issue].</p>


        <p style="font-size: 0.7rem; font-weight: bolder;">
æœ¬æ–‡é“¾æ¥: [https://blog.openacid.com/algo/paxoskv/]


</p>
<ul class="page-links" style="display:block;">




    
        <li style="font-size:0.7em">
        [paxos made simple]: http://lamport.azurewebsites.net/pubs/pubs.html#paxos-simple
        </li>
    

    
        <li style="font-size:0.7em">
        [Leslie Lamport]: http://www.lamport.org/
        </li>
    

    
        <li style="font-size:0.7em">
        [protobuf]: https://developers.google.com/protocol-buffers
        </li>
    

    
        <li style="font-size:0.7em">
        [install-protoc]: https://grpc.io/docs/protoc-installation/
        </li>
    

    
        <li style="font-size:0.7em">
        [grpc]: https://grpc.io/
        </li>
    

    
        <li style="font-size:0.7em">
        [paxosçš„ç›´è§‚è§£é‡Š]: https://blog.openacid.com/algo/paxos
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-11]: https://blog.openacid.com/algo/paxos/#slide-11
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-27]: https://blog.openacid.com/algo/paxos/#slide-27
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-28]: https://blog.openacid.com/algo/paxos/#slide-28
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-29]: https://blog.openacid.com/algo/paxos/#slide-29
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-30]: https://blog.openacid.com/algo/paxos/#slide-30
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-31]: https://blog.openacid.com/algo/paxos/#slide-31
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-32]: https://blog.openacid.com/algo/paxos/#slide-32
        </li>
    

    
        <li style="font-size:0.7em">
        [slide-33]: https://blog.openacid.com/algo/paxos/#slide-33
        </li>
    

    
        <li style="font-size:0.7em">
        [issue]: https://github.com/openacid/paxoskv/issues/new/choose
        </li>
    

    
        <li style="font-size:0.7em">
        [https://github.com/openacid/paxoskv/tree/naive]: https://github.com/openacid/paxoskv/tree/naive
        </li>
    

    
        <li style="font-size:0.7em">
        [paxoskv]: https://github.com/openacid/paxoskv/tree/naive
        </li>
    

    
        <li style="font-size:0.7em">
        [paxoskv.proto]: https://github.com/openacid/paxoskv/blob/naive/proto/paxoskv.proto
        </li>
    

    
        <li style="font-size:0.7em">
        [PaxosKV]: https://github.com/openacid/paxoskv/blob/naive/proto/paxoskv.proto#L16
        </li>
    

    
        <li style="font-size:0.7em">
        [paxoskv.pb.go]: https://github.com/openacid/paxoskv/blob/naive/paxoskv/paxoskv.pb.go
        </li>
    

    
        <li style="font-size:0.7em">
        [impl.go]: https://github.com/openacid/paxoskv/blob/naive/paxoskv/impl.go
        </li>
    

    
        <li style="font-size:0.7em">
        [RunPaxos]: https://github.com/openacid/paxoskv/blob/naive/paxoskv/impl.go#L46
        </li>
    

    
        <li style="font-size:0.7em">
        [TestCase1SingleProposer]: https://github.com/openacid/paxoskv/blob/naive/paxoskv/paxos_slides_case_test.go#L11
        </li>
    

    
        <li style="font-size:0.7em">
        [TestCase2DoubleProposer]: https://github.com/openacid/paxoskv/blob/naive/paxoskv/paxos_slides_case_test.go#L57
        </li>
    

    
        <li style="font-size:0.7em">
        [Example_setAndGetByKeyVer]: https://github.com/openacid/paxoskv/blob/naive/paxoskv/example_set_get_test.go
        </li>
    

</ul>
<p>
<img src="/assets/images/qrcode-hori.jpg" alt="openacid">
</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> æ ‡ç­¾: </strong>
    <span itemprop="keywords">
    
      
      
      [distributed]<span class="sep">, </span>
    
      
      
      [kv]<span class="sep">, </span>
    
      
      
      [paxos]<span class="sep">, </span>
    
      
      
      [replication]<span class="sep">, </span>
    
      
      
      [åˆ†å¸ƒå¼]<span class="sep">, </span>
    
      
      
      [å­˜å‚¨]
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> åˆ†ç±»: </strong>
    <span itemprop="keywords">
    
      
      
      [algo]
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> æ›´æ–°æ—¶é—´:</strong> <time datetime="2020-10-28T00:00:00+08:00">October 28, 2020</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">åˆ†äº«</h4>
  

  [<i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span>]

  [<i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span>]

  [<i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span>]
</section>


      
  <nav class="pagination">
    
      [ä¸Šä¸€é¡µ]
    
    
      [ä¸‹ä¸€é¡µ]
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">ç•™ä¸‹è¯„è®º</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">çŒœæ‚¨è¿˜å–œæ¬¢</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        [ååˆ†å¸ƒå¼æ—¶ä»£: å¤šæ•°æ´¾è¯»å†™çš„â€™å°‘æ•°æ´¾â€™å®ç°
]
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          19 åˆ†é’Ÿé˜…è¯»
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">é€šè¿‡å‡å°‘å¤šæ•°æ´¾è¯»å†™ä¸­å‚ä¸è€…çš„æ•°é‡, å¯ä»¥å®ç°åˆ†å¸ƒå¼ç³»ç»ŸæŸäº›ç‰¹å®šåœºæ™¯çš„ä¼˜åŒ–, ä»¥åŠä»‹ç»è¿™äº›ä¼˜åŒ–å¯¹ç³»ç»Ÿå¯ç”¨æ€§äº§ç”Ÿçš„å½±å“, æ ¹æ®ä»€ä¹ˆæ ‡å‡†æ¥é€‰æ‹©å’Œè°ƒæ•´è¿™äº›å‚æ•°.
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        [å¯é åˆ†å¸ƒå¼ç³»ç»Ÿ-paxosçš„ç›´è§‚è§£é‡Š
]
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 åˆ†é’Ÿé˜…è¯»
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">æ²¡æœ‰paxosçš„ä¸€å †æœºå™¨, åªèƒ½å«åšåˆ†å¸ƒå¼; æœ‰paxosååŒæ‰å«åˆ†å¸ƒå¼ç³»ç»Ÿ. å’±å¾—æŠŠpaxosèŠå¼€äº†èŠé€äº†
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        [å‡ ä¸ªæ— ç†å–é—¹çš„codingå¿ƒå¾—
]
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 åˆ†é’Ÿé˜…è¯»
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">æ¥è‡ªä¸€ä¸ªè«å¾—æ„Ÿæƒ…çš„codingä¸‡å¹´æˆ·
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        [Erasure-Code-æ“¦é™¤ç -3-æé™ç¯‡
]
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          24 åˆ†é’Ÿé˜…è¯»
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚EC(ç‰¹è¾£è„¯å£æ°”): ä»æŒ‡ä»¤é›†å’Œç®—æ³•ä¸¤ä¸ªæ–¹å‘å¯¹æ“¦é™¤ç å®ç°æ·±åº¦ä¼˜åŒ–, ç¡¬æ ¸ä½†ä¸çƒ§è„‘
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      è¾“å…¥æ‚¨è¦æœç´¢çš„å…³é”®è¯...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="è¾“å…¥æ‚¨è¦æœç´¢çš„å…³é”®è¯..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->



<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>å…³æ³¨:</strong></li>
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    <li>[<i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed]</li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 OpenACID-åˆ†å¸ƒå¼ç ”ç©¶å°é™¢. æŠ€æœ¯æ¥è‡ªäº [Jekyll] &amp; [Minimal Mistakes].</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-69976993-2']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://blog.openacid.com/algo/paxoskv/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/algo/paxoskv"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://openacid.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the [comments powered by Disqus.]</noscript>


  





  <style> .header-link { display: none !important; } </style> </body >
</html>
